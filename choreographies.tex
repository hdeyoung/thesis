\chapter{A formula-as-process interpretation of ordered rewriting}\label{ch:formula-as-process}\label{ch:choreographies}


% In \cref{ch:string-rewriting}, we saw that string rewriting can be used to specify the dynamics of concurrent systems, but that those specifications are quite abstract.
% Even the operational semantics is left completely abstract: permitted rewritings just \emph{happen}, as if a central, meta-level actor schedules and otherwise coordinates rewriting.

In \cref{ch:string-rewriting}, we saw that string rewriting can be used to specify the dynamics of concurrent systems, but that those specifications are quite abstract.\fixnote{Move toward programing, away from modeling}
Even the operational semantics is left completely abstract:
String rewriting is a state-transformation model of concurrency, with axioms $w \reduces w'$
% are strictly global in their phrasing, stating
stating merely that a substring of the form $w$ may be replaced, en masse, with $w'$.
Nothing is said about how this replacement is achieved -- permitted rewritings just \emph{happen}, as if a central, meta-level actor schedules and otherwise coordinates rewriting, with substrings and their constituent symbols as mere passive accessories.

In the previous \lcnamecref{ch:ordered-rewriting}, we presented a different rewriting framework, derived from the (focused) ordered sequent calculus and closely related to the \citeauthor{Lambek:AMM58} calculus\autocite{Lambek:AMM58}.
Ordered rewriting, in both its unfocused and focused variants, continues to leave the operational semantics abstract, as if a central, meta-level actor governs rewriting.

The string rewriting and (strongly) focused ordered rewriting frameworks are both expressive enough to exhibit concurrency% behaviors%
\footnote{See \cref{sec:string-rewriting:concurrency,sec:ordered-rewriting:concurrency}.}%
, and the ordered rewriting framework's logical foundations make it a proof-construction approach to concurrency.
But without a concrete operational semantics neither framework is yet suitable for\fixnote{suited to} our ultimate goal -- 
% a method for extracting local, message-passing implementations from concurrent specifications.
to establish the relationship between proof-construction and proof-reduction descriptions of concurrency.
%  operating at such a high level of abstraction that neither framework's operational semantics can be cleanly implemented\fixnote{word choice?} in terms of local, message-passing communication.

This \lcnamecref{ch:formula-as-process} takes three significant steps toward this end, using the focused ordered rewriting framework of the previous \lcnamecref{ch:ordered-rewriting} as a stepping stone.
\begin{itemize}[listparindent=\parindent, itemsep=\dimexpr\itemsep+\parsep\relax, parsep=0pt]
\item
  In \cref{sec:formula-as-process:interpretation}, we refine the focused ordered rewriting framework of the previous \lcnamecref{ch:ordered-rewriting} into one that can be given a \emph{formula-as-process} interpretation%
  \footnote{This interpretation is \emph{very} closely related to the process-as-formula view of concurrency put forth by \textcites{Miller:ELP92}{Cervesato+Scedrov:IC09}.
    For us, however, the logical aspects, and propositions in particular, are conceptually prior to any notion of process, hence our use of the reversed \emph{formula-as-process} terminology.}
  in which rewriting faithfully represents message-passing communication among concurrent processes that are arranged in a linear topology.
  In this way, the formula-as-process interpretation assigns a concrete operational semantics to ordered rewriting, nudging it away from a state-transformation model of concurrency and toward a process-based model.

  Specifically, we show that atomic propositions may be interpreted as messages;
  the other, non-atomic propositions, as processes;
  contexts, as configurations comprised of those messages and processes;
  and
  rewriting, as mes\-sage-passing communication among a configuration's con\-stit\-u\-ent processes.
  %
  Perhaps surprisingly, only three small tweaks to the structure of propositions are needed to make this formula-as-process interpretation viable.


  % In \cref{sec:formula-as-process:interpretation}, we refine the focused ordered rewriting framework of the previous \lcnamecref{ch:ordered-rewriting} into one that can be cleanly given a \emph{formula-as-process} interpretation%
  % \footnote{This interpretation is \emph{very} closely related to the process-as-formula view of concurrency put forth by \textcites{Miller:??}{Cervesato+Scedrov:IC09}.
  %   For us, however, the logical aspects, and propositions in particular, are conceptually prior to any notion of process, hence our use of the reversed \emph{formula-as-process} terminology.}
  % that assigns to focused ordered rewriting a concrete operational semantics in terms of message-passing communication among concurrent processes.

  % Under this formula-as-process interpretation, atomic propositions may be viewed as messages;
  % (compound)\fixnote{$\top$ and $\one$ aren't exactly compound.} propositions, as processes;
  % contexts, as configurations comprised of those messages and processes;
  % and
  % rewriting, as message-passing communication among a configuration's con\-stit\-u\-ent processes.
  % %
  % Somewhat surprisingly, only three small tweaks to the structure of propositions are needed to make the formula-as-process interpretation viable.

\item
  With this new formula-as-process perspective and its accompanying mes\-sage-passing semantics, (focused) ordered rewriting can be understood in terms of local interactions alone.
  By analogy with the $\pi$-calculus's operational semantics, the existing rewriting relation, $\reduces$, serves as a reduction semantics, but now an equivalent, labeled transition semantics can also be given~\parencref{sec:formula-as-process:transition-semantics}.

  The labeled transition semantics describes how ordered contexts, now understood as process configurations, interact with neighboring contexts.
  It thus goes hand-in-hand with the formula-as-process interpretation in establishing a concrete and local operational semantics for ordered rewriting.

\item
  Having established a formula-as-process refinement of the focused ordered rewriting framework that permits only local, message-passing interactions, we then revisit string rewriting specifications.

  In \cref{sec:formula-as-process:choreographies}, we describe, first informally and then formally, a method for operationalizing, or \emph{choreographing}, string rewriting specifications within the formula-as-process ordered rewriting framework.
  %
  Symbols in the specification's alphabet are uniquely mapped to propositions, thereby casting each symbol in one of two roles -- either a message role or a process role.
  % Each symbol in the specification's alphabet is uniquely mapped to either an atomic or compound\fixnote{terminology?} proposition -- hence casting each symbol in either a message or process role.

  Not all such role assignments give rise to well-formed choreographies, however.
  But, for those that do, the resulting choreography adequately embeds the string rewriting specification:
  % But those well-formed choreographies adequately [...] the string rewriting specification:
  the specification's axioms are in one-to-one correspondence with the choreography's derivable ordered rewritings, as we prove in \cref{cor:formula-as-process:choreography-adequacy}.
  Stated differently, the string rewriting specification and choreography will be (strongly) bisimilar, with the role assignment being a bisimulation that witnesses their bisimilarity.

%   we prove that the role assignment that underlies a well-formed choreography is always a (strong) bisimulation between the string rewriting specification and its choreography within the formula-as-process ordered rewriting framework.

%   By mapping each symbol in a string rewriting specification's alphabet to either an 

%   String rewriting specifications are \emph{choreographed} by mapping each symbol to either an atomic proposition or a recursively defined proposition -- hence casting each symbol in either a message or process role.
%   Not all such role assignments result in meaningful choreographies, however.
%   A meaningful choreography is one in which the string rewriting specification's axioms are in one-to-one correspondence with derivable ordered rewritings of the propositions.
%   In other words, a meaningful choreography is one in which the underlying role assignment is a (strong) bisimulation between 




%   By mapping symbols to propositions, each symbol is uniquely cast in one of two roles -- either a message or a process -- in such a way that the string rewriting specification's axioms are in one-to-one correspondence with derivable ordered rewritings of the propositions.

%   We revisit string rewriting specifications and introduce a notion of \vocab{choreography}.
%   String rewriting specifications are choreographed by mapping each symbol to either an atomic proposition or a recursively defined proposition -- hence casting each symbol in either a message or process role.
%   Not all such role assignments result in meaningful choreographies, however.
%   A meaningful choreography is 

% , so we describe a judgment for evaluating a mapping.
%   We also prove that any mapping that results in a meaningful choreography acts as a (strong) bisimulation between the string rewriting specification and ordered rewriting in the choreography.
\end{itemize}

% At such a high level of abstraction, neither string rewriting specifications nor ordered rewriting [...] 

% In \cref{ch:string-rewriting}, we saw that string rewriting can be used to specify the dynamics of concurrent systems, but that those specifications are quite abstract.
% Even the [...] is left completely abstract: permitted rewritings just \emph{happen}, as if a central, meta-level actor schedules and otherwise coordinates rewriting.
% At this high level of abstraction, string rewriting specifications are not amenable to 

% In the previous \lcnamecref{ch:ordered-rewriting}, we developed a focused ordered rewriting framework, \acs{FOR}, that has more expressive power than string rewriting.\fixnote{Can I really say this?}
% Still, the [...] is left abstract, with a central, meta-level actor governing rewriting.

% Ultimately, however, our goal is a more concrete [...] that can be implemented using local message-passing communication.
% This \lcnamecref{ch:formula-as-process} takes three significant steps in that direction.




% As demonstrated in \cref{ch:string-rewriting,ch:ordered-rewriting}, string rewriting and the more expressive (focused) ordered rewriting are suitable frameworks for describing the dynamics of concurrent systems whose components have a monoidal structure.
% But, as formulated thus far, these rewriting descriptions are only abstract specifications -- they lack the clear notion of local communication and decentralized execution

% String rewriting axioms, $w \reduces w'$, and ordered rewriting steps\fixnote{wc}, $\octx \reduces \octx'$, are strictly global in their phrasing, stating merely that any substate of the form $w$ or $\octx$ may be transformed, \foreigntext{en masse}, into $w'$ or $\octx'$.
% Because nothing at all is said about how this transformation is achieved, the rewritings specified by these frameworks are [...].
% It might as well be assumed that a meta-level actor is responsible for coordinating and conducting the rewriting, with the (sub-)states and their constituent symbols or propositions as mere passive objects.

% As outlined in \cref{ch:introduction}, our eventual goal is to relate these rewriting-based specifications to (session-typed) message-passing concurrent processes.
% With an eye on this goal, the contributions of this \lcnamecref{ch:formula-as-process} push ordered rewriting toward a lower level of abstraction.

% First, in \cref{sec:formula-as-process:interpretation}, we refine the focused ordered rewriting framework of the previous \lcnamecref{ch:ordered-rewriting} into one that can be cleanly given a \emph{formula-as-process} interpretation\autocites{Miller:??}{Cervesato+Scedrov:IC09}.
% Under this interpretation, atomic propositions may be viewed as messages; (compound) propositions, as processes; contexts, as configurations of those processes; and rewriting, as message-passing communication [among the processes in a configuration].\fixnote{fix}
% Somewhat surprisingly, only two small tweaks (and one optional addition) to the structure of propositions are needed to make this formula-as-process interpretation viable.

% Second, with the new perspective that this formula-as-process interpretation supplies, we can now understand ordered rewriting in terms of local interactions.
% \Cref{sec:formula-as-process:interaction} presents a labeled transition semantics for

% \ac{FOR}
% \Ac{FOR}

% Finally, in \cref{sec:formula-as-process:choreographies}, we introduce a notion of \emph{choreography} that relates a string rewriting specification to 

% Another way to view this chapter is that it nudges ordered rewriting away from a state-transformation model of concurrency toward a process-based model.
Even though this \lcnamecref{ch:formula-as-process} introduces a notion of process, it should be noted that computation is still driven by derivability and proof construction, not by proof reduction.
Only in \cref{part:proof-reduction} will we begin to examine a proof-reduction account of concurrency.


% \newthought{In process calculi} like the $\pi$-calculus, a reduction semantics often plays a lesser role than a labeled transition semantics does.
% But here the roles are reversed, with the labeled transition semantics taking a back seat, because of the reduction semantics's clearer connection to rewriting.

% The other contribution of this \lcnamecref{ch:choreographies} is the idea of choreographing string rewriting specifications into this formula-as-process refinement of ordered rewriting.

% This formula-as-process interpretation nudges ordered rewriting away from a state-transformation model of concurrency toward a process-based model.
% Computation is still driven by derivability



% \newthought{As shown in} \cref{ch:string-rewriting}, string rewriting is a suitable framework for describing the dynamics of concurrent systems whose components have a monoidal structure.
% But these string rewriting descriptions are only abstract specifications from a state-transformation perspective -- they lack a clear notion of local, decentralized execution and therefore give only a global characterization of the interactions between components.

% String rewriting axioms $w \reduces w'$ are strictly global in their phrasing, stating merely that any substring of the form $w$ may be replaced, en masse, with $w'$ -- nothing is said about how this replacement is achieved.
% The string rewriting framework therefore implicitly suggests that a meta-level actor is responsible for coordinating and conducting the rewriting, with substrings and their constituent symbols as mere passive accessories\fixnote{word choice?}.

% In this \lcnamecref{ch:choreographies}, our goal is to move toward a lower level of abstraction.


% As an example, recall from \cref{ch:string-rewriting} the string rewriting specification of a system that may transform strings that end with $b$ into the empty string:
% \begin{equation}
%   \infer{a \wc b \reduces b}{}
%   \qquad
%   \infer{b \reduces \emp}{}
% \end{equation}


% Accordingly, we refine the focused ordered rewriting framework of the previous \lcnamecref{ch:ordered-rewriting} into one that can be given a \vocab{formula-as-process} interpretation in which [ordered] rewriting faithfully represents message-passing communication among processes that are arranged in a linear topology.
% Then, in \cref{??}, we describe how a string rewriting specification may be transformed into an ordered rewriting \vocab{choreography}.

% In this \lcnamecref{ch:choreographies}, we refine the focused ordered rewriting framework of the previous \lcnamecref{ch:ordered-rewriting} into one that can be given a \vocab{formula-as-process} interpretation in which rewriting faithfully represents message-passing communication among 

% As argued 

% Then we show how, given a mapping of symbols to either [...], choreographies can be generated from a string rewriting specification.



\section{Refining ordered rewriting: A formula-as-process interpretation}\label{sec:formula-as-process:interpretation}

In this section, we present the formula-as-process interpretation of focused ordered rewriting sketched above.

More specifically,
% under this formula-as-process interpretation,
(positive) atoms, $\p{a}$, may be viewed as messages, and negative propositions, $\n{A}$, as processes that receive and react to those messages.
Ordered contexts, $\np{\octx}$, which consist of negative propositions and (positive) atoms, are then linear-topology run-time configurations of processes and messages.
And positive propositions, $\p{A}$, which reify ordered contexts as propositions, are process expressions that reify configurations.
Lastly, but most importantly, the rewriting relation, $\reduces$, is viewed as a reduction semantics for message-passing communication among the processes in a configuration.%
\begin{margintable}
  \begin{center}
    \begin{tabular}{@{}l@{\enspace\ }>{\itshape}l@{}}
      $\p{\atmL{a}}$ & left-directed message \\
      $\p{\atmR{a}}$ & right-directed message \\
      $\n{A}$ & message-passing process \\
      $\np{\octx}$ & run-time process configuration \\
      $\p{A}$ & configuration reified as an expression
    \end{tabular}
  \end{center}
  \caption{A formula-as-process interpretation of polarized ordered propositions and contexts}\label{fig:choreographies:propctx-table}
\end{margintable}%

Perhaps surprisingly, only three small tweaks to the structure of propositions are needed to make this formula-as-process reading viable.
\begin{itemize}
\item
  The (positive) atoms are now partitioned into two classes, left- and right-directed atoms, to allow us to identify the direction in which a message is flowing.

\item
  The left- and right-handed implications are now restricted to have atomic premises with a complementary direction
  %
  , so that they may then be cleanly interpreted as input processes that receive  individual incoming messages.
%  Instead of the more general $\p{A} \limp \n{B}$ and $\n{B} \pmir \p{A}$, now only implications of the forms $\p{\atmR{a}} \limp \n{B}$ and $\n{B} \pmir \p{\atmL{a}}$ are permitted.
%  These restricted implications can then be cleanly interpreted as input processes that receive a single incoming message.
  % The proposition $\p{\atmR{a}} \limp \n{B}$ is interpreted as a process that inputs 

\item 
  The negative propositions are extended with coinductively defined propositions, $\n{\defp{p}} \defd \n{A}$, that will correspond to recursive processes.
\end{itemize}
Together, the first two of these tweaks serve to provide a modicum of static typing for the otherwise untyped processes, as we will discuss in further detail in \cref{sec:formula-as-process:typing}.

\newthought{Positive atoms}, as mentioned previously, are now partitioned into two classes, left- and right-directed atoms, to allow us to identify the direction in which a message is flowing.
Using a partition, we ensure that each atom has a unique direction that is consistently used across all instances of that atom.

These directions are denoted by an arrow placed below the atom:
Left-directed atoms, $\p{\atmL{a}}$, are messages that are being sent to the left; right-directed atoms, $\p{\atmR{a}}$, are messages that are being sent to the right.
We will often elide the polarity annotation, writing $\atmL{a}$ and $\atmR{a}$ in place of $\p{\atmL{a}}$ and $\p{\atmR{a}}$.

\newthought{Negative propositions}, $\n{A}$, are processes that receive and react to messages.
\begin{equation*}
  \n{A} , \n{B} \Coloneqq \p{\atmR{a}} \limp \n{B} \mid \n{B} \pmir \p{\atmL{a}} \mid \n{A} \with \n{B} \mid \top \mid \up \p{A} \mid \n{\defp{p}}
\end{equation*}%
%
\begin{margintable}
  \begin{center}
    \begin{tabular}{@{}r@{\enspace}>{\itshape}l@{}}
      $\p{\atmR{a}} \limp \n{B}$ & receive message $\p{\atmR{a}}$ from the right \\
      $\n{B} \pmir \p{\atmL{a}}$ & receive message $\p{\atmL{a}}$ from the left \\
      $\n{A} \with \n{B}$ & nondeterministic branching \\% continue as $\n{A}$ or $\n{B}$ \\
      $\top\hphantom{\n{}}$ & stuck process \\
      $\up \p{A}$ & quoted configuration \\
      $\n{\defp{p}}$ & call a recursively defined process
    \end{tabular}
  \end{center}
  \caption{A formula-as-process interpretation of negative propositions}\label{fig:choreographies:negprop-table}
\end{margintable}%
%
% \begin{itemize}
% \item
  Instead of the more general $\p{A} \limp \n{B}$ and $\n{B} \pmir \p{A}$, left- and right-handed implications are now restricted to be only $\p{\atmR{a}} \limp \n{B}$ and $\n{B} \pmir \p{\atmL{a}}$.
  These propositions are then interpreted as input processes:
  $\p{\atmR{a}} \limp \n{B}$ is a process that waits to receive a message, $\p{\atmR{a}}$, from its left-hand neighbor and then continues as $\n{B}$; symmetrically, $\n{B} \pmir \p{\atmL{a}}$ is a process that awaits message $\p{\atmL{a}}$ from its right-hand neighbor.
  Because implications are restricted to atoms with \emph{complementary} direction, processes cannot re-capture messages that they just sent to other processes.%
\footnote{See \cref{sec:formula-as-process:comments} for more discussion.}

% \item
  The proposition $\n{A} \with \n{B}$ is interpreted as a process that branches nondeterministically, continuing as either $\n{A}$ or $\n{B}$.
  And $\top$, as the nullary form of $\with$, is a stuck process that cannot continue.
% \item
  The proposition $\up \p{A}$ is interpreted as a process that holds a suspended, or quoted, configuration:
  when the process $\up \p{A}$ is executed, it unfolds to that configuration.
% \item
  Lastly, $\n{\defp{p}}$ is a coinductively defined negative proposition that is interpreted as a recursive process, which we discuss in more detail in \cref{sec:formula-as-process:coinductive}.
% \end{itemize}

\newthought{Ordered contexts}, $\np{\octx}$, are interpreted as linear-topology run-time configurations of processes and the messages that pass between them.
\begin{align*}
  \np{\octx} , \np{\lctx} &\Coloneqq \np{\octx}_1 \oc \np{\octx}_2 \mid \octxe \mid \oante \\
  \oante &\Coloneqq \n{A} \mid \p{\atmL{a}} \mid \p{\atmR{a}}
\end{align*}
Just as ordered contexts form a monoid over negative propositions and positive atoms, their formula-as-process interpretation forms a monoid over processes and messages.
%
\begin{margintable}
  \begin{center}
    \begin{tabular}{@{}r@{\enspace}>{\itshape}l@{}}
      $\np{\octx}_1 \oc \np{\octx}_2$ & parallel composition of configurations \\
      $(\octxe)$ & empty configuration \\
      $\n{A}$ & single-process configuration \\
      $\p{\atmL{a}}$ & left-directed message \\
      $\p{\atmR{a}}$ & right-directed message
    \end{tabular}
  \end{center}
  \caption{A formula-as-process interpretation of contexts}\label{fig:choreographies:ctxprop-table}
\end{margintable}%
%
The monoid operation is now parallel, end-to-end composition of process configurations: $\np{\octx}_1 \oc \np{\octx}_2$ composes the configurations $\np{\octx}_1$ and $\np{\octx}_2$ so that they may interact along their mutual interface.
The empty context, $(\octxe)$, is now the empty configuration.

As usual, we do not distinguish configurations that are equivalent up to the monoid's associativity and unit laws.
This equivalence acts as an implicit structural congruence, of the sort found more explicitly in the $\pi$-calculus.

With the introduction of atom directions, it will often be useful to describe \emph{message contexts}, contexts that contain only atoms of one direction or the other.
We will use the metavariables $\atmL{\octx}$ and $\atmR{\octx}$ for those contexts that contain only left- and right-directed atoms, respectively.
More precisely, these are generated by the grammars 
\begin{equation*}
  \atmL{\octx} , \atmL{\lctx} \Coloneqq \atmL{\octx}_1 \oc \atmL{\octx}_2 \mid \octxe \mid \p{\atmL{a}}
  \qquad\text{and}\qquad
  \atmR{\octx} , \atmR{\lctx} \Coloneqq \atmR{\octx}_1 \oc \atmR{\octx}_2 \mid \octxe \mid \p{\atmR{a}}
  \,.
\end{equation*}


\newthought{Positive propositions}, $\p{A}$, are process expressions that reify run-time configurations $\np{\octx}$ as static objects.
\begin{equation*}
  \p{A} , \p{B} \Coloneqq \p{\atmL{a}} \mid \p{\atmR{a}} \mid \p{A} \fuse \p{B} \mid \one \mid \dn \n{A}
\end{equation*}
This reification is expressed as $\bigfuse \np{\octx} = \p{A}$, as defined in the adjacent \lcnamecref{fig:formula-as-process:reify-configuration}.%
\begin{marginfigure}
  \begin{align*}
    \bigfuse \p{\atmL{a}} &= \p{\atmL{a}} \\
    \bigfuse \p{\atmR{a}} &= \p{\atmR{a}} \\
    \bigfuse (\np{\octx}_1 \oc \np{\octx}_2) &= (\bigfuse \np{\octx}_1) \fuse (\bigfuse \np{\octx}_2) \\
    \bigfuse (\octxe) &= \one \\
    \bigfuse \n{A} &= \dn \n{A}
  \end{align*}
  \caption{Reifying a configuration as a process}\label{fig:formula-as-process:reify-configuration}
\end{marginfigure}%
This operation is the same as the one defined in \cref{fig:ordered-rewriting:polarized-bigfuse}, except that atom directions are preserved.

The propositions $\p{\atmL{a}}$ and $\p{\atmR{a}}$ are the expressions for left- and right-directed messages.
The proposition $\p{A} \fuse \p{B}$ reifies parallel, end-to-end composition of configurations: $\p{A} \fuse \p{B}$ is now interpreted as the expression for a process that spawns a new process, $\p{A}$, and then continues as $\p{B}$.
And $\one$ is interpreted as the expression for a process that immediately terminates, thereby reifying the empty configuration, $(\octxe)$.
Lastly, the proposition $\dn \n{A}$ is interpreted as the expression for a quoted process: executing that expression will result in the running process $\n{A}$.
%
\begin{margintable}
  \begin{center}
    \begin{tabular}{@{}r@{\enspace}>{\itshape}l@{}}
      $\p{\atmL{a}}$ & left-directed message \\
      $\p{\atmR{a}}$ & right-directed message \\
      $\p{A} \fuse \p{B}$ & parallel composition of $\p{A}$ and $\p{B}$ \\
      $\one\hphantom{\p{}}$ & terminating process \\
      $\dn \n{A}$ & quoted process
    \end{tabular}
  \end{center}
  \caption{A formula-as-process interpretation of positive propositions}\label{fig:choreographies:posprop-table}
\end{margintable}

Notice that there is no propositional connective that corresponds to a \emph{send} operation.
Sending a message is instead accomplished by spawning a process that is itself only a message: $\p{\atmL{a}} \fuse \p{B}$, $\p{B} \fuse \p{\atmR{a}}$, $\p{\atmR{a}} \fuse \p{B}$, and $\p{B} \fuse \p{\atmL{a}}$ are all possible but built from other propositional forms.
This is analogous to the way that the asynchronous $\pi$-calculus sends a message by parallel composition, as in $\bar{x}\langle y\rangle \mid P$.
Treating send operations this way makes the formula-as-process ordered rewriting framework an asynchronous calculus.

\subsection{Focused ordered rewriting as message-passing communication}

The three tweaks introduced by the formula-as-process interpretation to the structure of propositions -- especially atom directions and atomic premises for implications -- trickle down through the right- and left-focus judgments used to define rewriting:
\begin{itemize}[listparindent=\parindent, itemsep=\dimexpr\itemsep+\parsep\relax, parsep=0pt]
\item
First, because each positive atom is now marked with a direction, the $\jrule{ID}\smash{^{\p{a}}}$ rule%
\marginnote{\qquad%
  $\infer[\jrule{ID}\smash{^{\p{a}}}]{\rfocus{\p{a}}{\p{a}}}{}$%
}
that was previously part of the right-focus judgment's definition is replaced by two similar rules -- one for each direction:
\begin{equation*}
  \infer[\jrule{ID}\smash{^{\p{\atmL{a}}}}]{\rfocus{\p{\atmL{a}}}{\p{\atmL{a}}}}{}
  \qquad\text{and}\qquad
  \infer[\jrule{ID}\smash{^{\p{\atmR{a}}}}]{\rfocus{\p{\atmR{a}}}{\p{\atmR{a}}}}{}
  \,.
\end{equation*}
The other right-focusing rules remain unchanged.

\item
Second, because $\p{\atmR{a}} \limp \p{B}$ and $\n{B} \pmir \p{\atmL{a}}$ are now the only valid forms of implications, the left-focus judgment and its rules may be refined.
% left-handed implications now have only right-directed atoms as premises and right-handed implications have only left-directed atoms as premises, the left-focus judgment and its rules must be revised.
Instead of $\lfocus{\np{\octx}_L}{\n{A}}{\np{\octx}_R}{\p{C}}$, which has arbitrary contexts to the left and right of $\n{A}$, the judgment is now $\lfocus{\atmR{\octx}_L}{\n{A}}{\atmL{\octx}_R}{\p{C}}$ -- the left-hand context consists only of right-directed atoms, hence $\atmR{\octx}_L$; symmetrically, the right-hand context consists only of left-directed atoms, hence $\atmL{\octx}_R$.
The left-focus rules for the left- and right-handed implications are also revised to
\begin{inferences}
  \infer[\lrule{\limp}']{\lfocus{\atmR{\octx}_L \oc \p{\atmR{a}}}{\p{\atmR{a}} \limp \n{B}}{\atmL{\octx}_R}{\p{C}}}{
    \lfocus{\atmR{\octx}_L}{\n{B}}{\atmL{\octx}_R}{\p{C}}}
  \and\!\raisebox{1.25ex}{and}\and
  \infer[\lrule{\pmir}']{\lfocus{\atmR{\octx}_L}{\n{B} \pmir \p{\atmL{a}}}{\p{\atmL{a}} \oc \atmL{\octx}_R}{\p{C}}}{
    \lfocus{\atmR{\octx}_L}{\n{B}}{\atmL{\octx}_R}{\p{C}}}
  \,,
\end{inferences}
which are the derivable from the earlier $\lrule{\limp}$ and $\lrule{\pmir}$ rules, as shown in the adjacent \lcnamecref{fig:formula-as-process:limp-focus}.%
\begin{marginfigure}
  \begin{gather*}
    \infer[\mathrlap{\lrule{\limp}}]{\lfocus{\atmR{\octx}_L \oc \p{\atmR{a}}}{\p{\atmR{a}} \limp \n{B}}{\atmL{\octx}_R}{\p{C}}}{
      \infer[\jrule{ID}\smash{^{\p{\atmR{a}}}}]{\rfocus{\p{\atmR{a}}}{\p{\atmR{a}}}}{} &
      \lfocus{\atmR{\octx}_L}{\n{B}}{\atmL{\octx}_R}{\p{C}}}
    %
    \\\downsquigarrow\\
    %
    \infer[\mathrlap{\lrule{\limp}'}]{\lfocus{\atmR{\octx}_L \oc \p{\atmR{a}}}{\p{\atmR{a}} \limp \n{B}}{\atmL{\octx}_R}{\p{C}}}{
      \lfocus{\atmR{\octx}_L}{\n{B}}{\atmL{\octx}_R}{\p{C}}}
  \end{gather*}
  \caption{Deriving the $\lrule{\limp}'$ left focus rule}\label{fig:formula-as-process:limp-focus}
\end{marginfigure}

% With the restriction to atomic premises, we need to reconsider the left-focus rules for the left- and right-handed implications.
% By inversion under the previous set of left-focus rules, any derivation focused on $\atmR{a} \limp \n{B}$ would end with
% By similar reasoning, we arrive at a $\lrule{\pmir}'$ rule, as well:
% \begin{equation*}
%   \infer[\lrule{\pmir}']{\lfocus{\atmR{\octx}_L}{\n{B} \pmir \atmL{a}}{\atmL{a} \oc \atmL{\octx}_R}{\p{C}}}{
%     \lfocus{\atmR{\octx}_L}{\n{B}}{\atmL{\octx}_R}{\p{C}}}
% \end{equation*}
The other rules for the left-focus judgment remain fundamentally unchanged, save for the fact that the left- and right-hand contexts now contain only atoms of the complementary direction.
\end{itemize}
% \Cref{fig:??} summarizes the revised rules for the right- and left-focus judgments.
% 
Having refined the left-focus judgment to use message contexts, we may similarly refine the principal reduction rule, $\jrule{$\reduces$I}$:
% and $\jrule{$\reduces$C}$:
\begin{equation*}
  \infer[\jrule{$\reduces$I}]{\atmR{\octx}_L \oc \n{A} \oc \atmL{\octx}_R \reduces \np{\octx'{}}}{
    \lfocus{\atmR{\octx}_L}{\n{A}}{\atmL{\octx}_R}{\p{B}} &
    \rfocus{\np{\octx'{}}}{\p{B}}}
  % \and
  % \infer[\jrule{$\reduces$C}]{\np{\octx}_L \oc \np{\octx} \oc \np{\octx}_R \reduces \np{\octx}_L \oc \np{\octx'{}} \oc \np{\octx}_R}{
  %   \np{\octx} \reduces \np{\octx'{}}}
  \,.
\end{equation*}
The compatibility rule, $\jrule{$\reduces$C}$, remains unchanged.
\Cref{fig:formula-as-process:framework} summarizes the revised rules for the formula-as-process ordered rewriting framework.

\begin{figure}[tbp]
  \vspace*{\dimexpr-\abovedisplayskip-\abovecaptionskip\relax}
  \begin{syntax*}
    Positive props. &
      \p{A} , \p{B} & \p{\atmL{a}} \mid \p{\atmR{a}} \mid \p{A} \fuse \p{B} \mid \one \mid \dn \n{A}
    \\
    Negative props. &
      \n{A} , \n{B} & \p{\atmR{a}} \limp \n{B} \mid \n{B} \pmir \p{\atmL{a}} \mid \n{A} \with \n{B} \mid \top \mid \up \p{A} \mid \n{\defp{p}}
    \\
    Contexts &
      \np{\octx} , \np{\lctx} & \np{\octx}_1 \oc \np{\octx}_2 \mid \octxe \mid \n{A} \mid \p{\atmL{a}} \mid \p{\atmR{a}}
    \\
    Signatures &
      \orsig & \orsige \mid \orsig, \n{\defp{p}} \defd \n{A}
  \end{syntax*}
  \begin{inferences}
    \infer[\rrule{\fuse}]{\rfocus{\np{\octx}_1 \oc \np{\octx}_2}{\p{A} \fuse \p{B}}}{
      \rfocus{\np{\octx}_1}{\p{A}} & \rfocus{\np{\octx}_2}{\p{B}}}
    \and
    \infer[\rrule{\one}]{\rfocus{\octxe}{\one}}{}
    \\
    \infer[\jrule{ID}\smash{^{\p{\atmL{a}}}}]{\rfocus{\p{\atmL{a}}}{\p{\atmL{a}}}}{}
    \and
    \infer[\jrule{ID}\smash{^{\p{\atmR{a}}}}]{\rfocus{\p{\atmR{a}}}{\p{\atmR{a}}}}{}
    \and
    \infer[\rrule{\dn}]{\rfocus{\n{A}}{\dn \n{A}}}{}
  \end{inferences}
  \begin{inferences}
    \infer[\lrule{\limp}']{\lfocus{\atmR{\octx}_L \oc \p{\atmR{a}}}{\p{\atmR{a}} \limp \n{B}}{\atmL{\octx}_R}{\p{C}}}{
      \lfocus{\atmR{\octx}_L}{\n{B}}{\atmL{\octx}_R}{\p{C}}}
    \and
    \infer[\lrule{\pmir}']{\lfocus{\atmR{\octx}_L}{\n{B} \pmir \p{\atmL{a}}}{\atmL{\octx}_R}{\p{C}}}{
      \lfocus{\atmR{\octx}_L}{\n{B}}{\atmL{\octx}_R}{\p{C}}}
    \\
    \infer[\lrule{\with}_1]{\lfocus{\atmR{\octx}_L}{\n{A} \with \n{B}}{\atmL{\octx}_R}{\p{C}}}{
      \lfocus{\atmR{\octx}_L}{\n{A}}{\atmL{\octx}_R}{\p{C}}}
    \and
    \infer[\lrule{\with}_2]{\lfocus{\atmR{\octx}_L}{\n{A} \with \n{B}}{\atmL{\octx}_R}{\p{C}}}{
      \lfocus{\atmR{\octx}_L}{\n{B}}{\atmL{\octx}_R}{\p{C}}}
    \and
    \text{(no $\lrule{\top}$ rule)}
    \\
    \infer[\lrule{\up}]{\lfocus{}{\up \p{A}}{}{\p{A}}}{}
  \end{inferences}
  \begin{inferences}
    \infer[\jrule{$\reduces$I}]{\atmR{\octx}_L \oc \n{A} \oc \atmL{\octx}_R \reduces \octx'}{
      \lfocus{\atmR{\octx}_L}{\n{A}}{\atmL{\octx}_R}{\p{C}} &
      \rfocus{\octx'}{\p{C}}}
    \and
    \infer[\jrule{$\reduces$C}]{\octx_L \oc \octx \oc \octx_R \reduces \octx_L \oc \octx' \oc \octx_R}{
      \octx \reduces \octx'}
  \end{inferences}
  \begin{inferences}
    \infer[\jrule{$\Reduces$R}]{\octx \Reduces \octx}{}
    \and
    \infer[\jrule{$\Reduces$T}]{\octx \Reduces \octx''}{
      \octx \reduces \octx' & \octx' \Reduces \octx''}
  \end{inferences}
  \caption{A formula-as-process ordered rewriting framework}\label{fig:formula-as-process:framework}
\end{figure}

\clearpage
\subsection{Comments}\label{sec:formula-as-process:comments}\label{sec:formula-as-process:typing}

Now we are in a position to understand how the two principal syntactic changes -- atom directions and atomic premises for implications -- combine to endow the otherwise untyped processes with a modicum of static typing.

In the expression $\dn \n{A} \fuse \p{\atmR{a}}$, the atom $\p{\atmR{a}}$ is an outgoing message, owing to its direction away from the (quoted) process $\n{A}$.
If the premises of left- and right-handed implications were \emph{not} restricted to atoms of complementary direction, then $\n{A}$ might possibly be the input process $\up \dn \n{B} \pmir \p{\atmR{a}}$, which could incorrectly (re-)capture the outgoing message, $\p{\atmR{a}}$, that it just sent:
\begin{equation*}
  (\up \dn \n{B} \pmir \p{\atmR{a}}) \fuse \p{\atmR{a}}
    \reduces (\up \dn \n{B} \pmir \p{\atmR{a}}) \oc \p{\atmR{a}}
    \reduces \n{B}
  \,.
\end{equation*}
However, because the premises of left- and right-handed implications are indeed restricted to atoms of complementary direction, this scenario is impossible -- $\up \dn \n{B} \pmir \p{\atmR{a}}$ is not even a well-formed proposition!%

Formally, this property that outgoing messages cannot be recaptured is established the following \lcnamecref{thm:formula-as-process:no-recapture-outputs}.
\begin{theorem}\label{thm:formula-as-process:no-recapture-outputs}
  If $\octx = \atmL{\octx}_L \oc \octx_0 \oc \atmR{\octx}_R \Reduces \octx'$, then $\octx' = \atmL{\octx}_L \oc \octx_0 \oc \atmR{\octx}_R$ for some context $\octx'_0$ such that $\octx_0 \Reduces \octx'_0$.
\end{theorem}
\begin{proof}
  By induction on the structure of the given rewriting sequence, using inversion on the individual rewriting steps.
\end{proof}

As a related consequence of these syntactic restrictions, there is no contention for messages.
Without these restrictions, the above trace could be adapted to one in which a race could arise between two processes contending for the same message:\fixnote{fix}
\begin{equation*}
  \hphantom{(\up \dn \n{B} \pmir \p{a}) \oc \p{a} \oc (\p{a} \limp \up \dn \n{C})}
  \begin{tikzcd}[row sep=tiny, column sep=small]
    & \n{B} \\
    \mathllap{(\up \dn \n{B} \pmir \p{\atmR{a}}) \oc \p{\atmR{a}} \oc (\p{\atmR{a}} \limp \up \dn \n{C})}
      \urar[reduces] \drar[reduces] \\
    & \n{C}
  \end{tikzcd}
\end{equation*}
However, with these restrictions in place, there is no message -- neither $\p{\atmL{a}}$ nor $\p{\atmR{a}}$ -- that can cause contention between $\up \n{B} \pmir \p{\atmL{a}}$ and $\p{\atmR{a}} \limp \up \n{C}$ because $\p{\atmL{a}} \neq \p{\atmR{a}}$, that is, there is no one atom that may have both directions.
% \footnote{%
  % That is:
  % \begin{itemize}
  % \item $(\up \n{B} \pmir \p{\atmL{a}}) \oc \p{\atmL{a}} \oc (\p{\atmR{a}} \limp \up \n{C}) \reduces \np{\octx'{}}$ only if $\np{\octx'{}} = \n{B} \oc (\p{\atmR{a}} \limp \up \n{C})$; and
  % \item $(\up \n{B} \pmir \p{\atmL{a}}) \oc \p{\atmR{a}} \oc (\p{\atmR{a}} \limp \up \n{C}) \reduces \np{\octx'{}}$ only if $\np{\octx'{}} = (\up \n{B} \pmir \p{\atmL{a}}) \oc \n{C}$.
  % \end{itemize}}

Even with the restriction of left- and right-handed implication premises to atoms of complementary direction, it is nevertheless possible for a process to send \emph{itself} a message, as in
\begin{equation*}
  (\up \dn \n{B} \pmir \p{\atmL{a}}) \fuse \p{\atmL{a}}
    \reduces (\up \dn \n{B} \pmir \p{\atmL{a}}) \oc \p{\atmL{a}}
    \reduces \n{B}
  \,,
\end{equation*}
but this is not troubling because the intended recipient -- the process itself -- does indeed receive the message.

\newthought{Ordered conjunctions} are dual to the left- and right-handed implications.
So one might think that ordered conjunctions ought to be restricted to those of the form $\p{\atmL{a}} \fuse \p{B}$ and $\p{B} \fuse \p{\atmR{a}}$, as a kind of dual restriction to those placed on implications.
Just as the implications are restricted to receive only incoming messages, these ordered conjunctions would restrict processes to sending only outgoing messages.

Although certainly possible, such restrictions would limit the expressiveness of formula-as-process ordered rewriting by precluding a process from sending itself a message -- $(\up \dn \n{B} \pmir \p{\atmL{a}}) \fuse \p{\atmL{a}}$ would not be well-formed, for example.
Moreover, in \cref{ch:correspond}, we will present a correspondence between ordered propositions and the not-yet-introduced singleton proofs~\parencref{ch:singleton-logic,ch:process-chains}, which will turn out to be most direct if we retain the general $\p{A} \fuse \p{B}$ form for ordered conjunctions.
And finally, the general $\p{A} \fuse \p{B}$ form is more in line with the asynchronous nature of ordered rewriting.
For all of these reasons, we choose not to impose any restrictions on ordered conjunctions.


% \subsection{Left- and right-directed atoms as directed messages}

% The first tweak to the structure of propositions is that the positive atoms are now partitioned into two classes: left- and right-directed atoms.
% These directions, which we denote by an arrow placed below the atom, indicate the direction in which the corresponding message flows.
% Left-directed atoms, $\p{\atmL{a}}$, are messages that are being sent to the left; right-directed atoms, $\p{\atmR{a}}$, are messages that are being sent to the right.

% \subsection{Implications restricted to atomic premises as input processes}

\subsection{Coinductively defined negative propositions}\label{sec:formula-as-process:coinductive}

Recall from \cref{ch:ordered-rewriting} that \acl{FOR} is terminating: for all ordered contexts $\np{\octx}$, every rewriting sequence from $\np{\octx}$ is finite~\parencref{thm:ordered-rewriting:termination-focused}.
Although a seemingly pleasant property, termination significantly limits the expressiveness of \acl{FOR}.
For example, without unbounded rewriting, we cannot even describe producer--consumer systems or finite automata.

As the proof of termination shows, rewriting is bounded precisely because contexts consist of finitely many \emph{finite} propositions.
In multiset and ordered rewriting, unbounded behavior is traditionally introduced by way of persistent propositions that may be replicated as much as needed\autocites{Polakow:CMU01}{Watkins+:CMU02}{Simmons:CMU12}.
This is related to \citeauthor{Milner:CUP99}'s use of replication, $!P$, in the $\pi$-calculus\autocite{Milner:CUP99}.
(See \cref{sec:ordered-logic:circular} for a more detailed discussion of replication.)

However, another option -- and the one that we pursue here -- is to permit circular negative propositions in the form of mutually coinductive definitions, $\n{\defp{p}} \defd \n{A}$, where the grammar of negative propositions is extended to include these coinductively defined propositions:
\begin{equation*}
  \n{A}, \n{B} \Coloneqq \p{\atmR{a}} \limp \n{B} \mid \n{B} \pmir \p{\atmL{a}} \mid \n{A} \with \n{B} \mid \top \mid \n{\defp{p}}
  \,.
\end{equation*}
Sequent calculi with recursive definitions of this kind have been studied previously\autocites{Hallnas:TCS91}{Eriksson:ELP91}{Schroeder-Heister:LICS93}{McDowell+Miller:TCS00}{Tiu+Momigliano:JAL12}, but, to the best of our knowledge, the use of coinductive definitions in the context of logically motivated rewriting systems is new.

That the definitions $\n{\defp{p}} \defd \n{A}$ are indeed coinductive is guaranteed by imposing the requirement that along every cycle among defined propositions there is a logical connective.%
\footnote{This generalizes the local \emph{contractivity} condition described by \textcite{Gay+Hole:AI05}.}
For example, the definition $\n{\defp{p}} \defd \p{\atmR{a}} \limp \n{\defp{p}}$ or even the definitions $\n{\defp{p}} \defd \n{\defp{q}}$ and $\n{\defp{q}} \defd \p{\atmR{a}} \limp \n{\defp{p}}$ are acceptable because $(\p{\atmR{a}} \limp \mathord{-})$ occurs along the cycle from $\n{\defp{p}}$ to itself; but the definitions $\n{\defp{p}} \defd \n{\defp{q}}$ and $\n{\defp{q}} \defd \n{\defp{p}}$ are forbidden because no logical connective occurs along the cycle.

To clarify, these definitions are coinductive in only a syntactic sense; when interpreted as processes, they are not (necessarily) behaviorally coinductive.
For example, the proposition $\n{\defp{p}}$ given by $\n{\defp{p}} \defd \atmR{a} \limp \atmR{a} \fuse \n{\defp{p}}$ does not correspond to a productive process when viewed from the formula-as-process perspective -- after receiving an initial message $\atmR{a}$, the process $\n{\defp{p}}$ diverges without sending or receiving any further messages.
Therefore, our coinductively defined propositions are \emph{not} greatest fixed points (or coinductive proofs) in the sense of \citeauthor{Fortier+Santocanale:CSL13}\autocite{Fortier+Santocanale:CSL13}.

% That the definitions $\n{\defp{p}} \defd \n{A}$ are indeed coinductive is guaranteed by imposing the requirement that all definitions be \emph{contractive}\autocite{??} -- \ie, that the body of each definition begin with a logical connective, logical constant, or atomic proposition at the top level.
% Contractivity rules out definitions like $\n{\defp{p}} \defd \n{\defp{p}}$ that do not correspond to sensible coinductive propositions and also to rule out sensible but inessential definitions like $\n{\defp{p}} \defd \n{\defp{q}}$.

% To rule out definitions like $\n{\defp{p}} \defd \n{\defp{p}}$ that do not correspond to sensible infinite propositions and also to rule out sensible but inessential definitions like $\n{\defp{p}} \defd \n{\defp{q}}$, we require that all definitions be \emph{contractive}\autocite{??} -- \ie, that the body of each recursive definition begin with a logical connective, logical constant, or atomic proposition at the top level.

Coinductive definitions are collected into a signature, $\orsig$, that indexes the rewriting relations: $\reduces_{\orsig}$ and $\Reduces_{\orsig}$.%
\footnote{We often elide the index, as it is usually clear from context.}
Syntactically, these signatures are given by the grammar
\begin{equation*}
  \orsig \Coloneqq \orsige \mid \orsig, (\n{\defp{p}} \defd \n{A})
  \,.
\end{equation*}
A signature $\orsig$ is well-formed if every $\n{\defp{p}}$ that occurs in the body of a definition itself has a definition in $\orsig$.

\newthought{By analogy with} recursive types from functional programming\footnote{See \textcite{Pierce:MIT02}, for example.}, we must then decide whether to treat the coinductive definitions $\n{\defp{p}} \defd \n{A}$ \emph{iso}\-recursively or \emph{equi}\-recursively.\fixnote{equi-coinductively?}
Under an equirecursive treatment, definitions may be silently unrolled or rolled at will;
in other words, $\n{\defp{p}}$ is literally \emph{equal} to its unrolling: $\n{\defp{p}} = \n{A}$.
In contrast, under an isorecursive treatment, unrolling a coinductively defined proposition would count only as an explicit rule for the left-focus judgment: $\n{\defp{p}} \neq \n{A}$ but the adjacent $\lrule{\defd}$ rule would be present.%
\marginnote{%
  $\infer[\lrule{\defd}]{\lfocus{\atmR{\octx}_L}{\n{\defp{p}}}{\atmL{\octx}_R}{_{\orsig} \p{C}}}{
    \text{($(\n{\defp{p}} \defd \n{A}) \in \orsig$)} &
    \lfocus{\atmR{\octx}_L}{\n{A}}{\atmL{\octx}_R}{_{\orsig} \p{C}}}$}

Because these coinductively defined propositions are not generative, there is not much difference between the equirecursive and isorecursive treatments.\autocite{Amadio+Cardelli:TPLS93}
We choose an equirecursive treatment of definitions simply because the accompanying generous notion of equality helps to minimize the conceptual overhead of coinductively defined propositions.
% As a simple example, under the equirecursive definition $\n{\defp{p}} \defd \p{\atmR{a}} \limp \up \dn \n{\defp{p}}$, we have the trace
% \begin{equation*}
%   \p{\atmR{a}} \oc \p{\atmR{a}} \oc \n{\defp{p}}
%     = \p{\atmR{a}} \oc \p{\atmR{a}} \oc (\p{\atmR{a}} \limp \up \dn \n{\defp{p}})
%     \reduces \p{\atmR{a}} \oc \n{\defp{p}}
% \end{equation*}

\newthought{How do these} coinductively defined negative propositions interact with the left-focus judgment, which is defined inductively?
The answer is that not all coinductively defined propositions can be successfully put into focus.
As previously mentioned, the proposition $\n{\defp{p}}$ given by $\n{\defp{p}} \defd \p{\atmR{a}} \limp \n{\defp{p}}$ is certainly a well-defined coinductive proposition, owing to the existence of $(\p{\atmR{a}} \limp \mathord{-})$ along the cycle.
Yet it cannot be successfully put into left focus -- there are no contexts $\atmR{\octx}_L$ and $\atmL{\octx}_R$ and positive consequent $\p{C}$ for which $\lfocus{\atmR{\octx}_L}{\n{\defp{p}}}{\atmL{\octx}_R}{\p{C}}$ is derivable.
To derive a left-focus judgment on $\n{\defp{p}}$, the finite context $\atmR{\octx}_L$ would need to hold an infinite stream of $\p{\atmR{a}}$ atoms -- an impossible feat for the inductively defined, and hence finite, contexts like $\atmR{\octx}_L$ that we consider here.%
\footnote{%
  \Textcite{Miller:??} presents a system with infinite focusing phases, which would certainly permit definitions like $\n{\defp{p}} \defd \p{\atmR{a}} \limp \n{\defp{p}}$ to be put into focus.
  We do not pursue that generalization here because we want rewriting to occur on finite contexts only.}

% However, because the left-focus judgment is defined inductively, not coinductively, there are some recursively defined negative propositions that cannot successfully be put into focus.
% Under the definition $\n{\defp{p}} \defd \p{\atmR{a}} \limp \n{\defp{p}}$, for example, there are no contexts $\atmR{\octx}_L$ and $\atmL{\octx}_R$ and positive consequent $\p{C}$ for which $\lfocus{\atmR{\octx}_L}{\n{\defp{p}}}{\atmL{\octx}_R}{\p{C}}$ is derivable.
% To derive a left-focus judgment on $\n{\defp{p}}$, the finite context $\atmR{\octx}_L$ would need to hold an infinite stream of $\p{\atmR{a}}$ atoms, which is impossible in an inductively defined, and hence finite, context.

However, by inserting $\up \dn$ as a double shift to blur focus -- in a way similar to how double shifts were used in the embedding of unfocused rewriting~\parencref{sec:ordered-rewriting:embed-unfocused} -- the definition can be revised to one that admits a left-focus judgment.
Specifically, if $\n{\defp{p}}$ is instead given by $\n{\defp{p}} \defd \p{\atmR{a}} \limp \up \dn \n{\defp{p}}$, then $\lfocus{\p{\atmR{a}}}{\n{\defp{p}}}{}{\dn \n{\defp{p}}}$ is derivable, and so $\p{\atmR{a}} \oc \n{\defp{p}} \reduces \n{\defp{p}}$.
More generally, any coinductively defined proposition that has an $\up$ shift along \emph{some} cycle can be successfully put into focus.

One might consider elevating the $\up$-shift property to a requirement on coinductively defined propositions -- \ie, demanding that every coinductively proposition have an $\up$ shift along some cycle.
This would forbid any definitions that cannot be put into left focus, such as $\n{\defp{p}} \defd \p{\atmR{a}} \limp \n{\defp{p}}$.
Although perhaps well-intentioned, such a requirement seems somewhat under-motivated after observing that even the proposition $\top$ cannot be successfully put into focus.

% \clearpage
% \section{}


% This interpretation is summarized in the adjacent \lcnamecref{fig:choreographies:propctx-table}.%
% \begin{margintable}
%   \begin{center}
%     \begin{tabular}{@{}l@{\enspace\ }>{\itshape}l@{}}
%       $\p{\atmL{a}}$ & left-directed message \\
%       $\p{\atmR{a}}$ & right-directed message \\
%       $\n{A}$ & message-passing process \\
%       $\np{\octx}$ & process configuration \\
%       $\p{A}$ & configuration reified as a process
%     \end{tabular}
%   \end{center}
%   \caption{A formula-as-process interpretation of polarized ordered propositions and contexts}\label{fig:choreographies:propctx-table}
% \end{margintable}%

% \newthought{}
% Under the formula-as-process interpretation, the rewriting judgment, $\np{\octx} \reduces \np{\octx'{}}$, is viewed as message-passing communication within the process configuration $\np{\octx}$.


% \begin{equation*}
%   \n{A}, \n{B} \Coloneqq \p{\atmR{a}} \limp \up \p{B} \mid \up \p{B} \pmir \p{\atmL{a}} \mid \n{A} \with \n{B} \mid \top \mid \up \p{A}
% \end{equation*}

% \begin{equation*}
%   \p{A}, \p{B} \Coloneqq \p{\atmL{a}} \mid \p{\atmR{a}} \mid \p{A} \fuse \p{B} \mid \one \mid \dn \n{A}
% \end{equation*}



% \begin{align*}
%   \n{A} &\Coloneqq \p{\atmR{a}} \limp \n{B} \mid \n{B} \pmir \p{\atmL{a}} \mid \n{A} \with \n{B} \mid \top \mid \up \p{A} \mid \n{\defp{p}}
% \end{align*}

% \begin{margintable}
%   \begin{center}
%     \begin{tabular}{@{}r@{\enspace}>{\itshape}l@{}}
%       $\p{\atmR{a}} \limp \n{B}$ & receive message $\p{\atmR{a}}$ from the right \\
%       $\n{B} \pmir \p{\atmL{a}}$ & receive message $\p{\atmL{a}}$ from the left \\
%       $\n{A} \with \n{B}$ & nondeterministic branching \\% continue as $\n{A}$ or $\n{B}$ \\
%       $\top\hphantom{\n{}}$ & \\
%       $\up \p{A}$ & \\
%       $\n{\defp{p}}$ & call a recursively defined process
%     \end{tabular}
%   \end{center}
%   \caption{A formula-as-process interpretation of negative propositions}\label{fig:choreographies:negprop-table}
% \end{margintable}

% \begin{margintable}
%   \begin{center}
%     \begin{tabular}{@{}r@{\enspace}>{\itshape}l@{}}
%       $\np{\octx}_1 \oc \np{\octx}_2$ & parallel composition of configurations \\
%       $(\octxe)$ & empty configuration \\
%       $\n{A}$ & single-process configuration \\
%       $\p{\atmL{a}}$ & left-directed message \\
%       $\p{\atmR{a}}$ & right-directed message
%     \end{tabular}
%   \end{center}
%   \caption{A formula-as-process interpretation of contexts}\label{fig:choreographies:ctxprop-table}
% \end{margintable}

% \begin{margintable}
%   \begin{center}
%     \begin{tabular}{@{}r@{\enspace}>{\itshape}l@{}}
%       $\p{\atmL{a}}$ & left-directed message \\
%       $\p{\atmR{a}}$ & right-directed message \\
%       $\p{A} \fuse \p{B}$ & parallel composition of $\p{A}$ and $\p{B}$ \\
%       $\one\hphantom{\p{}}$ & forwarding process \\
%       $\dn \n{A}$ & 
%     \end{tabular}
%   \end{center}
%   \caption{A formula-as-process interpretation of positive propositions}\label{fig:choreographies:posprop-table}
% \end{margintable}

% In focused ordered rewriting, ordered contexts consist of positive atoms, $\p{a}$, and negative propositions, $\n{A}$.
% Under the formula-as-process interpretation, positive atoms will be viewed as messages, and negative propositions will be viewed as processes that receive and react to those messages.
% Ordered contexts are then configurations of processes and messages, arranged in a linear topology.





% Positive atoms, $\p{a}$


% Negative propositions, $\n{A}$, are interpreted as message-passing processes, with positive atoms, $\p{a}$, as messages passed between them.
% Ordered contexts, $\octx$, are then configurations of processes and messages arranged in a linear topology.
% Finally, the positive propositions, $\p{A}$, reify ordered contexts, and so they can be interpreted as process expressions that reify process configurations.

% The ordered implications $\p{A} \limp \n{B}$ and $\n{B} \pmir \p{A}$ are restricted to $\p{a} \limp \n{B}$ and $\n{B} \pmir \p{a}$, respectively, so that they may cleanly be interpreted as processes that input a message $\p{a}$ from the left and right, respectively.


% Each positive atom $\p{a}$ is assigned a direction, either $\atmL{a}$ or $\atmR{a}$, that indicates 

% $\atmL{a}$ and $\atmR{a}$; and $\p{A} \limp \n{B}$ restricted to $\atmR{a} \limp \n{B}$ and similarly for right-handed implication.

% \subsection{Formula-as-process}

% Discuss here?

% Example of $\proc{b} \defd (\atmR{a} \limp \up \dn \proc{b}) \with \up \one$, without explicitly relating it to the specification.

% \subsection{Focused ordered rewriting, revisited}

% The two changes introduced by the formula-as-process interpretation -- atom directions and atomic premises for implications -- trickle down to the focused ordered rewriting framework.

% First, because each positive atom is now marked with a direction, the $\jrule{ID}\smash{^{\p{a}}}$ rule%
% \marginnote{\qquad%
%   $\infer[\jrule{ID}\smash{^{\p{a}}}]{\rfocus{\p{a}}{\p{a}}}{}$%
% }
% that was previously part of the right-focus judgment's definition is replaced by two similar rules:
% \begin{equation*}
%   \infer[\jrule{ID}\smash{^{\atmR{a}}}]{\rfocus{\atmR{a}}{\atmR{a}}}{}
%   \qquad\text{and}\qquad
%   \infer[\jrule{ID}\smash{^{\atmL{a}}}]{\rfocus{\atmL{a}}{\atmL{a}}}{}
%   \,.
% \end{equation*}
% The other right-focusing rules remain unchanged.

% Second, because left-handed implications now have only right-directed atoms as premises and right-handed implications have only left-directed atoms as premises, the left-focus judgment and its rules must be revised.
% Instead of $\lfocus{\np{\octx}_L}{\n{A}}{\np{\octx}_R}{\p{C}}$, which has arbitrary contexts to the left and right of $\n{A}$, the judgment is now $\lfocus{\atmR{\octx}_L}{\n{A}}{\atmL{\octx}_R}{\p{C}}$ -- the left-hand context consists only of right-directed atoms, hence $\atmR{\octx}_L$; symmetrically, the right-hand context consists only of left-directed atoms, hence $\atmL{\octx}_R$.

% With the restriction to atomic premises, we need to reconsider the left-focus rules for the left- and right-handed implications.
% By inversion under the previous set of left-focus rules, any derivation focused on $\atmR{a} \limp \n{B}$ would end with
% \begin{equation*}
%   \infer[\lrule{\limp}]{\lfocus{\atmR{\octx}_L \oc \atmR{a}}{\atmR{a} \limp \n{B}}{\atmL{\octx}_R}{\p{C}}}{
%     \infer[\jrule{ID}\smash{^{\atmR{a}}}]{\rfocus{\atmR{a}}{\atmR{a}}}{} &
%     \lfocus{\atmR{\octx}_L}{\n{B}}{\atmL{\octx}_R}{\p{C}}}
%   %
%   \qquad
%   %
%   \infer[\lrule{\limp}']{\lfocus{\atmR{\octx}_L \oc \atmR{a}}{\atmR{a} \limp \n{B}}{\atmL{\octx}_R}{\p{C}}}{
%     \lfocus{\atmR{\octx}_L}{\n{B}}{\atmL{\octx}_R}{\p{C}}}
% \end{equation*}
% By similar reasoning, we arrive at a $\lrule{\pmir}'$ rule, as well:
% \begin{equation*}
%   \infer[\lrule{\pmir}']{\lfocus{\atmR{\octx}_L}{\n{B} \pmir \atmL{a}}{\atmL{a} \oc \atmL{\octx}_R}{\p{C}}}{
%     \lfocus{\atmR{\octx}_L}{\n{B}}{\atmL{\octx}_R}{\p{C}}}
% \end{equation*}
% The other rules for the left-focus judgment remain unchanged, save for the fact that the left- and right-hand context now contain only atoms of the appropriate direction.
% \Cref{fig:??} summarizes the revised rules for the right- and left-focus judgments.

% Having refined the left-focus judgement to use input message contexts, we may similarly refine the reduction rules, $\jrule{$\reduces$I}$ and $\jrule{$\reduces$C}$:
% \begin{inferences}
%   \infer[\jrule{$\reduces$I}]{\atmR{\octx}_L \oc \n{A} \oc \atmL{\octx}_R \reduces \np{\octx'{}}}{
%     \lfocus{\atmR{\octx}_L}{\n{A}}{\atmL{\octx}_R}{\p{B}} &
%     \rfocus{\np{\octx'{}}}{\p{B}}}
%   \and
%   \infer[\jrule{$\reduces$C}]{\np{\octx}_L \oc \np{\octx} \oc \np{\octx}_R \reduces \np{\octx}_L \oc \np{\octx'{}} \oc \np{\octx}_R}{
%     \np{\octx} \reduces \np{\octx'{}}}
% \end{inferences}

% \clearpage
% \subsection{}

% In unfocused and focused ordered rewriting of the \ac{OR}~\parencref{??} and \ac{FOR}~\parencref{??} frameworks, the rewriting relation, $\reduces$, described a purely internal operation: $\octx \reduces \octx'$ held independently of any environment that might surround $\octx$.
% Ordered rewriting's isolationism was affirmed by its compatibility rule, $\jrule{$\reduces$C}$%
% \marginnote{%
% $\infer[\jrule{$\reduces$C}]{\octx_L \oc \octx \oc \octx_R \reduces \octx_L \oc \octx' \oc \octx_R}{
%   \octx \reduces \octx'}$}%
% , which shows that the environment remains unaffected by the rewriting of its [...].

% Now that we have a formula-as-process interpretation to ordered rewriting, we should reconsider this strict isolationism.
% Under our formula-as-process reading, this isolationist rewriting judgment corresponds to a reduction semantics for processes.
% But now, messages, as represented by the directed $\p{\atmL{a}}$ and $\p{\atmR{a}}$ atoms, make it possible to describe the interactions that a configuration $\octx$ offers to its surroundings. 


\section{A local interaction semantics}\label{sec:formula-as-process:local-interaction}% \label{sec:formula-as-process:transition-semantics}

For the formula-as-process interpretation, we have thus far examined the rewriting judgment, $\octx \reduces \octx'$, and suggested that it represents a kind of reduction semantics for the underlying processes.
% Now that we are ascribing a formula-as-process interpretation to ordered rewriting, this judgment characterizes internal reductions.

But a reduction semantics is not the only way to describe the operational semantics of a process calculus.
For example, in the $\pi$-calculus, labeled transition systems are frequently used as an alternative to a reduction semantics, particularly when an understanding of how processes interact with their surroundings is needed.

For the formula-as-process ordered rewriting framework, we can similarly conceive of a local interaction semantics of this sort.
All communication occurs through message passing, so there are just two ways a process configuration can interact with its surrounding environment -- either send messages or receive them; either make an output transition or make an input transition.
% The ability of a configuration to make these two forms of transition is captured by two distinct judgments.
A process configuration can also forgo interacting with its environment and make a silent, internal transition as the configuration's components interact with each other.

Traditionally, these three forms of transition -- internal, output, and input -- are expressed with a unified labeled transition judgment in which the labels distinguish among the three forms of trnsition.
% output transitions from input transitions.
Here we instead prefer to use distinct syntax for each form of transition.

\paragraph*{Internal transitions}

In labeled transition systems for process calculi, internal $\tau$-transitions express interaction of a process configuration, not with its environment, but within itself among its constituent processes.
In the $\pi$-calculus, these internal transitions coincide with the notion of reduction but are defined as $\overset{\tau}{\reduces}$ in such a way that the explicit and sometimes cumbersome structural congruence is not needed, thereby simplifying proofs.

In our setting, however, we have no explicit structural congruence; the implicit monoid laws do not complicate proofs, so we can get away without defining a distinct notion of internal $\tau$-transition.
Whenever we want to describe an internal transition, the $\reduces$ reduction relation can be used instead.

In the $\pi$-calculus, there is also a notion of weak internal $\tau$-transition, $\overset{\tau}{\Reduces}$, which is the reflexive, transitive closure of $\overset{\tau}{\reduces}$.
Just as we use the $\reduces$ reduction relation whenever we want to describe an internal transition, we will use its reflexive, transitive closure, $\Reduces$, whenever we want to describe a weak internal transition.
% Similarly, the $\Reduces$ multi-step reduction relation can be used wherever we want to describe a weak internal transition, which is merely the reflexive, transitive closure of the internal transition relation.




\paragraph*{Output transitions}




% Traditionally, these interactions would be described by the actions that label a transition.

% We say that $\octx$ sends messages $\atmL{\octx}_L$ and $\atmR{\octx}_R$ to its left- and right-hand surrounding when 


% A process configuration $\octx$ can interact with its surrounding environment along either (or both) of two interfaces

% Interactions [...]
Similar to our treatment of internal transitions, we do not adopt
% Rather than adopting
an explicit judgment for output interactions but instead make use of context equality. 
We say that the context $\octx$ outputs messages $\atmL{\octx}_L$ to the left and messages $\atmR{\octx}_R$ to the right exactly when $\octx = \atmL{\octx}_L \oc \octx' \oc \atmR{\octx}_R$ for some context $\octx'$.
This equality expresses an immediate, or strong, output of messages $\atmL{\octx}'_L$ and $\atmR{\octx}'_R$ from the context $\octx$.%
\footnote{It is roughly analogous to $\overset{x\langle y\rangle}{\reduces}$, the $\pi$-calculus's output transition relation.}
We will sometimes refer to the context $\octx'$ here as the \vocab{continuation context} because it represents the context that remains after the output of $\atmL{\octx}_L$ and $\atmR{\octx}_R$ occurs.

As an example, both $\atmL{a} \oc \atmL{b} \oc \n{C}$ and $\atmL{a} \oc \n{C} \oc \atmL{b}$ output $\atmL{a}$ to the left (and nothing to the right), but more precisely, the former outputs $\atmL{a} \oc \atmL{b}$, whereas the latter does not output $\atmL{b}$ at all.

In addition to immediate, or strong, output transitions, it is also typical in a labeled transition semantics to express eventual, or weak, output transitions.
A weak output transition consists of finitely many internal transitions, followed by a single strong output transition, along with finitely many internal transitions on the continuation.

In the $\pi$-calculus, the weak output transition relation is $\mathord{\overset{\smash{\bar{x}\langle y\rangle}}{\Reduces}} = \mathord{\overset{\smash{\tau}}{\Reduces}\overset{\smash{\bar{x}\langle y\rangle}}{\reduces}\overset{\smash{\tau}}{\Reduces}}$.
%
In the formula-as-process ordered rewriting framework, a weak output transition could be expressed by $\octx \Reduces \atmL{\octx}'_L \oc \octx'_0 \oc \atmR{\octx}'_R$ and $\octx'_0 \Reduces \octx'$ together -- the context $\octx$ eventually outputs $\atmL{\octx}'_L$ and $\atmR{\octx}'_R$ and eventually arrives at the continuation context $\octx'$.
Based on \cref{thm:formula-as-process:no-recapture-outputs}, we can more concisely express the same weak output transition as $\octx \Reduces \atmL{\octx}'_L \oc \octx' \oc \atmR{\octx}'_R$.
This is the form in which we will usually express weak output transitions.

\paragraph*{Input transitions}

Unlike internal and output transitions, 
we use an explicit judgment for input interactions.
The judgment $\ireduces{\atmR{\octx}_L \oc #1 \oc \atmL{\octx}_R}{\octx}{\octx'}$ indicates that, upon receiving messages $\atmR{\octx}_L$ from the left and $\atmL{\octx}_R$ from the right, the context $\octx$ may evolve to $\octx'$ in a single step.%
\footnote{It is roughly analogous to $\overset{x(y)}{\reduces}$, the $\pi$-calculus's input transition relation.}
In other words, for each such judgment there should be a corresponding reduction:
\begin{restatable}[
  name=Soundness,
  label=thm:formula-as-process:ireduces-soundness
]{theorem}{ireducessoundness}
  If $\ireduces{\atmR{\octx}_L \oc ##1 \oc \atmL{\octx}_R}{\octx}{\octx'}$, then $\atmR{\octx}_L \oc \octx \oc \atmL{\octx}_R \reduces \octx'$.
\end{restatable}

In terms of the judgment's input/output mode, $\octx$ is the sole input to the judgment, whereas it produces the contexts $\atmR{\octx}_L$, $\atmL{\octx}_R$, and $\octx'$ as outputs of the judgments.
Thus, the input transition judgment answers the question \enquote{What input messages suffice for $\octx$ to make a reduction?}

\newthought{As the notation} is intended to suggest, each input transition at its heart derives from focusing on a single negative proposition, $\n{A}$, as captured by the $\jrule{$[]{\reduces}$I}$ rule:%
\footnote{Notice that it is quite possible in this rule for both $\atmR{\octx}_L$ and $\atmL{\octx}_R$ to be empty and for the judgment to express the input of no messages at all.
But that happens only if $\n{A}$ has an $\up$ shift as its top-level connective.}
\begin{equation*}
  \infer[\jrule{$[]{\reduces}$I}]{\ireduces{\atmR{\octx}_L \oc #1 \oc \atmL{\octx}_R}{\n{A}}{\octx'}}{
    \lfocus{\atmR{\octx}_L}{\n{A}}{\atmL{\octx}_R}{\p{C}} &
    \rfocus{\octx'}{\p{C}}}
  \,.
\end{equation*}
Aside from the change of judgment in the rule's conclusion, this $\jrule{$[]{\reduces}$I}$ rule is identical to the core $\jrule{$\reduces$I}$ rule for reduction.
How can we claim that the input transition judgment is distinct from the reduction judgment?

The difference between the judgments is twofold.
First, and most importantly, this input transition differs from a reduction in terms of its input/output mode.
In a reduction $\atmR{\octx}_L \oc \n{A} \oc \atmL{\octx}_R \reduces \np{\octx'{}}$, the entire $\atmR{\octx}_L \oc \n{A} \oc \atmL{\octx}_R$ context is treated as an input to the reduction judgment, and $\octx'$ is treated as an output made by the judgment.
In the input transition $\ireduces{\atmR{\octx}_L \oc #1 \oc \atmL{\octx}_R}{\n{A}}{\np{\octx'{}}}$, on the other hand, only the proposition $\n{A}$ is treated as an input to the judgment, and the contexts $\atmR{\octx}_L$, $\atmL{\octx}_R$, and $\np{\octx'{}}$ are all treated as outputs made by the input transition judgment.

The second difference is that, unlike the reduction judgment, the input transition judgment is enriched with several other rules.
In addition to the core input transition rule, $\jrule{$[]{\reduces}$I}$, other compatibility rules exist.

Two of these rules allow the external inputs expected by an input transition to be (partially) satisfied internally by the context itself.
\begin{inferences}
  \infer[\jrule{$[\atmR{a}]$C}]{\ireduces{\atmR{\octx}_L \oc #1 \oc \atmL{\octx}_R}{\atmR{a} \oc \octx}{\octx'}}{
    \ireduces{\atmR{\octx}_L \oc \atmR{a} \oc #1 \oc \atmL{\octx}_R}{\octx}{\octx'} &
    \text{($\atmR{\octx}_L \neq (\octxe)$ or $\atmL{\octx}_R \neq (\octxe)$)}}
  \\
  \infer[\jrule{$[\atmL{a}]$C}]{\ireduces{\atmR{\octx}_L \oc #1 \oc \atmL{\octx}_R}{\octx \oc \atmL{a}}{\octx'}}{
    \ireduces{\atmR{\octx}_L \oc #1 \oc \atmL{a} \oc \atmL{\octx}_R}{\octx}{\octx'} &
    \text{($\atmR{\octx}_L \neq (\octxe)$ or $\atmL{\octx}_R \neq (\octxe)$)}}
\end{inferences}
For example, the $\jrule{$[\atmR{a}]$C}$ rule: if $\octx$ can reduce to $\octx'$ upon input of surrounding $\atmR{\octx}_L \oc \atmR{a}$ and $\atmL{\octx}_R$, then $\atmR{a} \oc \octx$ can reduce to $\octx'$ upon input of surrounding $\atmR{\octx}_L$ and $\atmL{\octx}_R$.
In other words, in the context $\atmR{a} \oc \octx$, the atom $\atmR{a}$ already, internally satisfies $\octx$'s demand for $\atmR{a}$.
The $\jrule{$[\atmL{a}]$C}$ rule is symmetric, involving $\atmL{a}$ on the right.
Algebraically, these two rules express a form of associativity.



Read top-down, these $\jrule{$[\atmR{a}]$C}$ and $\jrule{$[\atmL{a}]$C}$ rules allow an input message to be absorbed by an input transition.
In addition, the input transition judgment is equipped with several (limited) compatibility rules.
Instead of absorbing a message like the $\jrule{$[\atmR{a}]$C}$ and $\jrule{$[\atmL{a}]$C}$ rules do, these compatibility rules frame a message or process $\oante$ onto an input transition, passing $\oante$ through.\footnote{Recall from \cref{sec:formula-as-process:interpretation} that $\oante \Coloneqq \atmL{a} \mid \atmR{a} \mid \n{A}$.}
\begin{inferences}
   \infer[\jrule{$[\oante]$C}_1]{\ireduces{#1 \oc \atmL{\octx}_R}{\oante \oc \octx}{\oante \oc \octx'}}{
    \ireduces{#1 \oc \atmL{\octx}_R}{\octx}{\octx'}}
  \and
  \infer[\jrule{$[\oante]$C}_2]{\ireduces{\atmR{\octx}_L \oc #1}{\octx \oc \oante}{\octx' \oc \oante}}{
    \ireduces{\atmR{\octx}_L \oc #1}{\octx}{\octx'}}
\end{inferences}
Notice that these rules apply only to one-sided input transitions: $\octx$ must require no inputs at the side at which $\oante$ is added.
This is because these rules pass $\oante$ through the input transition unaffected, and so $\oante$ serves as an interaction barrier at the end at which it appears.

% \begin{inferences}
%    \infer{\ireduces{#1 \oc \atmL{\octx}_R}{\atmL{a} \oc \octx}{\atmL{a} \oc \octx'}}{
%     \ireduces{#1 \oc \atmL{\octx}_R}{\octx}{\octx'}}
%     \and
%    \infer{\ireduces{#1 \oc \atmL{\octx}_R}{\atmR{a} \oc \octx}{\atmR{a} \oc \octx'}}{
%     \ireduces{#1 \oc \atmL{\octx}_R}{\octx}{\octx'}}
%   \and
%    \infer{\ireduces{#1 \oc \atmL{\octx}_R}{\n{A} \oc \octx}{\n{A} \oc \octx'}}{
%     \ireduces{#1 \oc \atmL{\octx}_R}{\octx}{\octx'}}
%   \\
%   \infer{\ireduces{\atmR{\octx}_L \oc #1}{\octx \oc \atmL{a}}{\octx' \oc \atmL{a}}}{
%     \ireduces{\atmR{\octx}_L \oc #1}{\octx}{\octx'}}
%   \and
%   \infer{\ireduces{\atmR{\octx}_L \oc #1}{\octx \oc \atmR{a}}{\octx' \oc \atmR{a}}}{
%     \ireduces{\atmR{\octx}_L \oc #1}{\octx}{\octx'}}
%   \and
%   \infer{\ireduces{\atmR{\octx}_L \oc #1}{\octx \oc \n{A}}{\octx' \oc \n{A}}}{
%     \ireduces{\atmR{\octx}_L \oc #1}{\octx}{\octx'}}
% \end{inferences}

\begin{figure}[tbp]
  \begin{inferences}
    \infer[\jrule{$[]{\reduces}$C}]{\ireduces{\atmR{\octx}_L \oc #1 \oc \atmL{\octx}_R}{\n{A}}{\octx'}}{
      \lfocus{\atmR{\octx}_L}{\n{A}}{\atmL{\octx}_R}{\p{C}} &
      \rfocus{\octx'}{\p{C}}}
    \\
    \infer[\jrule{$[\atmR{a}]$C}]{\ireduces{\atmR{\octx}_L \oc #1 \oc \atmL{\octx}_R}{\atmR{a} \oc \octx}{\octx'}}{
      \ireduces{\atmR{\octx}_L \oc \atmR{a} \oc #1 \oc \atmL{\octx}_R}{\octx}{\octx'} &
      \text{($\atmR{\octx}_L \neq (\octxe)$ or $\atmL{\octx}_R \neq (\octxe)$)}}
    \and
    \infer[\jrule{$[\atmL{a}]$C}]{\ireduces{\atmR{\octx}_L \oc #1 \oc \atmL{\octx}_R}{\octx \oc \atmL{a}}{\octx'}}{
      \ireduces{\atmR{\octx}_L \oc #1 \oc \atmL{a} \oc \atmL{\octx}_R}{\octx}{\octx'} &
      \text{($\atmR{\octx}_L \neq (\octxe)$ or $\atmL{\octx}_R \neq (\octxe)$)}}
    \\
    \infer[\jrule{$[\oante]$C}_1]{\ireduces{#1 \oc \atmL{\octx}_R}{\oante \oc \octx}{\oante \oc \octx'}}{
    \ireduces{#1 \oc \atmL{\octx}_R}{\octx}{\octx'}}
  \and
  \infer[\jrule{$[\oante]$C}_2]{\ireduces{\atmR{\octx}_L \oc #1}{\octx \oc \oante}{\octx' \oc \oante}}{
    \ireduces{\atmR{\octx}_L \oc #1}{\octx}{\octx'}}
  \end{inferences}
  \caption{An input transition judgment}\label{fig:formula-as-process:ireduces}
\end{figure}

The full complement of input transition rules is summarized in \cref{fig:formula-as-process:ireduces}.
Now we may finally prove the previously stated claim of soundness for input transitions -- that each input transition has a corresponding reduction.
%
\ireducessoundness
\begin{proof}
  By induction on the structure of the given input transition.
\end{proof}


% \paragraph*{Internal transitions}

% In labeled transition systems for process calculi, there is usually a third kind of transition: the internal $\tau$-transition.
% In the $\pi$-calculus, these internal transitions coincide with the notion of reduction but are defined in such a way that the explicit and sometimes cumbersome structural congruence is not needed, thereby simplifying proofs.

% In our setting, we have no explicit structural congruence; the implicit monoid laws do not complicate proofs, so we can get away without defining a notion of internal $\tau$-transition.
% Wherever we want to describe an internal transition, the $\reduces$ reduction relation can be used instead.

Also, output and input transitions are together complete, in the sense that each reduction can be broken down into an input transition with complementary output transitions:
\begin{theorem}[Completeness]
%  If $\ireduces{\atmR{\octx}_L \oc #1 \oc \atmL{\octx}_R}{\octx}{\octx'}$, then $\atmR{\octx}_L \oc \octx \oc \atmL{\octx}_R \reduces \octx'$.
  % Conversely, if $\octx \reduces \octx'$, then there exist contexts $\octx_L$, $\atmR{\octx}_L$, $\atmL{\octx}_R$, $\octx_R$, and $\octx'_0$ and a proposition $\n{A}$ such that: $\octx = \octx_L \oc \atmR{\octx}_L \oc \n{A} \oc \atmL{\octx}_R \oc \octx_R$ and $\ireduces{\atmR{\octx}_L \oc #1 \oc \atmL{\octx}_R}{\n{A}}{\octx'_0}$ and $\octx' = \octx_L \oc \octx'_0 \oc \octx_R$.
%  $\ireduces{#1}{\octx}{\octx'}$.
%   and there exist contexts ... such that $\octx = \octx_L \oc \atmR{\lctx}_L \oc \octx_M \oc \atmL{\lctx}_R \oc \octx_R$ and $\octx' = \lctx_L \oc \octx'_M \oc \lctx_R$ and $\ireduces{\atmR{\lctx}_L \oc #1 \oc \atmL{\lctx}_R}{\octx_M}{\octx'_M}$.
% \\\\
%   If $\ireduces{\atmR{\octx}_L \oc #1 \oc \atmL{\octx}_R}{\octx}{\octx'}$, then $\octx = \octx'_L \oc \atmR{\octx}^*_L \oc \octx_0 \oc \atmL{\octx}^*_R \oc \octx'_R$ and $\ireduces{\atmR{\octx}_L \oc \atmR{\octx}^*_L \oc #1 \oc \atmL{\octx}^*_R \oc \atmL{\octx}_R}{\octx_0}{\octx'_0}$ and $\octx' = \octx'_L \oc \octx'_0 \oc \octx'_R$.
% \\\\
%   If $\octx \reduces \octx'$, then 
  If $\octx \reduces \octx'$, then there exist contexts $\octx'_L$, $\atmR{\octx}_L$, $\octx_0$, $\atmL{\octx}_R$, $\octx'_R$, and $\octx'_0$ such that: $\octx = (\octx'_L \oc \atmR{\octx}_L) \oc \octx_0 \oc (\atmL{\octx}_R \oc \octx'_R)$ and $\ireduces{\atmR{\octx}_L \oc #1 \oc \atmL{\octx}_R}{\octx_0}{\octx'_0}$ and $\octx' = \octx'_L \oc \octx'_0 \oc \octx'_R$.
\end{theorem}
\begin{proof}
  By induction on the structure of the given reduction.
\end{proof}
%
Together, these soundness and completeness results may also be thought of as establishing the admissibility and invertibility of the following rule. 
\begin{equation*}
  \infer-{\octx \reduces \octx'}{
    \octx = \octx_L \oc \lctx \oc \octx_R &
    \octx_L = \octx'_L \oc \atmR{\lctx}_L &
    \ireduces{\atmR{\lctx}_L \oc #1 \oc \atmL{\lctx}_R}{\lctx}{\lctx'} &
    \atmL{\lctx}_R \oc \octx'_R = \octx_R &
    \octx'_L \oc \lctx' \oc \octx'_R = \octx'}
\end{equation*}

We could also consider a notion of eventual, or weak, input transition, akin to the $\pi$-calculus's $\overset{\smash{x(y)}}{\Reduces}$ relation.
There is not an especially concise way to express weak input transitions using our notation for strong input transitions, and weak input transitions in and of themselves will not prove to be particularly useful to us, so we do not pursue them here.

% \begin{proof}
%   By induction on the structure of the given reduction.
  % , after first proving an easy lemma:
  % \begin{itemize}
  % \item If $\ireduces{\atmR{\octx}_L \oc #1 \oc \atmL{\octx}_R}{\octx}{\octx'}$, then $\ireduces{#1}{\atmR{\octx}_L \oc \octx \oc \atmL{\octx}_R}{\octx'}$.
  % \qedhere
  % \end{itemize}
  % $\octx'_L \oc \atmR{\octx}^*_L \oc \octx_0 \oc \atmL{\octx}^*_R \oc \octx'_R$ and $\ireduces{\atmR{\octx}^*_L \oc #1 \oc \atmL{\octx}^*_R \oc \atmL{\octx}_R}{\octx_0}{\octx'_0}$
% \end{proof}

\clearpage
\section{Choreographing string rewriting specifications}\label{sec:formula-as-process:choreographies}\label{sec:choreographies:choreographies}

So far in this \lcnamecref{ch:formula-as-process}, we have presented a formula-as-process refinement of the focused ordered rewriting framework and given it a local interaction semantics based on an implicit labeled transition system for output and input transitions.
With this local interaction semantics in hand, we can return to our goal of assigning a concrete operational semantics to string rewriting specifications.
We will show how to operationalize, or \emph{choreograph}, these specifications by embedding them within the formula-as-process ordered rewriting framework.

% Not all specifications can be choreographed, but 

To choreograph a string rewriting specification $(\sralph, \srsig)$, we would like to map each symbol $a \in \sralph$ to a proposition such that the string rewriting axioms $\srsig$ are mapped to derivable rewritings in our formula-as-process ordered rewriting framework.
In other words, to choreograph $(\sralph, \srsig)$, we would like to find a map $\theta$ from symbols to propositions and a signature $\orsig$ of coinductive definitions such that $\theta$ is a witness to the (strong) bisimilarity of string rewriting under the axioms $\srsig$ and formula-as-process ordered rewriting under the definitions $\orsig$.
That is, we would like to find a pair $(\theta, \orsig)$ for which we can complete the diagrams
\begin{equation*}
  \begin{tikzcd}
    w \rar[reduces, subscript=\srsig] \dar[relation][swap]{\theta}
      & w\mathrlap{'} \dar[relation, exists]{\theta}
    \\
    \octx \rar[reduces, exists, subscript=\orsig]
      & \octx\mathrlap{'}
  \end{tikzcd}
  \hphantom{'}
  \qquad\text{and}\qquad
  \begin{tikzcd}
    w \rar[reduces, exists, subscript=\srsig] \dar[relation][swap]{\theta}
      & w\mathrlap{'} \dar[relation, exists]{\theta}
    \\
    \octx \rar[reduces, subscript=\orsig]
      & \octx\mathrlap{' % = \theta(w') 
\,,}
  \end{tikzcd}
   \hphantom{' % = \theta(w')
 \,,}
\end{equation*}
where $\begin{tikzcd}[cramped, sep=small] w \rar[relation]{\smash{\theta}} & \octx \end{tikzcd}$ holds exactly when $\octx = \theta(w)$.
Only if the pair $(\theta, \orsig)$ satisfies these diagrams does it constitute a \emph{choreography} of the specification $(\sralph, \srsig)$.%
\footnote{An arbitrary pair $(\theta, \orsig)$ might be called a \emph{pre-choreography}.}

Because ordered rewriting in our formula-as-process framework permits only sensibly local interactions, we can be sure that the choreography $(\theta, \orsig)$ explains the \emph{how}, not just the what, of the concurrent system's dynamics.
The map $\theta$ is key to the how.
It 
% This map, $\theta$,
serves as a \emph{role assignment} for the string rewriting symbols, casting each symbol $a \in \sralph$ in the role of either a message, $\atmL{a}$ or $\atmR{a}$, or a coinductively defined process, $\defp{a}$.
(More formally, we will require that role assignments be injective monoid homomorphisms with this property.)

For a given specification, there will often be several role assignments that give rise to distinct choreographies, each one implying a different message-passing operationalization of the specification.
Without applying other, external criteria, no one choreography has more desirable lower-level behavior than another -- only the programmer is in a position to choose among choreographies.

Most of the $3^{\lvert\sralph\rvert}$ role assignments for a specification's alphabet do not lead to adequate choreographies.
Sometimes none of the possible role assignments produce a choreography.

\subsection{Choreographies by example}\label{sec:choreographies:informal}

% Given a string rewriting alphabet $\sralph$, we say that a (total) map $\theta$ from finite strings over $\sralph$ to ordered contexts is a \emph{role assignment} for $\sralph$ if it is an injective monoid homomorphism from the finite strings over $\sralph$ to ordered contexts that casts each symbol $a$ in the role of either a message, $\atmL{a}$ or $\atmR{a}$, or a coinductively defined process, $\defp{a}$.

Recall from \cref{ch:string-rewriting} the string rewriting specification $(\sralph, \srsig)$ of a system that can rewrite strings over $\sralph = \Set{a,b}$ into the empty string if the initial string ends in $b$.
\begin{equation*}
  \begin{lgathered}
    \sralph = \Set{a,b} \\
    \srsig = (a \wc \reduces b) \,, (b \reduces \emp)
  \end{lgathered}
\end{equation*}

Let $\theta$ be the injective monoid homomorphism generated by mapping $a$ to the right-directed message $\atmR{a}$ and $b$ to the coinductively defined process $\defp{b}$.%
\marginnote{$\theta = \Set{ a \mapsto \atmR{a} , b \mapsto \defp{b} }$}
The map $\theta$ is indeed a role assignment, but does it yield a meaningful choreography for the specification $(\sralph, \srsig)$?

We must determine if $\defp{b}$ can be given a definition $\orsig = (\defp{b} \defd \n{B})$ such that the above, strong bisimulation diagrams can be completed.
Because $\theta$ is injective, those diagrams are equivalent to the following ones:
In the first diagram, the right-hand edge $\begin{tikzcd}[cramped, sep=small] w' \rar[relation, exists]{\smash{\theta}} & \octx' \end{tikzcd}$ can be replaced with $\begin{tikzcd}[cramped, sep=small] w' \rar[relation]{\smash{\theta}} & \theta(w') \end{tikzcd}$, but we cannot make a similar replacement for the second diagram because $\theta$ is not bijective, only injective.
\begin{equation*}
  \begin{tikzcd}
    w \rar[reduces, subscript=\srsig] \dar[relation][swap]{\theta}
      & w\mathrlap{'} \dar[relation]{\theta}
    \\
    \theta(w) \rar[reduces, exists, subscript=\orsig]
      & \theta(w')
  \end{tikzcd}
  \qquad\text{and}\qquad
  \begin{tikzcd}
    w \rar[reduces, exists, subscript=\srsig] \dar[relation][swap]{\theta}
      & w\mathrlap{'}
      \dar[relation, exists]{\theta}
    \\
    \theta(w) \rar[reduces, subscript=\orsig]
      & \octx\mathrlap{' \,.} % = \theta(w') \,.}
  \end{tikzcd}
  \hphantom{' \,.}
\end{equation*}


The first diagram gives us a way forward to a choreography: for each axiom $(w \reduces w') \in \srsig$, the rewriting $\theta(w) \reduces_{\orsig} \theta(w')$ must be derivable under the definitions $\orsig$.
In other words, these rewritings serve as constraints upon the definitions $\orsig$ that must be fulfilled if $(\theta, \orsig)$ is to be a meaningful choreography for the specification $(\sralph, \srsig)$.

In this example, the axioms $a \wc b \reduces b$ and $b \reduces \emp$ induce the constraints
\begin{equation*}
  \begin{tikzcd}[cramped]
    \atmR{a} \oc \defp{b} \rar[reduces, exists, subscript=\orsig] & \defp{b}
  \end{tikzcd}
  \qquad\text{and}\qquad
  \begin{tikzcd}[cramped]
    \defp{b} \rar[reduces, exists, subscript=\orsig] & (\octxe)
  \end{tikzcd}
  \,.
\end{equation*}
\begin{marginfigure}
\begin{equation*}
  \begin{tikzcd}
    a \wc b \arrow[reduces, subscript=\srsig]{rrr} \dar[relation][swap]{\theta}
      &[-2.4em] &&[-2.4em] b \dar[relation]{\theta}
    \\
    \theta(a \wc b) & = \atmR{a} \oc \defp{b} \rar[reduces, exists, subscript=\orsig]
      & \defp{b} = & \theta(b)
  \end{tikzcd}
\end{equation*}
\begin{equation*}
\begin{tikzcd}
    b \arrow[reduces, subscript=\srsig]{rrr} \dar[relation][swap]{\theta}
      &[-2.4em] &&[-2.4em] \emp \dar[relation]{\theta}
    \\
    \theta(b) & = \defp{b} \rar[reduces, exists, subscript=\orsig]
      & (\octxe) = & \theta(\emp)
  \end{tikzcd}
\end{equation*}
\caption{Axioms induce rewritings as constraints on a choreography}\label{fig:formula-as-process:induced-constraints}
\end{marginfigure}%
Well, a definition $\defp{b} \defd \atmR{a} \limp \up \dn \defp{b}$ would satisfy the first constraint but not the second, because $\atmR{a} \oc \defp{b} = \atmR{a} \oc (\atmR{a} \limp \up \dn \defp{b}) \reduces_{\orsig} \defp{b}$.
And a definition $\defp{b} \defd \up \one$ would satisfy the second constraint but not the first, because $\defp{b} = \up \one \reduces_{\orsig} (\octxe)$.
Fortunately, we can form a kind of greatest lower bound of these definitions using alternative conjunction%
\footnote{This is possible because the left-focus rule for alternative conjunction preserves focus.}%
: the definition $\defp{b} \defd (\atmR{a} \limp \up \dn \defp{b}) \with \up \one$ satisfies \emph{both} constraints,
\begin{equation*}
  \atmR{a} \oc \defp{b} = \atmR{a} \oc ((\atmR{a} \limp \up \dn \defp{b}) \with \up \one) \reduces_{\orsig} \defp{b}
  \qquad\text{and}\qquad
  \defp{b} = (\atmR{a} \limp \up \dn \defp{b}) \with \up \one \reduces_{\orsig} (\octxe)
  \,.
\end{equation*}
And the second diagram holds because of the universal properties of the logical connectives.

\newthought{Not all role assignments} yield meaningful choreographies, however.
This happens when there is no solution to the constraints on $\orsig$ induced by the axioms and chosen role assignment.
For a set of constraints to be satisfiable, three conditions must hold.
\begin{itemize}
\item
  \emph{Each induced rewriting must have at least one process in its premise.}
  In the above example, for instance, role assignments $\theta'$ such that either $b \mapsto \atmL{b}$ or $b \mapsto \atmR{b}$ do not yield meaningful choreographies.
  Under such assignments, the axiom $b \reduces_{\srsig} \emp$ induces either $\ereduces[\orsig']{\atmL{b}}{(\octxe)}$ or $\ereduces[\orsig']{\atmR{b}}{(\octxe)}$ as constraints.
  There are, however, no definitions that satisfy either constraint because the formula-as-process framework has no rules that permit an atom alone to be rewritten: messages are passive objects.

\item
  \emph{Each induced rewriting must have at most one process in its premise.}
  In the above example, for instance, the role assignment $\theta'$ such that $a \mapsto \defp{a}$ and $b \mapsto \defp{b}$ does not yield a meaningful choreography.
  The axiom $a \wc b \reduces b$ induces the constraint $\ereduces[\orsig']{\defp{a} \oc \defp{b}}{\defp{b}}$.
  There are, however, no definitions for $\defp{a}$ and $\defp{b}$ that satisfy this constraint because the formula-as-process framework proscribes implications from having non-atomic premises: a process can input only messages, not other processes.

\item
  \emph{Each message in a premise must be directed inward, toward the premise's process.}
  In the above example, for instance, the role assignment $\theta'$ such that $a \mapsto \atmL{a}$ and $b \mapsto \defp{b}$ does not yield a meaningful choreography.
  The axiom $a \wc b \reduces b$ induces the constraint $\ereduces[\orsig']{\atmL{a} \oc \defp{b}}{\defp{b}}$.
  There is, however, no defintion for $\defp{b}$ that satisfies this constraint because the formula-as-process framework requires that implications have atomic premises of \emph{complementary} direction: a process can only receive messages intended for itself.
\end{itemize}

More generally, these observations suggest that only constraints of the form $\ereduces[\orsig]{\atmR{\octx}_L \oc \defp{a} \oc \atmL{\octx}_R}{\octx'}$ are satisfiable, and that these constraints are induced by axioms of the form $w_1 \wc a \wc w_2 \reduces w'$.
In the following \lcnamecref{sec:formula-as-process:choreograph-formal}, we leverage these ideas to present a more formal description of the above procedure for choreographing string rewriting specifications within the formula-as-process ordered rewriting framework.

\subsection{A formal description of choreographing specifications}\label{sec:formula-as-process:choreograph-formal}\label{sec:choreographies:choreograph-formal}

To give a formal description of choreographing specifications, we define a judgment $\chorsig{\theta}{\srsig}{\orsig}$ that, when given a string rewriting specification $(\sralph, \srsig)$ and a role assignment $\theta$, yields formula-as-process definitions $\orsig$ that make string rewriting under $\srsig$ and formula-as-process ordered rewriting under $\orsig$ bisimilar, if such definitions exist:
% \begin{equation*}
%   ??
% \end{equation*}
% This principal judgment also relies on an auxiliary judgment, $?$.
% 
\begin{equation*}
  \chorsig{\theta}{\srsig}{\orsig}
  \quad\text{only if}\enspace
  \begin{tikzcd}
    w \rar[reduces, subscript=\srsig] \dar[relation][swap]{\theta}
     & w\mathrlap{'} \dar[relation]{\theta}
    \\
    \theta(w) \rar[reduces, exists, subscript=\orsig]
     & \theta(w')
  \end{tikzcd}
  \hphantom{'}
  \enspace\text{and}\quad
  \begin{tikzcd}
    w \rar[reduces, exists, subscript=\srsig] \dar[relation][swap]{\theta}
     & w\mathrlap{'}
         \dar[relation, exists]{\theta}
    \\
    \theta(w) \rar[reduces, subscript=\orsig]
     & \octx\mathrlap{' \,.% \footnote{Once again, the injectivity of $\theta$ simplifies these diagrams.}
}
  \end{tikzcd}
  \hphantom{' \,.}
\end{equation*}
Stated differently, the judgment will be such that the following adequacy result will hold: \enquote{If $\chorsig{\theta}{\srsig}{\orsig}$, then $\theta(w) \reduces_{\orsig} \octx'$ if, and only if, there exists a string $w'$ such that $w \reduces_{\srsig} w'$ and $\theta(w') = \octx'$.}

This principal judgment
% is $\chorsig{\theta}{\srsig}{\orsig}$, and it
also relies on an auxiliary elaboration judgment, $\qimp{\atmR{\octx}_L}{\up \p{A}}{\atmL{\octx}_R}{\n{B}}$, which we describe first.
% Before giving the rules for the principal judgment, we will [...].

\newthought{The auxiliary judgment} $\qimp{\atmR{\octx}_L}{\up \p{A}}{\atmL{\octx}_R}{\n{B}}$ elaborates the quasi-propo\-si\-tion $\atmR{\octx}_L \limp \up \p{A} \pmir \atmL{\octx}_R$ into a well-formed proposition $\n{B}$ by nondeterministically abstracting one-by-one from either the left or right contexts.%
\footnote{This procedure could be made deterministic by preferring one side over the other, but we refrain from doing so because the choice of side to prefer is completely arbitrary.}
This proposition $\n{B}$ is semantically equivalent to the quasi-proposition $\atmR{\octx}_L \limp \up \p{A} \pmir \atmL{\octx}_R$ in the sense that the two intuitively satisfy the \enquote{same} left-focus judgments:
% $\n{B}$ satisfies $\atmR{\octx}_L \oc \n{B} \oc \atmL{\octx}_R \reduces \octx'$ if, and only if, $\rfocus{\octx'}{\p{A}}$.
We would expect the quasi-proposition to satisfy $\lfocus{\atmR{\octx}_L}{\atmR{\octx}_L \limp \up \p{A} \pmir \atmL{\octx}_R}{\atmL{\octx}_R}{\p{A}}$, and indeed, when $\qimp{\atmR{\octx}_L}{\up \p{A}}{\atmL{\octx}_R}{\n{B}}$, we have
$\lfocus{\atmR{\lctx}_L}{\n{B}}{\atmL{\lctx}_R}{\p{C}}$ if, and only if, $\atmR{\lctx}_L = \atmR{\octx}_L$ and $\atmL{\lctx}_R = \atmL{\octx}_R$ and $\p{C} = \p{A}$.
This is proved below as \cref{lem:qimp-correct}.

This auxiliary judgment is defined inductively by the following rules.
\begin{inferences}
  \infer[\jrule{$\up$EL}]{\qimp{(\octxe)}{\up \p{A}}{(\octxe)}{\up \p{A}}}{}
  \\
  \infer[\jrule{$\limp$EL}]{\qimp{(\atmR{\octx}_L \oc \atmR{a})}{\up \p{A}}{\atmL{\octx}_R}{\atmR{a} \limp \n{B}}}{
    \qimp{\atmR{\octx}_L}{\up \p{A}}{\atmL{\octx}_R}{\n{B}}}
  \and
  \infer[\jrule{$\pmir$EL}]{\qimp{\atmR{\octx}_L}{\up \p{A}}{(\atmL{a} \oc \atmL{\octx}_R)}{\n{B} \pmir \atmL{a}}}{
    \qimp{\atmR{\octx}_L}{\up \p{A}}{\atmL{\octx}_R}{\n{B}}}
\end{inferences}
The $\jrule{$\limp$EL}$ rule states that the quasi-proposition $(\atmR{\octx}_L \oc \atmR{a}) \limp \up \p{A} \pmir \atmL{\octx}_R$ is equivalent to $\atmR{a} \limp \n{B}$ if $\atmR{\octx}_L \limp \up \p{A} \pmir \atmL{\octx}_R$ is equivalent to $\n{B}$.
Notice that the $\jrule{$\limp$EL}$ rule moves $\atmR{a}$ from the right of $\atmR{\octx}_L$ to the left of $\n{B}$;
this is admittedly counterintuitive, but it is closely related to the equally counterintuitive currying law for left-handed implication in ordered logic:
% Likewise, the quasi-proposition $\atmR{\octx}_L \limp \up \p{A} \pmir (\p{\atmL{a}} \oc \atmL{\octx}_R)$ is equivalent to $(\atmR{\octx}_L \limp \up \p{A} \pmir \atmL{\octx}_R) \pmir \p{\atmL{a}}$.
$(B \fuse A) \limp C \dashv\vdash A \limp (B \limp C)$.
Symmetrically, the $\jrule{$\pmir$EL}$ rule is closely related to the currying law for right-handed implication: $C \pmir (A \fuse B) \dashv\vdash (C \pmir B) \pmir A$.

This intuition is captured in the proof of the following \lcnamecref{lem:qimp-correct}.
\begin{lemma}\label{lem:qimp-correct}
  % If $\chorax{\theta}{w_1}{\p{C}}{w_2}{\n{B}}$, then $\lfocus{\theta(w_1)}{\n{B}}{\theta(w_2)}{\p{C}}$.
  If $\qimp{\atmR{\octx}_L}{\up \p{A}}{\atmL{\octx}_R}{\n{B}}$, then $\lfocus{\atmR{\lctx}_L}{\n{B}}{\atmL{\lctx}_R}{\p{C}}$ if, and only if, $\atmR{\lctx}_L = \atmR{\octx}_L$ and $\atmL{\lctx}_R = \atmL{\octx}_R$ and $\p{C} = \p{A}$.
  %
  % Moreover, if $\qimp{\atmR{\octx}_L}{\up \p{A}}{\atmL{\octx}_R}{\n{B}}$, then $\atmR{\lctx}_L \oc \n{B} \oc \atmL{\lctx}_R \reduces \lctx'$ if, and only if, there exist contexts $\atmR{\lctx}'_L$, $\lctx'_0$, and$\atmL{\lctx}'_R$ such that $\atmR{\lctx}'_L \oc \atmR{\octx}_L = \atmR{\lctx}_L$ and $\atmL{\octx}_R \oc \atmL{\lctx}'_R = \atmL{\lctx}_R$ and $\rfocus{\lctx'_0}{\p{A}}$ and $\lctx' = \atmR{\lctx}'_L \oc \lctx'_0 \oc \atmL{\lctx}'_R$.
\end{lemma}
\begin{proof}
  By induction over the structure of the given elaboration.

  As an example case, consider
  % \begin{itemize}
  % \item Consider the case in which
  %   \begin{equation*}
  %     \infer{\chorax{\theta}{\emp}{\p{A}}{\emp}{\up \p{A}}}{}
  %     \,.
  %   \end{equation*}
  %   We must show that $\lfocus{\atmR{\octx}_L}{\up \p{A}}{\atmL{\octx}_R}{\p{C}}$ if, and only if, $\atmR{\octx}_L = \atmL{\octx}_R = \theta(\emp)$ and $\p{A} = \p{C}$.
  %   Indeed, the $\lrule{\up}$ rule is the unique rule for left-focusing on $\up \p{A}$, and $\octxe = \theta(\emp)$ because $\theta$ is a monoid homomorphism.
  % 
  % \item Consider the case in which
    \begin{equation*}
      \infer[\jrule{$\limp$EL}]{\qimp{(\atmR{\octx}_L \oc \p{\atmR{a}})}{\up \p{A}}{\atmL{\octx}_R}{\p{\atmR{a}} \limp \n{B}}}{
        \qimp{\atmR{\octx}_L}{\up \p{A}}{\atmL{\octx}_R}{\n{B}}}
      \,.
    \end{equation*}
    We must show that $\lfocus{\atmR{\lctx}_L}{\p{\atmR{a}} \limp \n{B}}{\atmL{\lctx}_R}{\p{C}}$ if, and only if, $\atmR{\lctx}_L = \atmR{\octx}_L \oc \p{\atmR{a}}$ and $\atmL{\lctx}_R = \atmL{\octx}_R$ and $\p{C} = \p{A}$.
    Indeed, the $\lrule{\limp}$ rule is the unique rule for left-focusing on the proposition $\p{\atmR{a}} \limp \n{B}$, so $\lfocus{\atmR{\lctx}_L}{\p{\atmR{a}} \limp \n{B}}{\atmL{\lctx}_R}{\p{C}}$ if, and only if, $\atmR{\lctx}_L = \atmR{\lctx}'_L \oc \p{\atmR{a}}\!\!$ and $\lfocus{\atmR{\lctx}'_L}{\n{B}}{\atmL{\lctx}_R}{\p{C}}$ for some $\atmR{\lctx}'_L$.
    By the inductive hypothesis, we have $\lfocus{\atmR{\lctx}'_L}{\n{B}}{\atmL{\lctx}_R}{\p{C}}$ if, and only if, $\atmR{\lctx}'_L = \atmR{\octx}_L$ and $\atmL{\lctx}_R = \atmL{\octx}_R$ and $\p{C} = \p{A}$.
    Putting everything together, $\lfocus{\atmR{\lctx}_L}{\p{\atmR{a}} \limp \n{B}}{\atmL{\lctx}_R}{\p{C}}$ if, and only if, $\atmR{\lctx}_L = \atmR{\octx}_L \oc \p{\atmR{a}}$ and $\atmL{\lctx}_R = \atmL{\octx}_R$ and $\p{C} = \p{A}$, as required.
  % 
  % \item
  %   The case in which
  % \begin{equation*}
  %   \infer{\chorax{\theta}{w_1}{\p{A}}{b \oc w_2}{\n{B} \pmir \atmL{b}}}{
  %     \chorax{\theta}{w_1}{\p{A}}{w_2}{\n{B}} &
  %     \text{($\theta(b) = \atmL{b}$)}}
  % \end{equation*}
  %   is symmtric to the previous one.
  % %
  % \qedhere
  % \end{itemize}
\end{proof}



\newthought{The principal judgment} is $\chorsig{\theta}{_{\sralph} \srsig}{\orsig}$.%
\footnote{Because the alphabet $\sralph$ never changes within a derivation, we nearly always elide it.}
Given a string rewriting specification $(\sralph, \srsig)$ and a role assignment $\theta$, this judgment produces formula-as-process definitions $\orsig$ that, together with $\theta$, constitute a choreography of $(\sralph, \srsig)$.
%
In other words, when $\chorsig{\theta}{_{\sralph} \srsig}{\orsig}$ holds, the definitions $\orsig$ are a solution to the constraints induced by axioms $\srsig$ under the role assignment $\theta$, such that $\theta$ is a (strong) bisimulation between $\reduces_{\srsig}$ and $\reduces_{\orsig}$.%
\marginnote{%
  \begin{tabular}{@{}c@{}}
    $\chorsig{\theta}{\srsig}{\orsig}$
    \\only if\\
    $\!
  \begin{tikzcd}[ampersand replacement=\&]
    w \rar[reduces, subscript=\srsig] \dar[relation][swap]{\theta}
     \& w\mathrlap{'} \dar[relation]{\theta}
    \\
    \theta(w) \rar[reduces, exists, subscript=\orsig]
     \& \theta(w')
  \end{tikzcd}
  $and$
  \begin{tikzcd}[ampersand replacement=\&]
    w \rar[reduces, exists, subscript=\srsig] \dar[relation][swap]{\theta}
     \& w\mathrlap{'} \dar[relation, exists]{\theta}
    \\
    \theta(w) \rar[reduces, subscript=\orsig]
     \& \octx \mathrlap{'}
  \end{tikzcd}\hphantom{'}
  $
  \end{tabular}}%
% \footnote{%
%   Actually, we end up proving a stronger soundness result in \cref{??}.}
% The exact converse -- that $\theta(w) \reduces_{\orsig} \theta(w')$ implies $w \reduces_{\srsig} w'$ -- does hold, but we can prove an even stronger soundness result.
%
If there is no $\orsig$ for which $\chorsig{\theta}{_{\sralph} \srsig}{\orsig}$ holds, then the role assignment $\theta$ yields no choreography of the specification $(\sralph, \srsig)$.

% This judgment relies on an auxiliary judgment, $\qimp{\atmR{\octx}_L}{\up \p{A}}{\atmL{\octx}_R}{\n{B}}$, that transforms the quasi-proposition $\atmR{\octx}_L \limp \up \p{A} \pmir \atmL{\octx}_R$ into a well-formed proposition $\n{B}$ by nondeterministically abstracting atoms one-by-one from either the left or right contexts.
% The proposition $\n{B}$ is semantically equivalent to the quasi-proposition $\atmR{\octx}_L \limp \up \p{A} \pmir \atmL{\octx}_R$ in the sense that $\n{B}$ satisfies $\atmR{\octx}_L \oc \n{B} \oc \atmL{\octx}_R \reduces \octx'$ if, and only if, $\rfocus{\octx'}{\p{A}}$.

This principal choreographing judgment is defined by just two rules:
\begin{gather*}
  \infer{\chorsig{\theta}{\srsige}{\orsige}}{}
  \\
  \infer{\chorsig{\theta}{\srsig_0, \bigl(w^L_i \wc a \wc w^R_i \reduces w'_i\bigr)_{i \in \mathcal{I}}}{\orsig_0, \bigl(\defp{a} \defd \bigwith_{i \in \mathcal{I}} \n{A}_i\bigr)}}{
    \begin{array}[b]{@{}c@{}}
      \text{($\theta(a) = \defp{a}$)} \quad
      \chorsig{\theta}{\srsig_0}{\orsig_0} \quad
      \text{($\defp{a} \notin \dom{\orsig_0}$)}
      \\
      \multipremise{i \in \mathcal{I}}{
        \text{$\bigl(\theta(w^L_i) = \atmR{\octx}^L_i\bigr)$} \quad
        \text{$\bigl(\theta(w^R_i) = \atmL{\octx}^R_i\bigr)$} \quad
        \qimp{\atmR{\octx}^L_i}{\up \bigfuse \theta(w'_i)}{\atmL{\octx}^R_i}{\n{A}_i}}
    \end{array}}
\end{gather*}
The first of these rules is straightforward: an empty set of string rewriting axioms choreographs as an empty set of coinductive formula-as-process definitions.
The second rule is quite a lot to parse and needs to be broken down step by step:
\begin{enumerate}
\item
  Choose a symbol $a$ that is mapped by $\theta$ to a coinductively defined proposition, $\defp{a}$.
  Then reorganize the axioms $\srsig$, collecting together all axioms in $\srsig$ that have an $a$ in their premises.
  Let $\bigl(w^L_i \wc a \wc w^R_i \reduces w'_i\bigr)_{i \in \mathcal{I}}$ be those axioms, so that $\srsig = \srsig_0 , \bigl(w^L_i \wc a \wc w^R_i \reduces w'_i\bigr)_{i \in \mathcal{I}}$ for some $\srsig_0$.
\item
  Inductively construct definitions $\orsig_0$ from $\srsig_0$ and $\theta$, using the judgment $\chorsig{\theta}{\srsig_0}{\orsig_0}$.
  Check that $\orsig_0$ gives no definition for $\defp{a}$, otherwise there is some axiom in $\srsig_0$ that contains $a$ in its premise and $\bigl(w^L_i \wc a \wc w^R_i \reduces w'_i\bigr)_{i \in \mathcal{I}}$ does not correctly constitute all such axioms.
\item
  Check, using the side condition $\theta(w^L_i) = \atmR{\octx}^L_i$, that each $w^L_i$ contains only those symbols that map to right-directed atoms.
  Symmetrically, check, using the side condition $\theta(w^R_i) = \atmL{\octx}^R_i$, that each $w^R_i$ contains only symbols that map to left-directed atoms.
\item
  Elaborate each quasi-proposition $\atmR{\octx}^L_i \limp \up \bigfuse \theta(w'_i) \pmir \atmL{\octx}^R_i$ into a semantically equivalent proposition $\n{A}_i$.
  Based on \cref{lem:qimp-correct}, the left-focus judgment $\lfocus{\theta(w^L_i)}{\n{A}_i}{\theta(w^R_i)}{\bigfuse \theta(w'_i)}$ holds, and so this proposition acts as the image of the axiom $w^L_i \wc a \wc w^R_i \reduces w'_i$ under the role assignment $\theta$ -- that is, $\theta(w^L_i) \oc \n{A}_i \oc \theta(w^R_i) \reduces \theta(w'_i)$.
\item
  Collect the $\n{A}_i$s into a single definition, $\defp{a} \defd \bigwith_{i \in \mathcal{I}} \n{A}_i$, which, based on steps 2, 3, and 4, describes all of the axioms from $\srsig$ that contain $a$ in their premises -- that is, $\theta(w^L_i) \oc \defp{a} \oc \theta(w^R_i) \reduces_{\Set{\defp{a} \defd \with_{i \in \mathcal{I}} \n{A}_i}} \theta(w'_i)$.
\end{enumerate}

We shall now prove that this judgment produces definitions $\orsig$ that constitute a formula-as-process choreography $(\theta, \orsig)$ of the string rewriting specification $(\sralph, \srsig)$ -- that is, that $\chorsig{\theta}{\srsig}{\orsig}$ implies that $\theta$ is a (strong) bisimulation between $\reduces_{\srsig}$ and $\reduces_{\orsig}$.
As previously mentioned, because $\theta$ is injective, this amounts to proving that
\begin{equation*}
  \chorsig{\theta}{\srsig}{\orsig}
  \quad\text{only if}\enspace
  \begin{tikzcd}
    w \rar[reduces, subscript=\srsig] \dar[relation][swap]{\theta}
      & w\mathrlap{'} \dar[relation]{\theta}
    \\
    \theta(w) \rar[reduces, exists, subscript=\orsig] & \theta(w')
  \end{tikzcd}
  \enspace\text{and}\quad
  \begin{tikzcd}
    w \rar[reduces, exists, subscript=\srsig] \dar[relation][swap]{\theta}
      & w\mathrlap{'} \dar[relation, exists]{\theta}
    \\
    \theta(w) \rar[reduces, subscript=\orsig] & \octx \mathrlap{' \,.}
  \end{tikzcd}
  \hphantom{' \,.}
\end{equation*}
% As stated earlier, when $\chorsig{\theta}{\srsig}{\orsig}$, the string rewriting step $w \reduces_{\srsig} w'$ holds if, and only if, the ordered rewriting step $\theta(w) \reduces_{\orsig} \theta(w')$ holds.
We prove the first diagram as the following completeness \lcnamecref{thm:formula-as-process:choreograph-completeness} and then prove a stronger soundness \lcnamecref{thm:formula-as-process:choreograph-soundness} that implies the second diagram.

\begin{lemma}[Definition weakening]\label{lem:formula-as-process:definition-weakening}
  If $\octx \reduces_{\orsig} \octx'$ and $\dom{\orsig} \cap \dom{\orsig'} = \emptyset$, then $\octx \reduces_{\orsig, \orsig'} \octx'$.
  % Similarly, if $\octx \reduces_{\orsig, (\defp{a} \defd \n{A})} \octx'$ or $\octx \reduces_{\orsig, (\defp{a} \defd \n{B})} \octx'$, then $\octx \reduces_{\orsig, (\defp{a} \defd \n{A} \with \n{B})} \octx'$.
\end{lemma}
\begin{proof}
  By induction over the structure of the given rewriting step.
\end{proof}

% \begin{lemma}
%   If $(w \reduces w') \in \srsig$ and $\chorsig{\theta}{\srsig}{\orsig}$, then $\theta(w) \reduces_{\orsig} \theta(w')$.
% \end{lemma}
% \begin{proof}
%   By induction over the structure of the given choreographing derivation, $\chorsig{\theta}{\srsig}{\orsig}$.
%   \begin{itemize}
%   \item Consider the case in which $w = w_1 \oc a \oc w_2 \reduces w'$ is the axiom in question and
%     \begin{equation*}
%       \infer{\chorsig{\theta}{\srsig, w_1 \oc a \oc w_2 \reduces w'}{\orsig, \defp{a} \defd \n{A} \with \n{B}}}{
%         \text{($\theta(a) = \defp{a}$)} &
%         \chorax{\theta}{w_1}{\bigfuse \theta(w')}{w_2}{\n{B}} &
%         \chorsig{\theta}{\srsig}{\orsig, \defp{a} = \n{A}}}
%     \end{equation*}
%     It follows from \cref{??} that $\lfocus{\theta(w_1)}{\n{B}}{\theta(w_2)}{\bigfuse \theta(w')}$, and hence $\lfocus{\theta(w_1)}{\n{A} \with \n{B}}{\theta(w_2)}{\bigfuse \theta(w')}$.
%     And because $\rfocus{\theta(w')}{\bigfuse \theta(w')}$ and $\defp{a} \defd \n{A} \with \n{B}$, we have $\theta(w) = \theta(w_1) \oc \defp{a} \oc \theta(w_2) \reduces \theta(w')$.
  
%   \item Consider the case in which
%     \begin{equation*}
%       \infer{\chorsig{\theta}{\sig, v_1 \oc a \oc v_2 \reduces v'}{\sig', \hat{a} \defd \n{A} \with \n{B}}}{
%         \text{($\theta(a) = \hat{a}$)} &
%         \chorax{\theta}{v_1}{\bigfuse \theta(v')}{v_2}{\n{B}} &
%         \chorsig{\theta}{\sig}{\sig'} &
%         \text{($\sig'(\hat{a}) = \n{A}$)}}
%     \end{equation*}
%     and the axiom $w \reduces w'$ comes from $\sig$.
%     By the inductive hypothesis, $\theta(w) \reduces_{\sig'} \theta(w')$.
%     By \cref{??}, $\theta(w) \reduces_{\sig', \hat{a} \defd \n{A} \with \n{B}} \theta(w')$.
  
%   \item Consider the case in which
%     \begin{equation*}
%       \infer{\chorsig{\theta}{\sig, v_1 \oc a \oc v_2 \reduces v'}{\sig', \hat{a} \defd \n{B}}}{
%         \text{($\theta(a) = \hat{a}$)} &
%         \chorax{\theta}{v_1}{\bigfuse \theta(v')}{v_2}{\n{B}} &
%         \chorsig{\theta}{\sig}{\sig'} &
%         \text{($\hat{a} \notin \dom{\sig'}$)}}
%     \end{equation*}
%     and the axiom $w \reduces w'$ comes from $\sig$.
%     By the inductive hypothesis, $\theta(w) \reduces_{\sig'} \theta(w')$.
%     By \cref{??}, $\theta(w) \reduces_{\sig', \hat{a} \defd \n{B}} \theta(w')$.
%   %
%   \qedhere
%   \end{itemize}
% \end{proof}

\begin{theorem}\label{thm:formula-as-process:choreograph-completeness}\leavevmode
  If $\chorsig{\theta}{\srsig}{\orsig}$, then $w \reduces_{\srsig} w'$ implies $\theta(w) \reduces_{\orsig} \theta(w')$.%
  \marginnote{%
    \begin{tabular}{@{}c@{}}
      $\chorsig{\theta}{\srsig}{\orsig}$
      \\only if\\
    \begin{tikzcd}[ampersand replacement=\&]
      w \rar[reduces, subscript=\srsig] \dar[relation][swap]{\theta}
       \& w\mathrlap{'} \dar[relation]{\theta}
      \\
      \theta(w) \rar[reduces, exists, subscript=\orsig]
       \& \theta(w')
    \end{tikzcd}
    \end{tabular}}%
\end{theorem}
\begin{proof}
  By simultaneous structural induction on the given choreographing derivation, $\chorsig{\theta}{\srsig}{\orsig}$, and ordered rewriting step, $w \reduces_{\srsig} w'$.
  \begin{itemize}[listparindent=\parindent, itemsep=\dimexpr\itemsep+\parsep\relax, parsep=0pt]
  \item
    Consider the case in which
    \begin{equation*}
      \chorsig{\theta}{\srsig}{\orsig}
      \qquad\text{and}\qquad
      w =
      \infer[\jrule{$\reduces$C}]{w_1 \wc w_0 \wc w_2 \reduces_{\srsig} w_1 \wc w'_0 \wc w_2}{
        w_0 \reduces_{\srsig} w'_0}
      = w'
      \,.
    \end{equation*}
    By the inductive hypothesis, $\theta(w_0) \reduces_{\orsig} \theta(w'_0)$.
    It follows from ordered rewriting's $\jrule{$\reduces$C}$ rule that
    \begin{equation*}
      \theta(w) = \theta(w_1) \oc \theta(w_0) \oc \theta(w_2) \reduces_{\orsig} \theta(w_1) \oc \theta(w'_0) \oc \theta(w_2) = \theta(w')
      \,.
    \end{equation*}

  \item
    Consider the case in which
    \begin{gather*}
      \infer{\chorsig{\theta}{\srsig_0, \bigl(w^L_i \wc a \wc w^R_i \reduces w'_i\bigr)_{i \in \mathcal{I}}}{\orsig_0, \bigl(\defp{a} \defd \bigwith_{i \in \mathcal{I}} \n{A}_i\bigr)}}{
        \begin{array}[b]{@{}c@{}}
          \text{($\theta(a) = \defp{a}$)} \quad
          \chorsig{\theta}{\srsig_0}{\orsig_0} \quad
          \text{($\defp{a} \notin \dom{\orsig_0}$)}
          \\
          \multipremise{i \in \mathcal{I}}{
            \text{$\bigl(\theta(w^L_i) = \atmR{\octx}^L_i\bigr)$} \quad
            \text{$\bigl(\theta(w^R_i) = \atmL{\octx}^R_i\bigr)$} \quad
            \qimp{\atmR{\octx}^L_i}{\up \bigfuse \theta(w'_i)}{\atmL{\octx}^R_i}{\n{A}_i}}
        \end{array}}
    %
    \shortintertext{and}
    %
      w = \infer[\jrule{$\reduces$AX}]{w^L_k \wc a \wc w^R_k \reduces_{\srsig} w'_k}{(w^L_k \wc a \wc w^R_k \reduces w'_k) \in \srsig} = w'
    \end{gather*}
    for some $k \in \mathcal{I}$, where the axioms are $\srsig = \srsig_0, (w^L_i \wc a \wc w^R_i \reduces w'_i)_{i \in \mathcal{I}}$, and the definitions are $\orsig = \orsig_0 , (\bigwith_{i \in \mathcal{I}} \n{A}_i)$.

    By \cref{lem:qimp-correct}, $\lfocus{\theta(w^L_k)}{\n{A}_k}{\theta(w^R_k)}{\bigfuse \theta(w'_k)}$ holds.
    Appending a $\lrule{\with}$ rule, we have 
    $\lfocus{\theta(w^L_k)}{\bigwith_{i \in \mathcal{I}} \n{A}_i}{\theta(w^R_k)}{\bigfuse \theta(w'_k)}$.
    Because $\rfocus{\theta(w'_k)}{\bigfuse \theta(w'_k)}$, it follows by the $\jrule{$\reduces$I}$ rule that $\theta(w^L_k) \oc \bigl(\bigwith_{i \in \mathcal{I}} \n{A}_i\bigr) \oc \theta(w^R_k) \reduces_{\orsig} \theta(w'_k)$, and so $\theta(w) = \theta(w^L_k) \oc \defp{a} \oc \theta(w^R_k) \reduces_{\orsig} \theta(w'_k) = \theta(w')$.

  \item
    Consider the case in which
    \begin{gather*}
      \infer{\chorsig{\theta}{\srsig_0, \bigl(v^L_i \wc a \wc v^R_i \reduces v'_i\bigr)_{i \in \mathcal{I}}}{\orsig_0, \bigl(\defp{a} \defd \bigwith_{i \in \mathcal{I}} \n{A}_i\bigr)}}{
        \begin{array}[b]{@{}c@{}}
          \text{($\theta(a) = \defp{a}$)} \quad
          \chorsig{\theta}{\srsig_0}{\orsig_0} \quad
          \text{($\defp{a} \notin \dom{\orsig_0}$)}
          \\
          \multipremise{i \in \mathcal{I}}{
            \text{$\bigl(\theta(v^L_i) = \atmR{\octx}^L_i\bigr)$} \quad
            \text{$\bigl(\theta(v^R_i) = \atmL{\octx}^R_i\bigr)$} \quad
            \qimp{\atmR{\octx}^L_i}{\up \bigfuse \theta(v'_i)}{\atmL{\octx}^R_i}{\n{A}_i}}
        \end{array}}
    %
    \shortintertext{and}
    %
      \infer[\jrule{$\reduces$AX}]{w \reduces_{\srsig} w'}{
        (w \reduces w') \in \srsig_0}
    \end{gather*}
    where $(w \reduces w') \in \srsig_0$; the axioms are $\srsig = \srsig_0, (v^L_i \wc a \wc v^R_i \reduces v'_i)_{i \in \mathcal{I}}$; and the definitions are $\orsig = \orsig_0 , (\bigwith_{i \in \mathcal{I}} \n{A}_i)$.

    By the inductive hypothesis, $\theta(w) \reduces_{\orsig_0} \theta(w')$.
    It follows from weakening~\parencref{lem:formula-as-process:definition-weakening} that $\theta(w) \reduces_{\orsig} \theta(w')$.    

  \item 
    The case in which
    \begin{equation*}
      \infer{\chorsig{\theta}{\srsige}{\orsige}}{}
      \qquad\text{and}\qquad
      \infer[\jrule{$\reduces$AX}]{w \reduces_{\srsig} w'}{
        (w \reduces w') \in \srsig}
    \end{equation*}
    where $\srsig = \srsige$ and $\orsig = \orsige$ is vacuous.
  \qedhere
  % \item
  %   Consider the case in which
  %   \begin{gather*}
  %     \infer{\chorsig{\theta}{\srsig_0, (w_1 \wc a \wc w_2 \reduces w')}{\orsig_0, (\defp{a} \defd \n{A} \with \n{B})}}{
  %       \begin{array}[b]{@{}c@{}}
  %         \text{($\theta(w_1) = \atmR{\octx}_L$)} \quad
  %         \text{($\theta(a) = \defp{a}$)} \quad
  %         \text{($\theta(w_2) = \atmL{\octx}_R$)} \\
  %         \atmR{\octx}_L \limp \up \bigfuse \theta(w') \pmir \atmL{\octx}_R \rightsquigarrow \n{B} \quad
  %         \chorsig{\theta}{\srsig_0}{\orsig_0, (\defp{a} \defd \n{A})}
  %       \end{array}}
  %   \shortintertext{and}
  %     w =
  %     \infer[\jrule{$\reduces$AX}]{w_1 \wc a \wc w_2 \reduces_{\srsig} w'}{}
  %   \end{gather*}
  %   where $\srsig = \srsig_0 , (w_1 \wc a \wc w_2 \reduces w')$ and $\orsig = \orsig_0, (\defp{a} \defd \n{A} \with \n{B})$.

  %   By \cref{lem:chorax-sound-complete}, $\lfocus{\theta(w_1)}{\n{B}}{\theta(w_2)}{\bigfuse \theta(w')}$.
  %   Upon adding the $\lrule{\with}_2$ rule, $\lfocus{\theta(w_1)}{\n{A} \with \n{B}}{\theta(w_2)}{\bigfuse \theta(w')}$.
  %   Because $\rfocus{\theta(w')}{\bigfuse \theta(w')}$~\parencref{??}, it follows by the $\jrule{$\reduces$I}$ rule that $\theta(w_1) \oc (\n{A} \with \n{B}) \oc \theta(w_2) \reduces_{\orsig} \theta(w')$, and so $\theta(w) = \theta(w_1) \oc \defp{a} \oc \theta(w_2) = \theta(w_1) \oc (\n{A} \with \n{B}) \oc \theta(w_2) \reduces_{\orsig} \theta(w')$


  % \item
  %   Consider the case in which
  %   \begin{gather*}
  %     \infer{\chorsig{\theta}{\srsig_0, (w_1 \wc a \wc w_2 \reduces w')}{\orsig_0, (\defp{a} \defd \n{B})}}{
  %       \begin{array}[b]{@{}c@{}}
  %         \text{($\theta(w_1) = \atmR{\octx}_L$)} \quad
  %         \text{($\theta(a) = \defp{a}$)} \quad
  %         \text{($\theta(w_2) = \atmL{\octx}_R$)} \\
  %         \atmR{\octx}_L \limp \up \bigfuse \theta(w') \pmir \atmL{\octx}_R \rightsquigarrow \n{B} \quad
  %         \chorsig{\theta}{\srsig_0}{\orsig_0} \quad
  %         \text{($\defp{a} \notin \dom{\orsig_0}$)}
  %       \end{array}}
  %   \shortintertext{and}
  %     w =
  %     \infer[\jrule{$\reduces$AX}]{w_1 \wc a \wc w_2 \reduces_{\srsig} w'}{}
  %   \end{gather*}
  %   where $\srsig = \srsig_0 , (w_1 \wc a \wc w_2 \reduces w')$ and $\orsig = \orsig_0 , (\defp{a} \defd \n{B})$.

  %   By \cref{lem:chorax-sound-complete}, $\lfocus{\theta(w_1)}{\n{B}}{\theta(w_2)}{\bigfuse \theta(w')}$.
  %   Because $\rfocus{\theta(w')}{\bigfuse \theta(w')}$, it follows by the $\jrule{$\reduces$I}$ rule that $\theta(w_1) \oc \n{B} \oc \theta(w_2) \reduces_{\orsig} \theta(w')$, and so $\theta(w) = \theta(w_1) \oc \defp{a} \oc \theta(w_2) = \theta(w_1) \oc \n{B} \oc \theta(w_2) \reduces_{\orsig} \theta(w')$.
    
  % \item
  %   Consider the case in which
  %   \begin{gather*}
  %     \infer{\chorsig{\theta}{\srsig_0, (v_1 \wc b \wc v_2 \reduces v')}{\orsig_0, (\defp{b} \defd \n{A} \with \n{B})}}{
  %       \begin{array}[b]{@{}c@{}}
  %         \text{($\theta(v_1) = \atmR{\octx}_L$)} \quad
  %         \text{($\theta(b) = \defp{b}$)} \quad
  %         \text{($\theta(v_2) = \atmL{\octx}_R$)} \\
  %         \atmR{\octx}_L \limp \up \bigfuse \theta(v') \pmir \atmL{\octx}_R \rightsquigarrow \n{B} \quad
  %         \chorsig{\theta}{\srsig_0}{\orsig_0, (\defp{b} \defd \n{A})}
  %       \end{array}}
  %   \shortintertext{and}
  %     \infer[\jrule{$\reduces$AX}]{w \reduces_{\srsig} w'}{
  %       w \reduces w' \in \srsig_0}
  %   \end{gather*}
  %   where $\srsig = \srsig_0, (v_1 \wc b \wc v_2 \reduces v')$ and $\orsig = \orsig_0 , (\defp{b} \defd \n{A} \with \n{B})$.

  %   By the inductive hypothesis, $\theta(w) \reduces_{\orsig_0, (\defp{b} \defd \n{A})} \theta(w')$.
  %   It follows from the weakening \lcnamecref{??}~\parencref{??} that $\theta(w) \reduces_{\orsig} \theta(w')$, as required.

  % \item
  %   The case in which
  %   \begin{gather*}
  %     \infer{\chorsig{\theta}{\srsig_0, (v_1 \wc b \wc v_2 \reduces v')}{\orsig_0, (\defp{b} \defd \n{B})}}{
  %       \begin{array}[b]{@{}c@{}}
  %         \text{($\theta(v_1) = \atmR{\octx}_L$)} \quad
  %         \text{($\theta(b) = \defp{b}$)} \quad
  %         \text{($\theta(v_2) = \atmL{\octx}_R$)} \\
  %         \atmR{\octx}_L \limp \up \bigfuse \theta(v') \pmir \atmL{\octx}_R \rightsquigarrow \n{B} \quad
  %         \chorsig{\theta}{\srsig_0}{\orsig_0} \quad
  %         \text{($\defp{b} \notin \dom{\orsig_0}$)}
  %       \end{array}}
  %   \shortintertext{and}
  %     \infer[\jrule{$\reduces$AX}]{w \reduces_{\srsig} w'}{
  %       w \reduces w' \in \srsig_0}
  %   \end{gather*}
  %   where $\srsig = \srsig_0, (v_1 \wc b \wc v_2 \reduces v')$ and $\orsig = \orsig_0 , (\defp{b} \defd \n{B})$ is similar to the previous one.
    %
  \end{itemize}
\end{proof}




% \begin{lemma}
%   If $\chorax{\theta}{w_1}{\p{A}}{w_2}{\n{B}}$ and $\lfocus{\atmR{\octx}_L}{\n{B}}{\atmL{\octx}_R}{\p{C}}$, then $\atmR{\octx}_L = \theta(w_1)$ and $\atmL{\octx}_R = \theta(w_2)$ and $\p{A} = \p{C}$.
% \end{lemma}
% \begin{proof}
%   By induction over the structure of the given choreographing derivation, $\chorax{\theta}{w_1}{\p{A}}{w_2}{\n{B}}$.
%   \begin{itemize}
%   \item
%     Consider the case in which
%   \begin{equation*}
%     \infer{\chorax{\theta}{\emp}{\p{A}}{\emp}{\up \p{A}}}{}
%     \qquad\text{and}\qquad
%     \lfocus{\atmR{\octx}_1}{\up \p{A}}{\atmL{\octx}_2}{\p{C}}
%     \,.
%   \end{equation*}
%   By inversion on the left-focus derivation, $\atmR{\octx}_L = \octxe = \theta(\emp)$ and $\atmL{\octx}_R = \octxe = \theta(\emp)$, as well as $\p{A} = \p{C}$, as required.

%   \item
%     Consider the case in which
%   \begin{equation*}
%     \infer{\chorax{\theta}{w_1 \oc b}{\p{A}}{w_2}{\atmR{b} \limp \n{B}}}{
%       \text{($\theta(b) = \atmR{b}$)} &
%       \chorax{\theta}{w_1}{\p{A}}{w_2}{\n{B}}}
%     \qquad\text{and}\qquad
%     \lfocus{\atmR{\octx}_L}{\atmR{b} \limp \n{B}}{\atmL{\octx}_R}{\p{C}}
%     \,.
%   \end{equation*}
%   By inversion on the left-focus derivation for $\atmR{b} \limp \n{B}$, there exists $\atmR{\octx}'_1$ such that $\atmR{\octx}_L = \atmR{\octx}'_L \oc \atmR{b}$ and $\lfocus{\atmR{\octx}'_L}{\n{B}}{\atmL{\octx}_R}{\p{C}}$.
%   It follows from the inductive hypothesis that $\atmR{\octx}'_L = \theta(w_1)$ and $\atmL{\octx}_R = \theta(w_2)$ and $\p{A} = \p{C}$.
%   So $\atmR{\octx}_L = \theta(w_1) \oc \atmR{b} = \theta(w_1 \oc b)$.

%   \item
%     The case in which
% \begin{equation*}
%     \infer{\chorax{\theta}{w_1 \oc b}{\p{A}}{w_2}{\n{B} \pmir \atmL{b}}}{
%       \text{($\theta(b) = \atmL{b}$)} &
%       \chorax{\theta}{w_1}{\p{A}}{w_2}{\n{B}}}
%     \qquad\text{and}\qquad
%     \lfocus{\atmR{\octx}_L}{\n{B} \pmir \atmL{b}}{\atmL{\octx}_R}{\p{C}}
%   \end{equation*}
%   is symmetric.
%   \qedhere
%   \end{itemize}
% \end{proof}


\begin{lemma}\label{lem:chorsig-atom-correct}
  If $\chorsig{\theta}{\srsig}{\orsig}$ and $\lfocus{\atmR{\octx}_L}{\defp{a}}{\atmL{\octx}_R}{_{\orsig} \p{C}}$, then there exists an axiom $(w_1 \oc a \oc w_2 \reduces w') \in \srsig$ such that $\atmR{\octx}_L = \theta(w_1)$, $\atmL{\octx}_R = \theta(w_2)$, and $\p{C} = \bigfuse \theta(w')$.
\end{lemma}
\begin{proof}
  By induction over the structure of the given choreographing derivation, $\chorsig{\theta}{\srsig}{\orsig}$.
  \begin{itemize}
  \item
    Consider the case in which
    \begin{gather*}
      \infer{\chorsig{\theta}{\srsig_0, \bigl(w^L_i \wc a \wc w^R_i \reduces w'_i\bigr)_{i \in \mathcal{I}}}{\orsig_0, \bigl(\defp{a} \defd \bigwith_{i \in \mathcal{I}} \n{A}_i\bigr)}}{
        \begin{array}[b]{@{}c@{}}
          \chorsig{\theta}{\srsig_0}{\orsig_0} \quad
          \text{($\theta(a) = \defp{a}$)} \quad
          \text{($\defp{a} \notin \dom{\orsig_0}$)}
          \\
          \multipremise{i \in \mathcal{I}}{
            \text{$\bigl(\theta(w^L_i) = \atmR{\lctx}^L_i\bigr)$} \quad
            \text{$\bigl(\theta(w^R_i) = \atmL{\lctx}^R_i\bigr)$} \quad
            \qimp{\atmR{\lctx}^L_i}{\up \bigfuse \theta(w'_i)}{\atmL{\lctx}^R_i}{\n{A}_i}}
        \end{array}}
    %
    \shortintertext{and}
    %
      \lfocus{\atmR{\octx}_L}{\defp{a} = \textstyle\bigwith_{i \in \mathcal{I}} \n{A}_i}{\atmL{\octx}_R}{_{\orsig} \p{C}}
    \end{gather*}
    where $\srsig = \srsig_0, \bigl(w^L_i \wc a \wc w^R_i \reduces w'_i\bigr)_{i \in \mathcal{I}}$ and $\orsig = \orsig_0, \bigl(\defp{a} \defd \bigwith_{i \in \mathcal{I}} \n{A}_i\bigr)$.

    By inversion on the left-focus derivation, either: $\lfocus{\atmR{\octx}_L}{\n{A}_k}{\atmL{\octx}_R}{\p{C}}$ for some $k \in \mathcal{I}$; or $\mathcal{I}$ is empty.
    \begin{itemize}
    \item
      If $\lfocus{\atmR{\octx}_L}{\n{A}_k}{\atmL{\octx}_R}{\p{C}}$ for some $k \in \mathcal{I}$, then \cref{lem:qimp-correct} allows us to conclude that $\atmR{\octx}_L = \atmR{\lctx}^L_k = \theta(w^L_k)$ and $\atmL{\octx}_R = \atmL{\lctx}^R_k = \theta(w^R_k)$ and $\p{C} = \bigfuse \theta(w'_k)$.
      Also, the axiom $w^L_k \wc a \wc w^R_k \reduces w'_k$ is contained in $\srsig$.
    \item
      Otherwise, if $\mathcal{I}$ is empty, then $\bigwith_{i \in \mathcal{I}} \n{A}_i = \top$.
      There is no $\lrule{\top}$ rule to derive $\lfocus{\atmR{\octx}_L}{\defp{a} = \top}{\atmL{\octx}_R}{_{\orsig} \p{C}}$, so this case is vacuous.
    \end{itemize}




  \item
    Consider the case in which
    \begin{gather*}
      \infer{\chorsig{\theta}{\srsig_0, \bigl(v^L_i \wc b \wc v^R_i \reduces v'_i\bigr)_{i \in \mathcal{I}}}{\orsig_0, \bigl(\defp{b} \defd \bigwith_{i \in \mathcal{I}} \n{B}_i\bigr)}}{
        \begin{array}[b]{@{}c@{}}
          \chorsig{\theta}{\srsig_0}{\orsig_0} \quad
          \text{($\theta(b) = \defp{b}$)} \quad
          \text{($\defp{b} \notin \dom{\orsig_0}$)}
          \\
          \multipremise{i \in \mathcal{I}}{
            \text{$\bigl(\theta(v^L_i) = \atmR{\lctx}^L_i\bigr)$} \quad
            \text{$\bigl(\theta(v^R_i) = \atmL{\lctx}^R_i\bigr)$} \quad
            \qimp{\atmR{\lctx}^L_i}{\up \bigfuse \theta(v'_i)}{\atmL{\lctx}^R_i}{\n{B}_i}}
        \end{array}}
    %
    \shortintertext{and}
    %
      \lfocus{\atmR{\octx}_L}{\defp{a}}{\atmL{\octx}_R}{_{\orsig} \p{C}}
    \end{gather*}
    where $a \neq b$ and $\srsig = \srsig_0, \bigl(v^L_i \wc b \wc v^R_i \reduces v'_i\bigr)_{i \in \mathcal{I}}$ and $\orsig = \orsig_0, \bigl(\defp{b} \defd \bigwith_{i \in \mathcal{I}} \n{B}_i\bigr)$.

    By the inductive hypthesis, there exists a string rewriting axiom $(w_1 \wc a \wc w_2 \reduces w') \in \srsig_0$ such that $\atmR{\octx}_L = \theta(w_1)$ and $\atmL{\octx}_R = \theta(w_2)$ and $\p{C} = \bigfuse \theta(w')$.
    The same axiom is contained in the signature $\srsig$.


  \item 
    The case in which
    \begin{equation*}
      \infer{\chorsig{\theta}{\srsige}{\orsige}}{}
      \qquad\text{and}\qquad
      \lfocus{\atmR{\octx}_L}{\defp{a}}{\atmL{\octx}_R}{_{\orsig} \p{C}}
    \end{equation*}
    where $\srsig = \srsige$ and $\orsig = \orsige$ is vacuous because there is no definition for $\defp{a}$ in the signature $\orsig$.
  \qedhere

  % \item
  %   Consider the case in which
  %   \begin{gather*}
  %     \infer{\chorsig{\theta}{\srsig_0, (v_1 \wc b \wc v_2 \reduces v')}{\orsig_0, (\defp{b} \defd \n{A} \with \n{B})}}{
  %       \begin{array}[b]{@{}c@{}}
  %         \text{($\theta(v_1) = \atmR{\lctx}_L$)} \quad
  %         \text{($\theta(b) = \defp{b}$)} \quad
  %         \text{($\theta(v_2) = \atmL{\lctx}_R$)} \\
  %         \atmR{\lctx}_L \limp \up \bigfuse \theta(v') \pmir \atmL{\lctx}_R \rightsquigarrow \n{B} \quad
  %         \chorsig{\theta}{\srsig_0}{\orsig_0, (\defp{b} \defd \n{A})}
  %       \end{array}}
  %   \shortintertext{and}
  %     \lfocus{\atmR{\octx}_L}{\defp{a}}{\atmL{\octx}_R}{_{\orsig} \p{C}}
  %   \end{gather*}
  %   where $a \neq b$ and $\srsig = \srsig_0, (v_1 \wc b \wc v_2 \reduces v')$ and $\orsig = \orsig_0, (\defp{b} \defd \n{A} \with \n{B})$.

  %   By the inductive hypothesis, there exists a string rewriting axiom $(w_1 \wc a \wc w_2 \reduces w') \in \srsig_0$ such that $\atmR{\octx}_L = \theta(w_1)$, $\atmL{\octx}_R = \theta(w_2)$, and $\p{C} = \bigfuse \theta(w')$.
  % The same axiom is contained in the signature $\srsig$.

  % \item
  %   Consider the case in which
  %   \begin{gather*}
  %     \infer{\chorsig{\theta}{\srsig_0, (v_1 \wc b \wc v_2 \reduces v')}{\orsig_0, (\defp{b} \defd \n{B})}}{
  %       \begin{array}[b]{@{}c@{}}
  %         \text{($\theta(v_1) = \atmR{\lctx}_L$)} \quad
  %         \text{($\theta(b) = \defp{b}$)} \quad
  %         \text{($\theta(v_2) = \atmL{\lctx}_R$)} \\
  %         \atmR{\lctx}_L \limp \up \bigfuse \theta(v') \pmir \atmL{\lctx}_R \rightsquigarrow \n{B} \quad
  %         \chorsig{\theta}{\srsig_0}{\orsig_0} \quad
  %         \text{($\defp{b} \notin \dom{\orsig_0}$)}
  %       \end{array}}
  %   \shortintertext{and}
  %     \lfocus{\atmR{\octx}_L}{\defp{a}}{\atmL{\octx}_R}{_{\orsig} \p{C}}
  %   \end{gather*}
  %   where $a \neq b$ and $\srsig = \srsig_0, (v_1 \wc b \wc v_2 \reduces v')$ and $\orsig = \orsig_0, (\defp{b} \defd \n{B})$.

  %   By the inductive hypothesis, there exists a string rewriting axiom $(w_1 \wc a \wc w_2 \reduces w') \in \srsig_0$ such that $\atmR{\octx}_L = \theta(w_1)$, $\atmL{\octx}_R = \theta(w_2)$, and $\p{C} = \bigfuse \theta(w')$.
  % The same axiom is contained in the signature $\srsig$.

  % \item
  %   Consider the case in which
  %   \begin{gather*}
  %     \infer{\chorsig{\theta}{\srsig_0, (w_1 \wc a \wc w_2 \reduces w')}{\orsig_0, (\defp{a} \defd \n{A} \with \n{B})}}{
  %       \begin{array}[b]{@{}c@{}}
  %         \text{($\theta(w_1) = \atmR{\lctx}_L$)} \quad
  %         \text{($\theta(a) = \defp{a}$)} \quad
  %         \text{($\theta(w_2) = \atmL{\lctx}_R$)} \\
  %         \atmR{\lctx}_L \limp \up \bigfuse \theta(w') \pmir \atmL{\lctx}_R \rightsquigarrow \n{B} \quad
  %         \chorsig{\theta}{\srsig_0}{\orsig_0, (\defp{a} \defd \n{A})}
  %       \end{array}}
  %   \shortintertext{and}
  %     \infer[\lrule{\with}_2]{\lfocus{\atmR{\octx}_L}{\defp{a} = \n{A} \with \n{B}}{\atmL{\octx}_R}{_{\orsig} \p{C}}}{
  %       \lfocus{\atmR{\octx}_L}{\n{B}}{\atmL{\octx}_R}{_{\orsig} \p{C}}}
  %   \end{gather*}
  %   where $\srsig = \srsig_0, (w_1 \wc a \wc w_2 \reduces w')$ and $\orsig = \orsig_0, (\defp{a} \defd \n{A} \with \n{B})$.

  %   By \cref{??}, $\atmR{\octx}_L = \atmR{\lctx}_L = \theta(w_1)$ and $\atmL{\octx}_R = \atmL{\lctx}_R = \theta(w_2)$ and $\p{C} = \bigfuse \theta(w')$.
  %   And the axiom $w_1 \wc a \wc w_2 \reduces w'$ is contained in the signature $\orsig$.

  % \item
  %   Consider the case in which
  %   \begin{gather*}
  %     \infer{\chorsig{\theta}{\srsig_0, (v_1 \wc a \wc v_2 \reduces v')}{\orsig_0, (\defp{a} \defd \n{A} \with \n{B})}}{
  %       \begin{array}[b]{@{}c@{}}
  %         \text{($\theta(v_1) = \atmR{\lctx}_L$)} \quad
  %         \text{($\theta(a) = \defp{a}$)} \quad
  %         \text{($\theta(v_2) = \atmL{\lctx}_R$)} \\
  %         \atmR{\lctx}_L \limp \up \bigfuse \theta(v') \pmir \atmL{\lctx}_R \rightsquigarrow \n{B} \quad
  %         \chorsig{\theta}{\srsig_0}{\orsig_0, (\defp{a} \defd \n{A})}
  %       \end{array}}
  %   \shortintertext{and}
  %     \infer[\lrule{\with}_1]{\lfocus{\atmR{\octx}_L}{\defp{a} = \n{A} \with \n{B}}{\atmL{\octx}_R}{_{\orsig} \p{C}}}{
  %       \lfocus{\atmR{\octx}_L}{\n{A}}{\atmL{\octx}_R}{_{\orsig} \p{C}}}
  %   \end{gather*}
  %   where $\srsig = \srsig_0, (v_1 \wc a \wc v_2 \reduces v')$ and $\orsig = \orsig_0, (\defp{a} \defd \n{A} \with \n{B})$.

  %   Let $\orsig' = \orsig_0 , (\defp{a} \defd \n{A})$.
  %   Then $\lfocus{\atmR{\octx}_L}{\defp{a} = \n{A}}{\atmL{\octx}_R}{_{\orsig'} \p{C}}$.
  %   By inductive hypothesis, there exists an axiom $(w_1 \wc a \wc w_2 \reduces w') \in \srsig_0$ such that $\atmR{\octx}_L = \theta(w_1)$ and $\atmL{\octx}_R = \theta(w_2)$ and $\p{C} = \bigfuse \theta(w')$.
  %   That same axiom is also contained in the signature $\srsig$.

  % \item
  %   Consider the case in which
  %   \begin{gather*}
  %     \infer{\chorsig{\theta}{\srsig_0, (w_1 \wc a \wc w_2 \reduces w')}{\orsig_0, (\defp{a} \defd \n{B})}}{
  %       \begin{array}[b]{@{}c@{}}
  %         \text{($\theta(w_1) = \atmR{\lctx}_L$)} \quad
  %         \text{($\theta(a) = \defp{a}$)} \quad
  %         \text{($\theta(w_2) = \atmL{\lctx}_R$)} \\
  %         \atmR{\lctx}_L \limp \up \bigfuse \theta(w') \pmir \atmL{\lctx}_R \rightsquigarrow \n{B} \quad
  %         \chorsig{\theta}{\srsig_0}{\orsig_0} \quad
  %         \text{($\defp{a} \notin \dom{\orsig_0}$)}
  %       \end{array}}
  %   \shortintertext{and}
  %     \lfocus{\atmR{\octx}_L}{\defp{a} = \n{B}}{\atmL{\octx}_R}{_{\orsig} \p{C}}
  %   \end{gather*}
  %   where $\srsig = \srsig_0, (w_1 \wc a \wc w_2 \reduces w')$ and $\orsig = \orsig_0, (\defp{a} \defd \n{B})$.

  %   By \cref{??}, $\atmR{\octx}_L = \atmR{\lctx}_L = \theta(w_1)$ and $\atmL{\octx}_R = \atmL{\lctx}_R = \theta(w_2)$ and $\p{C} = \bigfuse \theta(w')$.
  %   And the axiom $w_1 \wc a \wc w_2 \reduces w'$ is contained in the signature $\orsig$.


  % % \item
  % %   The case in which
  % % \begin{gather*}
  % %   \infer{\chorsig{\theta}{\srsig, v_1 \oc b \oc v_2 \reduces v'}{\orsig, \defp{a} \defd \n{A}, \defp{b} \defd \n{B}}}{
  % %     \text{($\theta(b) = \defp{b}$)} &
  % %     \chorax{\theta}{v_1}{\bigfuse \theta(v')}{v_2}{\n{B}} &
  % %     \chorsig{\theta}{\srsig}{\orsig, \defp{a} \defd \n{A}} &
  % %     \text{($\defp{b} \notin \dom{\orsig}$)}}
  % %   \\\text{and}\\
  % %   \lfocus{\atmR{\octx}_L}{\defp{a}}{\atmL{\octx}_R}{\p{C}}
  % % \end{gather*}
  % % is similar.

  % % \item
  % % Consider the case in which
  % % \begin{gather*}
  % %   \infer{\chorsig{\theta}{\srsig, v_1 \oc a \oc v_2 \reduces v'}{\orsig, \defp{a} \defd \n{A}_1 \with \n{A}_2}}{
  % %     \text{($\theta(a) = \defp{a}$)} &
  % %     \chorax{\theta}{v_1}{\bigfuse \theta(v')}{v_2}{\n{A}_2} &
  % %     \chorsig{\theta}{\srsig}{\orsig, \defp{a} \defd \n{A}_1}}
  % %   \\\text{and}\\
  % %   \lfocus{\atmR{\octx}_L}{\defp{a}}{\atmL{\octx}_R}{\p{C}}
  % %   \,.
  % % \end{gather*}
  % % There are two cases, according to whether the $\lfocus{\atmR{\octx}_L}{\defp{a}}{\atmL{\octx}_R}{\p{C}}$ derivation ends with the $\lrule{\with}_1$ or $\lrule{\with}_2$ rule.
  % %   \begin{itemize}
  % %   \item If the left-focus derivation ends with the $\lrule{\with}_2$ rule, then $\lfocus{\atmR{\octx}_L}{\n{A}_2}{\atmL{\octx}_R}{\p{C}}$.
  % %     Because $\chorax{\theta}{v_1}{\bigfuse \theta(v')}{v_2}{\n{A}_2}$, it follows from \cref{??} that $\atmR{\octx}_L = \theta(v_1)$ and $\atmL{\octx}_R = \theta(v_2)$ and $\p{C} = \bigfuse \theta(v')$.
  % %     Choose the axiom $w_1 \oc a \oc w_2 \reduces w'$ to be $v_1 \oc a \oc v_2 \reduces v'$.

  % %   \item Otherwise, if the left-focus derivation instead ends with the $\lrule{\with}_1$ rule, then $\lfocus{\atmR{\octx}_L}{\n{A}_1}{\atmL{\octx}_R}{\p{C}}$.
  % %     By the inductive hypothesis, $\atmR{\octx}_L = \theta(w_1)$, $\atmL{\octx}_R = \theta(w_2)$, and $\p{C} = \bigfuse \theta(w')$ for some string rewriting axiom $(w_1 \oc a \oc w_2 \reduces w') \in \srsig$.
  % %     The same axiom is contained in the signuare $\srsig, v_1 \oc a \oc v_2 \reduces v'$.
  % %   \end{itemize}

  % % \item
  % % Consider the case in which 
  % % \begin{equation*}
  % %   \infer{\chorsig{\theta}{\srsig, w_1 \oc a \oc w_2 \reduces w'}{\orsig, \defp{a} \defd \n{A}}}{
  % %     \text{($\theta(a) = \defp{a}$)} &
  % %     \chorax{\theta}{w_1}{\bigfuse \theta(w')}{w_2}{\n{A}} &
  % %     \chorsig{\theta}{\srsig}{\orsig} &
  % %     \text{($\defp{a} \notin \dom{\orsig}$)}}
  % % \end{equation*}
  % % Because $\chorax{\theta}{w_1}{\bigfuse \theta(w')}{w_2}{\n{A}_2}$, it follows from \cref{??} that $\atmR{\octx}_L = \theta(w_1)$ and $\atmL{\octx}_R = \theta(w_2)$ and $\p{C} = \bigfuse \theta(w')$.
  %
  \end{itemize}
\end{proof}

\begin{theorem}\label{thm:formula-as-process:choreograph-soundness}
  If $\chorsig{\theta}{\srsig}{\orsig}$ and $\theta(a) = \defp{a}$ and $\octx_L \oc \defp{a} \oc \octx_R \reduces_{\orsig} \octx'$, then either:
  \begin{itemize}
  \item $\octx_L = \octx'_L \oc \theta(w_1)$ and $\octx_R = \theta(w_2) \oc \octx'_R$ and $\octx' = \octx'_L \oc \theta(w') \oc \octx'_R$ for some contexts $\octx'_L$ and $\octx'_R$ and some strings $w_1$, $w_2$, and $w'$ such that $(w_1 \wc a \wc w_2 \reduces w') \in \srsig$ and $\lfocus{\theta(w_1)}{\defp{a}}{\theta(w_2)}{\bigfuse \theta(w')}$;
  \item $\octx_L \reduces_{\orsig} \octx'_L$ for some context $\octx'_L$ such that $\octx' = \octx'_L \oc \defp{a} \oc \octx_R$; or
  \item $\octx_R \reduces_{\orsig} \octx'_R$ for some context $\octx'_R$ such that $\octx' = \octx_L \oc \defp{a} \oc \octx'_R$.
  \end{itemize}
\end{theorem}
\begin{proof}
  As a negative proposition, $\defp{a}$ serves as a barrier for interactions between $\octx_L$ and $\octx_R$ -- in \ac{PFOR}, implications cannot consume negative propositions.
  Thus, any reduction on $\octx_L \oc \defp{a} \oc \octx_R$ must occur within either $\octx_L$ or $\octx_R$ alone or must arise from $\defp{a}$.

  If the reduction on $\octx_L \oc \defp{a} \oc \octx_R$ arises from $\defp{a}$, then it arises from a bipole that begins by focusing on $\defp{a}$.
  In other words, $\octx_L = \octx'_L \oc \atmR{\lctx}_L$ and $\octx_R = \atmL{\lctx}_R \oc \octx'_R$ and $\octx' = \octx'_L \oc \lctx' \oc \octx'_R$ for some contexts $\atmR{\lctx}_L$, $\atmL{\lctx}_R$, and $\lctx'$ and positive proposition $\p{C}$ such that $\lfocus{\atmR{\lctx}_L}{\defp{a}}{\atmL{\lctx}_R}{\p{C}}$ and $\rfocus{\lctx'}{\p{C}}$.
  By \cref{lem:chorsig-atom-correct}, there exists an axiom $(w_1 \wc a \wc w_2 \reduces w') \in \srsig$ such that $\atmR{\lctx}_L = \theta(w_1)$ and $\atmL{\lctx}_R = \theta(w_2)$ and $\p{C} = \bigfuse \theta(w')$.
  It follows that $\lctx' = \theta(w')$.
\end{proof}

% \begin{corollary}[Soundness]\label{cor:formula-as-process:choreograph-soundness}
%   If $\chorsig{\theta}{\srsig}{\orsig}$ and $\theta(w) \reduces_{\orsig} \octx'$, then there exists $w'$ such that $\octx' = \theta(w')$ and $w \reduces_{\srsig} w'$.%
%   \marginnote{%
%     \begin{tabular}{@{}c@{}}
%       $\chorsig{\theta}{\srsig}{\orsig}$
%       \\implies\\
%       $\begin{tikzcd}[ampersand replacement=\&]
%       w \rar[reduces, exists, subscript=\srsig] \dar[relation][swap]{\theta}
%        \& w\mathrlap{'} \dar[relation, exists]{\theta}
%       \\
%       \theta(w) \rar[reduces, subscript=\orsig]
%        \& \octx\mathrlap{'}
%     \end{tikzcd}
%     \hphantom{'}$
%     \end{tabular}}%
% \end{corollary}

\begin{corollary}[Choreography adequacy]\label{cor:formula-as-process:choreography-adequacy}
  If $\chorsig{\theta}{\srsig}{\orsig}$, then $\theta(w) \reduces_{\orsig} \octx'$ if, and only if, there exists $w'$ such that $w \reduces_{\orsig} w'$ and $\theta(w') = \octx'$.
\end{corollary}

\section{Extended example: Choreographing binary counters}\label{sec:formula-as-process:counters}

In this \lcnamecref{sec:formula-as-process:counters}, we revisit binary counters, \ie, binary representations of natural numbers equipped with increment and decrement operations.
Here we use them as an extended example of choreographing string rewriting specifications.

Recall from \cref{sec:string-rewriting:binary-counter} a string rewriting specification $(\sralph, \srsig)$ of binary counters where the alphabet $\sralph$ and the axioms $\srsig$ are:
\begin{equation*}
  \begin{lgathered}
    \sralph = \Set{e, b_0, b_1, i, d, z, s, b'_0}
    \\
    \srsig
      = \begin{array}[t]{@{}l@{}l@{}l@{}}
          (e \wc i \reduces e \wc b_1) \,, {} &
          (b_0 \wc i \reduces b_1) \,, &
          (b_1 \wc i \reduces i \wc b_0) \,, \\
          %
          (e \wc d \reduces z) \,, &
          (b_0 \wc d \reduces b'_0) \,, {} &
          (b_1 \wc d \reduces b_0 \wc s) \,, \\
          % 
          (z \wc b'_0 \reduces z) \,, &
          (s \wc b'_0 \reduces b_1 \wc s)
        \end{array}
  \end{lgathered}
\end{equation*}
% In this \lcnamecref{sec:formula-as-process:counters},
We will present several distinct choreographies of this specification, including an object-oriented choreography that treats the increment and decrement operations as messages, and a functional choreography that instead treats those operations as processes. 


\subsection{An object-oriented choreography}\label{sec:formula-as-process:counters-oo}

Let $\theta$ be%
\marginnote{$
  \theta = \{
    \begin{lgathered}[t]
      e \mapsto \smash{\defp{e}} , b_0 \mapsto \smash{\defp{b}_0} , b_1 \mapsto \smash{\defp{b}_1} , \\
      i \mapsto \atmL{i} , d \mapsto \atmL{d} , \\
      z \mapsto \atmR{z} , s \mapsto \atmR{s} , b'_0 \mapsto \smash{\defp{b}'_0} \}
    \end{lgathered}
$}
the role assignment that maps the bits $e$, $b_0$, and $b_1$ to coinductively defined processes $\defp{e}$, $\defp{b}_0$, and $\defp{b}_1$; increments $i$ and decrements $d$ to left-directed messages $\atmL{i}$ and $\atmL{d}$; unary constructors $z$ and $s$ to right-directed messages $\atmR{z}$ and $\atmR{s}$; and $b'_0$ to coinductively defined process $\defp{b}'_0$.%

Two axioms in $\srsig$ mention $e$ in their premises: $e \wc i \reduces e \wc b_1$ and $e \wc d \reduces z$.
Under the role assignment $\theta$, these axioms induce the rewritings
\begin{equation*}
  \ereduces[\orsig]{\defp{e} \oc \atmL{i}}{\defp{e} \oc \defp{b}_1}
  \qquad\text{and}\qquad
  \ereduces[\orsig]{\defp{e} \oc \atmL{d}}{\atmR{z}}
\end{equation*}
as constraints on $\orsig$ that must be satisfied if $(\theta, \orsig)$ is to be a meaningful choreography of the binary counter specification.
Solving these for $\defp{e}$, we obtain the definition
\begin{equation*}
  \defp{e} \defd (\defp{e} \fuse \defp{b}_1 \pmir \atmL{i}) \with (\atmR{z} \pmir \atmL{d})
  \,.
\end{equation*}
Similar reasoning allows us to construct coinductive definitions for $\defp{b}_0$, $\defp{b}_1$, and $\smash{\defp{b}'_0}\vphantom{b}$ as the solutions of the other constraints induced from the axioms $\srsig$ by $\theta$.
(See \cref{tbl:formula-as-process:deriving-oo-counter} for a sketch.)
%
\begin{table*}[tbp]
  \renewcommand{\arraystretch}{1.2}
  \begin{tabular}{@{}l@{\qquad}l@{\qquad}l@{}}
    \toprule
    \emph{Axioms, $\srsig$} &
    \emph{Rewriting constraints on $\orsig$} & \emph{Solution, $\orsig$}
    \\ \midrule
    $e \wc i \reduces e \wc b_1$ and $e \wc d \reduces z$ &
    $\ereduces[\orsig]{\defp{e} \oc \atmL{i}}{\defp{e} \oc \defp{b}_1}$ and $\ereduces[\orsig]{\defp{e} \oc \atmL{d}}{\atmR{z}}$
      & $\defp{e} \defd (\defp{e} \fuse \defp{b}_1 \pmir \atmL{i}) \with (\atmR{z} \pmir \atmL{d})$
    \\
    $b_0 \wc i \reduces b_1$ and $b_0 \wc d \reduces d \wc b'_0$ &
    $\ereduces[\orsig]{\defp{b}_0 \oc \atmL{i}}{\defp{b}_1}$ and $\ereduces[\orsig]{\defp{b}_0 \oc \atmL{d}}{\atmL{d} \oc \defp{b}'_0}$
      & $\defp{b}_0 \defd (\up \dn \defp{b}_1 \pmir \atmL{i}) \with (\atmL{d} \fuse \defp{b}'_0 \pmir \atmL{d})$
    \\
    $b_1 \wc i \reduces i \wc b_0$ and $b_1 \wc d \reduces b_0 \wc s$ &
    $\ereduces[\orsig]{\defp{b}_1 \oc \atmL{i}}{\atmL{i} \oc \defp{b}_0}$ and $\ereduces[\orsig]{\defp{b}_1 \oc \atmL{d}}{\defp{b}_0 \oc \atmR{s}}$
      & $\defp{b}_1 \defd (\atmL{i} \fuse \defp{b}_0 \pmir \atmL{i}) \with (\defp{b}_0 \fuse \atmR{s} \pmir \atmL{d})$
    \\
    $z \wc b'_0 \reduces z$ and $s \wc b'_0 \reduces b_1 \wc s$ &
    $\ereduces[\orsig]{\atmR{z} \oc \defp{b}'_0}{\atmR{z}}$ and $\ereduces[\orsig]{\atmR{s} \oc \defp{b}'_0}{\defp{b}_1 \oc \atmR{s}}$
      & $\defp{b}'_0 \defd (\atmR{z} \limp \atmR{z}) \with (\atmR{s} \limp \defp{b}_1 \fuse \atmR{s})$
    \\ \addlinespace \bottomrule
  \end{tabular}
  \caption{Deriving an object-oriented choreography of binary counters}\label{tbl:formula-as-process:deriving-oo-counter}
\end{table*}
%
In full, the solution to these constraints is the definitions $\orsig$:
\begin{equation*}
  \orsig =
  \begin{lgathered}[t]
    \bigl(\defp{e} \defd (\defp{e} \fuse \defp{b}_1 \pmir \atmL{i}) \with (\atmR{z} \pmir \atmL{d})\bigr) \,, \\
    \bigl(\defp{b}_0 \defd (\up \dn \defp{b}_1 \pmir \atmL{i}) \with (\atmL{d} \fuse \defp{b}'_0 \pmir \atmL{d})\bigr) \,, \\
    \bigl(\defp{b}_1 \defd (\atmL{i} \fuse \defp{b}_0 \pmir \atmL{i}) \with (\defp{b}_0 \fuse \atmR{s} \pmir \atmL{d})\bigr) \,, \\
    \bigl(\defp{b}'_0 \defd (\atmR{z} \limp \atmR{z}) \with (\atmR{s} \limp \defp{b}_1 \fuse \atmR{s})\bigr)
  \,.
  \end{lgathered}
\end{equation*}



In other words, under the role assignment $\theta$, the string rewriting axioms for the binary counter are choreographed to the coinductive propositions defined in $\orsig$.
It is easy, if tedious, to verify that 
% the judgment $\chorsig{\theta}{\srsig}{\orsig}$ holds -- 
the formal construction described in \lcnamecref{sec:formula-as-process:choreograph-formal} generates the same definitions, $\orsig$:
%
\begin{proposition}
  For the above string rewriting specification $(\sralph, \srsig)$ and role assignment $\theta$, the judgment $\chorsig{\theta}{\srsig}{\orsig}$ holds.
\end{proposition}

\newthought{This choreography} might be called \emph{object-oriented} for its similarity to the eponymous programming paradigm.
In that paradigm, computation is centered around message exchange between stateful objects -- data are stored by objects, and those data are manipulated by exchanging messages with the relevant objects.

This choreography of the binary counter specification behaves similarly:%
\footnote{For a study of the relationship between (session-typed) processes and objects, see \textcite{Balzer+Pfenning:AGERE15}.}
its data -- the bits $e$, $b_0$, and $b_1$ -- are represented as processes, and its operations -- the increments $i$ and decrements $d$ -- are represented as messages that the processes dispatch on.
%
% We refer to this choreography as \emph{object-oriented} for its similarity to the object-oriented progamming paradigm: because its data -- the bits $e$, $b_0$, and $b_1$ -- are represented as processes and its operations -- the increments $i$ and decrements $d$ -- are represented as messages.
%
For example, $\defp{e}$ is the coinductively defined process that waits to receive either the increment message $\atmL{i}$ or the decrement message $\atmL{d}$ from its right-hand neighbor.
If $\atmL{i}$ is received, then $\defp{e}$ spawns a new process, $\defp{b}_1$, to its right and then continues recursively as $\defp{e}$.
Otherwise, if $\atmL{d}$ is received, then $\defp{e}$ sends the message $\atmR{z}$ as a response.





\newthought{Recall from \cref{sec:string-rewriting:binary-counter}} that string rewriting specifications of binary counters were assigned natural number denotations according to the relations $\aval{}{}$, $\ainc{}{}$, and $\adec{}{}$.
Based on the role assignment that underlies this choreography, we can lift these denotations to choreographed counters:
For instance, $\octx$ is an increment context that denotes $n$ exactly when $\ainc{\theta^{-1}(\octx)}{n}$; and so $\defp{e} \oc \atmL{i} \oc \defp{b}_1$ denotes $3$ because $\theta^{-1}(\defp{e} \oc \atmL{i} \oc \defp{b}_1) = \ainc{e \wc i \wc b_1}{3}$.
We could even assign denotations directly to choreographed contexts by defining new $\aval{}{}$, $\ainc{}{}$, and $\adec{}{}$ relations on choreographed contexts.
\begin{inferences}
  \infer[\jrule{$\defp{e}$-V}]{\aval{\defp{e}}{0}}{}
  \and
  \infer[\jrule{$\defp{b}_0$-V}]{\aval{\octx \oc \defp{b}_0}{2n}}{
    \aval{\octx}{n}}
  \and
  \infer[\jrule{$\defp{b}_1$-V}]{\aval{\octx \oc \defp{b}_1}{2n+1}}{
    \aval{\octx}{n}}
  \\
  \infer[\jrule{$\defp{e}$-I}]{\ainc{\defp{e}}{0}}{}
  \and
  \infer[\jrule{$\defp{b}_0$-I}]{\ainc{\octx \oc \defp{b}_0}{2n}}{
    \ainc{\octx}{n}}
  \and
  \infer[\jrule{$\defp{b}_1$-I}]{\ainc{\octx \oc \defp{b}_1}{2n+1}}{
    \ainc{\octx}{n}}
  \and
  \infer[\jrule{$\atmL{i}$-I}]{\ainc{\octx \oc \atmL{i}}{n+1}}{
    \ainc{\octx}{n}}
  \\
  \infer[\jrule{$\atmL{d}$-D}]{\adec{\octx \oc \atmL{d}}{n}}{
    \ainc{\octx}{n}}
  \and
  \infer[\jrule{$\atmR{z}$-D}]{\adec{\atmR{z}}{0}}{}
  \and
  \infer[\jrule{$\atmR{s}$-D}]{\adec{\octx \oc \atmR{s}}{n+1}}{
    \ainc{\octx}{n}}
  \and
  \infer[\jrule{$\defp{b}'_0$-D}]{\adec{\octx \oc \defp{b}'_0}{2n}}{
    \adec{\octx}{n}}
\end{inferences}
We will say that a context $\octx$ is an \vocab{increment counter} or \vocab{increment context} if $\ainc{\octx}{n}$ for some natural number $n$;
likewise, we will say that a context $\octx$ is an \vocab{decrement counter} or \vocab{decrement context} if $\adec{\octx}{n}$ for some $n$.

\begin{theorem}
  The following hold for all $\octx$ and $n$.
  \begin{itemize}[nosep]
  \item $\aval{\octx}{n}$ if, and only if, $\octx = \theta(w)$ for some $w$ such that $\aval{w}{n}$.
  \item $\ainc{\octx}{n}$ if, and only if, $\octx = \theta(w)$ for some $w$ such that $\ainc{w}{n}$.
  \item $\adec{\octx}{n}$ if, and only if, $\octx = \theta(w)$ for some $w$ such that $\adec{w}{n}$.
  \end{itemize}
\end{theorem}
\begin{proof}
  In each direction, by structural induction on the derivation of the denotation.
\end{proof}

Just as we proved the string rewriting specification of binary counters to be adequate with respect to the natural number denotation, we can also show this object-oriented choreography to be adequate.
What is interesting is that the adequacy of this choreography comes for nearly free -- it can be established by composing the string rewriting specification's adequacy theorem with the theorems that show an arbitrary choreography to be sound and complete with respect to its underlying string rewriting specification.
% The adequacy of this choreography can be established by composing the adequacy of the string rewriting specification with the adequacy of the choreographing procedure.




Recall from \cref{??} that \cref{??} show that the string rewriting specification adequately describes increments and decrements:
\thmadequacysmalldecstring*
%
\coradequacydecstring*

Combining these \lcnamecrefs{??} with \cref{thm:formula-as-process:choreograph-completeness}, we have the immediate \lcnamecref{cor:choreographies:oo-counter-adequacy}:
\begin{restatable}[
  name=Adequacy of object-oriented choreography,
  label=cor:choreographies:oo-counter-adequacy
]{corollary}{coroocounteradequacy}
  The following hold.
  \begin{thmdescription}[nosep]
  \item[Preservation]
    If $\ainc{\octx}{n}$ and $\octx \reduces_{\orsig} \octx'$, then $\ainc{\octx'}{n}$.
    If $\adec{\octx}{n}$ and $\octx \reduces_{\orsig} \octx'$, then $\adec{\octx'}{n}$.

  \item[Big-step]
    If $\adec{\octx}{n}$, then:
    \begin{itemize}[nosep]
    \item $\octx \Reduces_{\orsig} \atmR{z}$ if, and only if, $n = 0$;
    \item $\octx \Reduces_{\orsig} \octx' \oc \atmR{s}$ for some $\octx'$ such that $\ainc{\octx'}{n-1}$, if $n > 0$; and
    \item $\octx \Reduces_{\orsig} \octx' \oc \atmR{s}$ only if $n > 0$ and $\ainc{\octx'}{n-1}$.
    \end{itemize}
  \end{thmdescription}
\end{restatable}



\subsection{A functional choreography}\label{sec:formula-as-process:counters-functional}

The object-oriented choreography is not the only choreography possible for the binary counter specification, however.

Let $\theta'$ be%
\marginnote{$
  \theta' = \{
    \begin{lgathered}[t]
      e \mapsto \atmR{e} , b_0 \mapsto \atmR{b}_0 , b_1 \mapsto \atmR{b}_1 , \\
      i \mapsto \smash{\defp{\imath}} , d \mapsto \smash{\defp{d}} , \\
      z \mapsto \atmR{z} , s \mapsto \atmR{s} , b'_0 \mapsto \smash{\defp{b}'_0} \}
    \end{lgathered}
$}
a role assignment that is (roughly) dual to $\theta$ -- that is, let $\theta'$ map the bits $e$, $b_0$, and $b_1$ to right-directed messages $\atmR{e}$, $\atmR{b}_0$, and $\atmR{b}_1$; increments $i$ and decrements $d$ to coinductively defined processes $\defp{\imath}$ and $\defp{d}$; unary constructors $z$ and $s$ to right-directed messages $\atmR{z}$ and $\atmR{s}$; and $b'_0$ to the coinductively defined process $\defp{b}'_0$.%

Once again, we can construct a choreography from the string rewriting axioms $\srsig$ by solving constraints in the form of rewritings. 
Three axioms from $\srsig$ mention $i$ in their premises: $e \wc i \reduces e \wc b_1$, $b_0 \wc i \reduces b_1$, and $b_1 \wc i \reduces i \wc b_0$.
Under the role assignment $\theta'$, these axioms induce the rewritings
\begin{equation*}
  \ereduces[\orsig']{\atmR{e} \oc \defp{\imath}}{\atmR{e} \oc \atmR{b}_1}
  \qquad\text{and}\qquad
  \ereduces[\orsig']{\atmR{b}_0 \oc \defp{\imath}}{\atmR{b}_1}
  \qquad\text{and}\qquad
  \ereduces[\orsig']{\atmR{b}_1 \oc \defp{\imath}}{\defp{\imath} \oc \atmR{b}_0}
\end{equation*}
as constraints on $\orsig'$ that must be satisfied if $(\theta', \orsig')$ is to be a choreography of the binary counter specification.
Solving these constraints for $\defp{\imath}$, we obtain the definition
\begin{equation*}
  \defp{\imath} \defd (\atmR{e} \limp \atmR{e} \fuse \atmR{b}_1) \with (\atmR{b}_0 \limp \atmR{b}_1) \with (\atmR{b}_1 \limp \defp{\imath} \fuse \atmR{b}_0)
  \,.
\end{equation*}
Upon solving the remaining constraints for the other coinductively defined propositions, $\defp{d}$ and $\defp{b}'_0$,%
%
\begin{table*}[tbp]
  \renewcommand{\arraystretch}{1.3}
  \begin{tabular}{@{}l@{\qquad\enspace}l@{\qquad\enspace}l@{}}
    \toprule
    \emph{Axioms, $\srsig$} &
    \emph{Rewriting constraints on $\orsig'$} & \emph{Solution, $\orsig'$}
    \\ \midrule
    $e \wc i \reduces e \wc b_1$ and $b_0 \wc i \reduces b_1$ &
    $\ereduces[\orsig']{\atmR{e} \oc \defp{\imath}}{\atmR{e} \oc \atmR{b}_1}$ and $\ereduces[\orsig']{\atmR{b}_0 \oc \defp{\imath}}{\atmR{b}_1}$
    & $\defp{\imath} \defd (\atmR{e} \limp \atmR{e} \fuse \atmR{b}_1) \with (\atmR{b}_0 \limp \atmR{b}_1)$
    \\[-0.75ex]
    \quad and $b_1 \wc i \reduces i \wc b_0$ &
    \quad and $\ereduces[\orsig']{\atmR{b}_1 \oc \defp{\imath}}{\defp{\imath} \oc \atmR{b}_0}$ &
    $\hphantom{\defp{\imath} \defd {}} \with (\atmR{b}_1 \limp \defp{\imath} \fuse \atmR{b}_0)$
    \\
    $e \wc d \reduces z$ and $b_0 \wc d \reduces d \wc b'_0$ &
    $\ereduces[\orsig']{\atmR{e} \oc \defp{d}}{\atmR{z}}$ and $\ereduces[\orsig']{\atmR{b}_0 \oc \defp{d}}{\defp{d} \oc \defp{b}'_0}$
      & $\defp{d} \defd (\atmR{e} \limp \atmR{z}) \with (\atmR{b}_0 \limp \defp{d} \fuse \defp{b}'_0)$
    \\[-0.75ex]
    \quad and $b_1 \wc d \reduces b_0 \wc s$ &
    \quad and $\ereduces[\orsig']{\atmR{b}_1 \oc \defp{d}}{\atmR{b}_0 \oc \atmR{s}}$ &
    $\hphantom{\defp{d} \defd {}} \with (\atmR{b}_1 \limp \atmR{b}_0 \fuse \atmR{s})$
    \\
    $z \wc b'_0 \reduces z$ and $s \wc b'_0 \reduces b_1 \wc s$ &
    $\ereduces[\orsig']{\atmR{z} \oc \defp{b}'_0}{\atmR{z}}$ and $\ereduces[\orsig']{\atmR{s} \oc \defp{b}'_0}{\defp{b}_1 \oc \atmR{s}}$
      & $\defp{b}'_0 \defd (\atmR{z} \limp \atmR{z}) \with (\atmR{s} \limp \atmR{b}_1 \fuse \atmR{s})$
    \\ \addlinespace \bottomrule
  \end{tabular}
  \caption{Deriving a functional choreography of binary counters}\label{tbl:formula-as-process:deriving-functional-choreography}
\end{table*}%
%
\footnote{See \cref{tbl:formula-as-process:deriving-functional-choreography} for a sketch.}
we arrive at the definitions
\begin{equation*}
  \orsig' =
  \begin{lgathered}[t]
    \bigl(\defp{\imath} \defd (\atmR{e} \limp \atmR{e} \fuse \atmR{b}_1) \with (\atmR{b}_0 \limp \atmR{b}_1) \with (\atmR{b}_1 \limp \defp{\imath} \fuse \atmR{b}_0)\bigr) \,, \\
    \bigl(\defp{d} \defd (\atmR{e} \limp \atmR{z}) \with (\atmR{b}_0 \limp \defp{d} \fuse \defp{b}'_0) \with (\atmR{b}_1 \limp \atmR{b}_0 \fuse \atmR{s})\bigr) \,, \\
    \bigl(\defp{b}'_0 \defd (\atmR{z} \limp \atmR{z}) \with (\atmR{s} \limp \defp{b}_1 \fuse \atmR{s})\bigr)
    \,.
  \end{lgathered}
\end{equation*}
Again, it is easy to verify that these definitions are exactly those that are constructed by the formal description of the choreographing algorithm:
\begin{proposition}
  For the above string rewriting specification $(\sralph, \srsig)$ and role assignment $\theta'$, the judgment $\chorsig{\theta'}{\srsig}{\orsig'}$ holds.
\end{proposition}

In contrast with the previous, object-oriented choreography, this choreography treats its data -- the bits $e$, $b_0$, and $b_1$ -- as messages that are manipulated by processes that represent the operations -- increments $i$ and decrements $d$.
For this reason, the choreography $(\theta', \orsig')$ might be called \emph{functional} for its similarity to functional programming.

\clearpage
\subsection{Duality and other choreographies}

These two (roughly) dual object-oriented and functional choreographies hint at a fundamental duality between the object-oriented and functional programming paradigms.

It is briefly tempting to think that a general duality theorem for choreographies might exist.
Perhaps if $(\theta, \orsig)$ is a choreography of the specification $(\sralph, \srsig)$, there exists a dual choreography $(\theta^{\bot}, \orsig^{\bot})$ in which $\theta^{\bot}$ maps a symbol $a$ to a message exactly when $\theta$ mapped it to a process?

Such a theorem does not exist.
As a counterexample, recall the string rewriting specification $(\sralph, \srsig)$ and choreography $(\theta, \orsig)$ given by
\begin{equation*}
  \begin{lgathered}
    \sralph = \Set{a, b} \\
    \srsig = (a \wc b \reduces b) \,, (b \reduces \emp)
  \end{lgathered}
  \qquad\text{and}\qquad
  \begin{lgathered}
    \theta = \Set{ a \mapsto \atmR{a} , b \mapsto \defp{b} } \\
    \orsig = \bigl(\defp{b} \defd (\atmR{a} \limp \up \dn \defp{b}) \with \up \one\bigr)
    \,.
  \end{lgathered}
\end{equation*}
For this choreography, the dual role assignment, $\theta^{\bot}$, would map $b$ to a message, either $\atmL{b}$ or $\atmR{b}$.
And, the axiom $b \reduces \emp$ would, under $\theta^{\bot}$, induce either $\ereduces[\orsig^{\bot}]{\atmL{b}}{(\octxe)}$ or $\ereduces[\orsig^{\bot}]{\atmR{b}}{(\octxe)}$ as a constraint.
Neither of these possible constraints is satisfiable in the formula-as-process ordered rewriting framework because the premises contain only passive messages.%
\footnote{See \cref{??}.}

One might also ask if a theorem is possible if some additional conditions are imposed on the specification.
% It appeasr that the conditions necessary for such a theorem are so extremely narrow as to make any obtained theorem of little value.
For instance, at first glance, a duality theorem might seem possible for those specifications in which all axioms' premises contain exactly two symbols.
Unfortunately, this is not the case.
Consider, as a counterexample, the string rewriting specification $(\sralph, \srsig)$ and the choreography $(\theta, \orsig)$ given by
\begin{equation*}
  \begin{lgathered}
    \sralph = \Set{ a, b, c} \\
    \srsig = (a \wc b \reduces b) \,, (b \wc c \reduces b)
  \end{lgathered}
  \qquad\text{and}\qquad
  \begin{lgathered}
    \theta = \Set{ a \mapsto \atmR{a} , b \mapsto \defp{b} , c \mapsto \atmL{c} } \\
    \orsig = \bigl(\defp{b} \defd (\atmR{a} \limp \up \dn \defp{b}) \with (\up \dn \defp{b} \pmir \atmL{c})\bigr)
    \,.
  \end{lgathered}
\end{equation*}
For this choreography, the dual role assignment, $\theta^{\bot}$, would map $b$ to a message, either $\atmL{b}$ or $\atmR{b}$.
But either choice leads to unsatisfiable constraints.
Depending on whether $\theta^{\bot}$ maps $b$ to $\atmL{b}$ or $\atmR{b}$, the induced constraints are either:
\begin{equation*}
  \ereduces[\orsig^{\bot}]{\defp{a} \oc \atmL{b}}{\atmL{b}}
  \enspace\text{and}\enspace
  \ereduces[\orsig^{\bot}]{\atmL{b} \oc \defp{c}}{\atmL{b}}
  \qquad\text{or}\qquad
  \ereduces[\orsig^{\bot}]{\defp{a} \oc \atmR{b}}{\atmR{b}}
  \enspace\text{and}\enspace
  \ereduces[\orsig^{\bot}]{\atmR{b} \oc \defp{c}}{\atmR{b}}
  \,,
\end{equation*}
respectively.
In either case, the constraints are unsatisfiable because one premise in each group involves a message directed outward, away from the premise's process.%
\footnote{See \cref{??}.}

We will return to this idea of a duality theorem in \cref{??}, where we will see that session types provide just the right conditions for such a theorem.
% a b --> ...
% b c --> ...

% b = (a \ ..) & (... / c)

% Suppose that $\theta$ induces $\atmR{a} \oc \defp{b} \oc \atmL{c} \reduces_{\orsig} \mathord{\dotsm}$ as a constraint.
% Then $\theta^{\bot}$ would assign the symbols $a$ and $c$ process roles and the symbol $b$ a message role, resulting in either $\defp{a} \oc \atmL{b} \oc \defp{c} \reduces_{\orsig^{\bot}} \mathord{\dotsm}$ or $\defp{a} \oc \atmR{b} \oc \defp{c} \reduces_{\orsig^{\bot}} \mathord{\dotsm}$ as a constraint.
% Neither of these possible constraints is satisfiable in the formula-as-process ordered rewriting framework because the premises contain more than one process.%
% \footnote{See \cref{??}.}

% A general duality theorem does not exist: even if the constraint $\atmR{a} \oc \defp{b} \oc \atmL{c} \reduces_{\orsig} \theta(w')$ is satisfiable, the dual\fixnote{?} $\defp{a} \oc \atmL{b} \oc \defp{c} \reduces \theta^{\bot}(w')$ nor $\defp{a} \oc \atmR{b} \oc \defp{c} \reduces \theta^{\bot}(w')$ are [...].


\newthought{Besides these} object-oriented and functional choreographies, the binary counter specification has two other, related choreographies.
The two alternatives are broadly similar to the object-oriented and functional choreographies, with two exceptions: the unary constructors $z$ and $s$ are treated as processes, not messages; and $b'_0$ is treated as a message, not a process.
Instead of responding to a decrement with either a $\atmR{z}$ or $\atmR{s}$ message, these choreographies transform the binary counter into head-unary form where the head is a process -- either $\defp{z}$ or $\defp{s}$.

One problem with these choreographies, however, is that, without a $\atmR{z}$ or $\atmR{s}$ response message, there is no way to observe the counter's state.
Under these choreographies, all counters are, in some sense, equivalent because they can't be distinguished by any of the nonexistent observations.
We will return to the idea of observational equivalence in the following \lcnamecref{ch:??}.

\begin{table*}[tb]
  \renewcommand{\arraystretch}{1.2}
  \begin{tabular}{@{}ll@{}}
    \toprule
    \emph{Object-oriented--like alternative}
    & \emph{Functional-like alternative}
    \\ \midrule
    $\begin{aligned}[t]
       \theta^* &= \theta[z \mapsto \defp{z} , s \mapsto \defp{s} , b'_0 \mapsto \atmL{b}'_0]
       \\
       \orsig^* &=
       \begin{lgathered}[t]
         \bigl(\proc{e} \defd (\proc{e} \fuse \proc{b}_1 \pmir \atmL{i}) \with (\up \dn \proc{z} \pmir \atmL{d})\bigr) \,, \\
         \bigl(\proc{b}_0 \defd (\up \dn \proc{b}_1 \pmir \atmL{i}) \with (\atmL{d} \fuse \atmL{b}'_0 \pmir \atmL{d})\bigr) \,, \\
         \bigl(\proc{b}_1 \defd (\atmL{i} \fuse \proc{b}_0 \pmir \atmL{i}) \with (\proc{b}_0 \fuse \proc{s} \pmir \atmL{d})\bigr) \,, \\
         \bigl(\proc{z} \defd \up \dn \proc{z} \pmir \atmL{b}'_0\bigr) \,, \\
         \bigl(\proc{s} \defd \proc{b}_1 \fuse \proc{s} \pmir \atmL{b}'_0\bigr)
       \end{lgathered}
     \end{aligned}$
    &
    $\begin{aligned}[t]
       \theta^\dag &= \theta'[z \mapsto \defp{z} , s \mapsto \defp{s} , b'_0 \mapsto \atmL{b}'_0]
       \\
       \orsig^\dag &=
       \begin{lgathered}[t]
         \bigl(\defp{\imath} \defd (\atmR{e} \limp \atmR{e} \fuse \atmR{b}_1) \with (\atmR{b}_0 \limp \atmR{b}_1) \with (\atmR{b}_1 \limp \defp{\imath} \fuse \atmR{b}_0)\bigr) \,, \\
         \bigl(\defp{d} \defd (\atmR{e} \limp \up \dn \defp{z}) \with (\atmR{b}_0 \limp \defp{d} \fuse \atmL{b}'_0) \with (\atmR{b}_1 \limp \atmR{b}_0 \fuse \defp{s})\bigr) \,, \\
         \bigl(\defp{z} \defd \up \dn \defp{z} \pmir \atmL{b}'_0\bigr) \,, \\
         \bigl(\defp{s} \defd \atmR{b}_1 \fuse \defp{s} \pmir \atmL{b}'_0\bigr)
       \end{lgathered}
     \end{aligned}$
    \\ \addlinespace \bottomrule
  \end{tabular}
  \caption{Two other choreographies for the binary counter specification}
\end{table*}


\section{Extended example: Choreographing \aclp*{NFA}}\label{sec:formula-as-process:nfa}

Recall from \cref{??} our string rewriting specification of how \iac{NFA} processes its input.
Given \iac{NFA} $\aut{A} = (Q, \nfapow, F)$\fixnote{symbol?} over an input alphabet $\ialph$, the \ac{NFA}'s operational semantics is adequately captured by the string rewriting specification $(\ialph \dunion \Set{\eow, \symrej}, \srsig)$, where the axioms $\srsig$ are given by
\begin{equation*}
  \!\begin{aligned}
    \srsig = {}
      &\Set{ a \wc q \reduces q'_a \given (a \in \ialph) \land (q \in Q) \land (q'_a \in \nfapow(q, a)) } \\
      &{} \union \Set{ \eow \wc q \reduces F(q) \given q \in Q }
  \end{aligned}
\text{ where }
  F(q) = \begin{cases*}
           \emp & if $q \in F$ \\
           \symrej & if $q \notin F$\,.
         \end{cases*}
\end{equation*}
As a second extended example of a choreography, we would now like to choreograph this specification in the formula-as-process ordered rewriting framework.
As with the binary counter specification, there are, in fact, two distinct choreographies for this string rewriting specification of \acp{NFA} -- one functional and one object-oriented.

\subsection{A functional choreography}\label{sec:formula-as-process:nfa-functional}

Let $\theta$ be%
\marginnote{$
  \theta =
    \!\begin{lgathered}[t]
      \Set{ a \mapsto \atmR{a} \given a \in \ialph } \union \Set{ \eow \mapsto \atmR{\eow} } \\
      {} \union \Set{ q \mapsto \defp{q} \given q \in Q } \\
      {} \union \Set{ \symrej \mapsto \atmR{\symrej} }
    \end{lgathered}
$}
the role assignment that maps each input symbol $a \in \ialph$ to a right-directed message, $\atmR{a}$; the end-of-word marker, $\eow$, to a right-directed message, $\atmR{\eow}$; each state $q \in Q$ to a coinductively defined proposition, $\defp{q}$; and the rejection symbol, $\symrej$, to a right-directed message, $\atmR{\symrej}$.
In other words, the input word is transmitted as a sequence of messages to a process $\defp{q}$ that tracks the \ac{NFA}'s current state.

% One possible choreography for this specification interprets each input symbol $a \in \ialph$ as a right-directed atom, $\atmR{a}$; each state $q \in Q$ as a recursively defined proposition, $\defp{q}$; and the end-of-word marker, $\emp$, as a right-directed atom, $\atmR{\emp}$.
% In other words, the input string is transmitted as a sequence of messages to a process $\defp{q}$ that tracks the \ac{NFA}'s current state.

% In other words, the \ac{NFA}'s input is treated as a sequence of messages, $\atmR{\emp} \oc \atmR{a}_n \dotsm \atmR{a}_2 \oc \atmR{a}_1$, and the \ac{NFA}'s states are treated as [recursive] processes.

Choose an arbitrary state $q \in Q$.
Under the role assignment $\theta$, the axioms in $\srsig$ that mention $q$ in their premises induce the rewritings
\begin{equation*}
  \begin{lgathered}
    \Set{ \ereduces[\orsig]{\atmR{\eow} \oc \defp{q}}{\atmR{F}(q)} } \\
    \,{} \union {\textstyle \bigunion_{a \in \ialph} \Set{ \ereduces[\orsig]{\atmR{a} \oc \defp{q}}{\defp{q}'_a} \given q'_a \in \nfapow(q, a) }}
  \end{lgathered}
  \enspace\text{where }
  \atmR{F}(q) = \begin{cases*}
                  (\octxe) & if $q \in F$ \\
                  \atmR{\symrej} & if $q \notin F$
                \end{cases*}
\end{equation*}
as constraints on $\orsig$ that must be satisfied if $(\theta, \orsig)$ is to be a meaningful choreography of the \ac{NFA} specification $(\ialph \dunion \Set{\eow, \symrej}, \srsig)$.
Solving these constraints for $\defp{q}$, we obtain the definition
\begin{gather*}
  \defp{q} \defd
    (\atmR{\eow} \limp \up \bigfuse \atmR{F}(q)) \with
    \bigwith_{a \in \ialph} \bigl(\atmR{a} \limp (
      \textstyle \bigwith_{q'_a \in \nfapow(q, a)} \up \dn \defp{q}'_a)
    \bigr)
  \,,
\intertext{and therefore the full choreographing signature is}
  \orsig = \left(
    \defp{q} \defd
      (\atmR{\eow} \limp \up \bigfuse \atmR{F}(q)) \with
      \bigwith_{a \in \ialph} \bigl(\atmR{a} \limp (
        \textstyle \bigwith_{q'_a \in \nfapow(q, a)} \up \dn \defp{q}'_a)
      \bigr)
    \right)_{q \in Q}
\end{gather*}
As a concrete example, the adjacent \lcnamecref{fig:formula-as-process:nfa-example}
%
\begin{marginfigure}
  \centering
  \begin{tikzpicture}
    \graph [automaton] {
      q_0
       -> ["a,b", loop above]
      q_0
       -> ["b"]
      q_1 [accepting]
       -> ["a,b"]
      q_2
       -> ["a,b", loop above]
      q_2;
    };
  \end{tikzpicture}

  \begin{equation*}
    \orsig =
    \begin{lgathered}[t]
      \bigl(\defp{q}_0 \defd (\atmR{a} \limp \up \dn \defp{q}_0) \with (\atmR{b} \limp (\up \dn \defp{q}_0 \with \up \dn \defp{q}_1)) \with (\atmR{\eow} \limp \up \atmR{\symrej})\bigr) \,, \\
      \bigl(\defp{q}_1 \defd (\atmR{a} \limp \up \dn \defp{q}_2) \with (\atmR{b} \limp \up \dn \defp{q}_2) \with (\atmR{\eow} \limp \up \one)\bigr) \,, \\
      \bigl(\defp{q}_2 \defd (\atmR{a} \limp \up \dn \defp{q}_2) \with (\atmR{b} \limp \up \dn \defp{q}_2) \with (\atmR{\eow} \limp \up \atmR{\symrej})\bigr)
    \end{lgathered}
  \end{equation*}

  \caption{\Iac*{NFA} that accepts exactly those words, over the alphabet $\ialph = \set{a,b}$, that end with $b$; and a choreography}\label{fig:formula-as-process:nfa-example}
\end{marginfigure}%
%
recalls from \cref{??} \iac{NFA} that accepts those words, over the alphabet $\ialph = \Set{a,b}$, that end with $b$, and also gives a choreographing signature for that \ac{NFA}.

% \begin{equation*}
%   \orsig =
%     \bigl(
%       \defp{q} \defd
%         (\atmR{\eow} \limp \atmR{F}(q)) \with
%         \bigwith_{a \in \ialph} \bigl(
%           \textstyle \bigwith_{q'_a} (\atmR{a} \limp \up \dn \defp{q}'_a)
%         \bigr)
%     \bigr)
%   \,.
% \end{equation*}

% Under this choreographing assignment, the string rewriting axioms become rewriting steps that must be derivable:
% \begin{equation*}
%   \atmR{a} \oc \defp{q}
%     \reduces \defp{q}'_a
%   %
%   \atmR{\emp} \oc \defp{q}
%     \reduces \begin{cases*}
%                & if $q \in F$ \\
%                & if $q \notin F$
%              \end{cases*}
% \end{equation*}
% These required rewritings are indeed local: each one contains exactly one recursively defined process in its premise, with all remaining propositions in its premise being input messages for that process.
% For instance, each $\atmR{a} \oc \defp{q} \reduces \defp{q}'_a$

% Solving for each recursively defined proposition, we have one definition, 
% \begin{equation*}
%   \defp{q} \defd \bigwith_{a \in \ialph} \bigwith_{q\smash{'_a}} (\atmR{a} \limp \defp{q}'_a) \with (\atmR{\emp} \limp \nfa{F}(q))
%   \,,
% \end{equation*}
% for each \ac{NFA} state $q \in Q$.
Similarly to one of the binary counter's choreographies, this choreography might be called \enquote*{functional} because the data, an input string, are represented by messages that are acted on in a function-like way by the current state's process, $\defp{q}$.

\begin{proposition}\label{prop:formula-as-process:nfa-functional-chorsig}
  For the above string rewriting specification $(\ialph \dunion \Set{\eow, \symrej}, \srsig)$ and role assignment $\theta$, the judgment $\chorsig{\theta}{\srsig}{\orsig}$ holds (up to focusing equivalence).
\end{proposition}
% %
% \noindent
% The proof of this \lcnamecref{thm:choreographies:nfa-functional-chorsig} is a completely straightforward, if tedious, formalization of the preceding intuition, along the line of \cref{??}.

Recall from \cref{sec:string-rewriting:nfa} the adequacy \lcnamecref{thm:nfa-adequacy-string-rewriting} for the string rewriting specification of \acp{NFA}.
%
\nfaadequacystringrewriting*
%
What we would like now is a \lcnamecref{thm:??} that relates \iac{NFA} not to a string rewriting specification but to the above functional choreography.
In the specific instance of this functional choreography of the \ac{NFA}, \cref{thm:??,thm:??}, the adequacy of the choreographing procedure, can be reduced to the following \lcnamecref{??} -- a result that relates the string rewriting specification to the choreography.
\begin{corollary}
  For the above string rewriting specification $(\ialph \dunion \Set{\eow, \symrej}, \srsig)$ and choreography $(\theta, \orsig)$, the choreography is adequate with respect to the specification:
  \begin{itemize}[nosep]
  \item
    $a \wc q \reduces_{\srsig} q'_a$ only if $\atmR{a} \oc \defp{q} \reduces_{\orsig} \defp{q}'_a$.
    Moreover, if $\atmR{a} \oc \defp{q} \reduces_{\orsig} \octx'$, then $a \wc q \reduces_{\srsig} q'_a$ for some state $q'_a$ such that $\octx' = \defp{q}'_a$.
  \item
    $\eow \wc q \reduces_{\srsig} F(q)$ if, and only if, $\atmR{\eow} \oc \defp{q} \reduces_{\orsig} \atmR{F}(q)$.
  \item
    $\rev{w} \wc q \reduces_{\srsig} q'$ only if $\rev{\atmR{a}} \oc \defp{q} \reduces_{\orsig} \defp{q}'$.
    Moreover, if $\rev{\atmR{w}} \oc \defp{q} \reduces_{\orsig} \octx'$, then $\rev{w} \wc q \reduces_{\srsig} q'$ for some state $q'$ such that $\octx' = \defp{q}'$.
  \end{itemize}
\end{corollary}
%
\noindent By composing this with \cref{??}, the adequacy of the \ac{NFA} string rewriting specification, we arrive at:
%
\begin{marginfigure}
  \begin{equation*}
    \rev{\atmR{w}} =
      \begin{cases*}
        (\octxe) & if $w = \emp$ \\
        \rev{\atmR{w}_0} \oc \atmR{a} & if $w = a \wc w_0$
      \end{cases*}
  \end{equation*}
  \caption{An anti-homomorphism from input words to sequences of right-directed messages.
    Notice that $\rev{\atmR{w}} = \theta(\rev{w})$, where $\rev{}$ is defined in \cref{??}.}\label{fig:formula-as-process:msg-rev}
\end{marginfigure}%
%
\begin{restatable}[
  name=Adequacy of the functional \acs*{NFA} choreography,
  label=cor:formula-as-process:nfa-fnchor-adequacy
]{corollary}{cornfafnchoradequacy}
  Let $\aut{A} = (Q, \nfapow, F)$ be \iac{NFA} over the input alphabet $\ialph$, with choreography $(\theta, \orsig)$ as described above.
  The following hold.
  \begin{itemize}[nosep]
  \item
    $q \nfareduces[a] q'_a$ only if $\atmR{a} \oc \defp{q} \reduces_{\orsig} \defp{q}'_a$.
    Also, if $\atmR{a} \oc \defp{q} \reduces_{\orsig} \octx'$, then $q \nfareduces[a] q'_a$ for some state $q'_a$ such that $\octx' = \defp{q}'_a$.
  \item
    $q \in F$ if, and only if, $\atmR{\eow} \oc \defp{q} \reduces_{\orsig} (\octxe)$.
  \item
    $q \nfareduces[w] q'$ only if $\rev{\atmR{w}} \oc \defp{q} \Reduces_{\orsig} \defp{q}'$.
    Also, if $\rev{\atmR{w}} \oc \defp{q} \Reduces_{\orsig} \octx'$, then $q \nfareduces[w] q'$ for some state $q'$ such that $\octx' = \defp{q}'$.
  \end{itemize}
\end{restatable}
\noindent
This \lcnamecref{cor:formula-as-process:nfa-fnchor-adequacy} gives -- nearly for free -- an end-to-end adequacy result for the functional \ac{NFA} choreography with respect to the mathematical model of \acp{NFA}.
Examining the first part, its first clause captures the completeness of the choreography: each \ac{NFA} transition is simulated by a corresponding rewriting in the choreography.
The second clause captures the soundness of the choreography: each rewriting simulates some \ac{NFA} transition.



\subsection{An object-oriented choreography}\label{sec:formula-as-process:nfa-oo}

Once again, the functional choreography is not the only choreography possible for the \ac{NFA} specification.
As for the binary counter, there is an \enquote*{object-oriented} choreography that treats the states as messages that effect a response from processes that represent symbols of an input word.
In this way, we may use a role assignment that is roughly dual to the assignment used in the preceding functional choreography.

Specifically, let $\theta'$ be%
\marginnote{$
    \theta' =
      \!\begin{lgathered}[t]
        \Set{ a \mapsto \defp{a} \given a \in \ialph } \union \Set{ \eow \mapsto \defp{\eow} } \\
        {} \union \Set{ q \mapsto \atmL{q} \given q \in Q } \\
        {} \union \Set{ \symrej \mapsto \atmR{\symrej} }
      \end{lgathered}
$}
the role assignment that maps each input symbol $a \in \ialph$ and the end-of-word marker, $\eow$, to coinductively defined propositions, $\defp{a}$ and $\defp{\eow}$, respectively; each state $q \in Q$ to a left-directed message, $\atmL{q}$; and the rejection symbol, $\symrej$, to a right-directed message, $\atmR{\symrej}$.

Under the role assignment $\theta'$, the axioms in $\srsig$ that mention $a$ and $\eow$ in their premises induce the rewritings
\begin{equation*}
  {\textstyle \bigunion_{q \in Q} \Set{ \ereduces[\orsig']{\defp{a} \oc \atmL{q}}{\atmL{q}'_a} \given q'_a \in \nfapow(q, a) } }
  \quad\text{and}\quad
  {\textstyle \bigunion_{q \in Q} \Set{ \ereduces[\orsig']{\defp{\eow} \oc \atmL{q}}{\atmR{F}(q)} } }
  \,,
\end{equation*}
respectively,
as constraints on $\orsig'$ that must be satisfied if $(\theta', \orsig')$ is to be a meaningful choreography of the \ac{NFA} specification.
Solving these constraints for $\defp{a}$ and $\defp{\eow}$, respectively, we obtain the definitions
\begin{equation*}
  \defp{a} \defd \bigwith_{q \in Q} \bigl({\textstyle \bigwith_{q'_a \in \nfapow(q, a)} (\atmL{q}'_a \pmir \atmL{q})}\bigr)
  \quad\text{and}\quad
  \defp{\eow} \defd \bigwith_{q \in Q} \bigl(\up \bigfuse \atmR{F}(q) \pmir \atmL{q}\bigr)
  \,.
\end{equation*}
In full, the choreographing signature $\orsig'$ is therefore
\begin{equation*}
  \orsig' =
  \bigl(\defp{\eow} \defd {\textstyle \bigwith_{q \in Q} (\up \bigfuse \atmR{F}(q) \pmir \atmL{q})}\bigr)
  \,,
  \biggl(
    \defp{a} \defd \bigwith_{q \in Q} \bigl(\textstyle \bigwith_{q'_a \in \nfapow(q, a)} (\atmL{q}'_a \pmir \atmL{q})
  \bigr)
  \biggr)_{a \in \ialph}
\end{equation*}
\noindent
Indeed, this is the same choreographing signature that is produced by the formal procedure:
\begin{proposition}
  For the string rewriting specification $(\ialph \dunion \Set{\eow, \symrej}, \srsig)$ and role assignment $\theta'$, the judgment $\chorsig{\theta'}{\srsig}{\orsig'}$ holds.
\end{proposition}

As for the functional choreography, we may then establish a shortcut adequacy theorem for this object-oriented choreography as a \lcnamecref{??} of earlier results.
Composing this \lcnamecref{??} with \cref{??}, the adequacy of formula-as-process choreographies with respect to their underlying string rewriting specifications, we arrive at:
\begin{corollary}\label{cor:formula-as-process:nfa-oochor-adequacy}
  Let $\aut{A} = (Q, \nfapow, F)$ be \iac{NFA} over the input alphabet $\ialph$, with choreography $(\theta', \orsig')$ as described above.
  The following hold.
  \begin{itemize}[nosep]
  \item
    $q \nfareduces[a] q'_a$ only if $\defp{a} \oc \atmL{q} \reduces_{\orsig'} \atmL{q}'_a$.
    Also, if $\defp{a} \oc \atmL{q} \reduces_{\orsig'} \octx'$, then $q \nfareduces[a] q'_a$ for some state $q'_a$ such that $\octx' = \atmL{q}'_a$.
  \item
    $q \in F$ if, and only if, $\defp{\eow} \oc \atmL{q} \reduces_{\orsig'} (\octxe)$.
  \item
    $q \nfareduces[w] q'$ only if $\rev{\defp{w}} \oc \atmL{q} \Reduces_{\orsig'} \atmL{q}'$.
    Also, if $\rev{\defp{w}} \oc \atmL{q} \Reduces_{\orsig'} \octx'$, then $q \nfareduces[w] q'$ for some state $q'$ such that $\octx' = \atmL{q}'$.
  \end{itemize}
\end{corollary}
\noindent
Once again, this gives the adequacy of the object-oriented choreography of \acp{NFA} nearly for free.

However, there is one slight blemish to the soundness clauses.
Its premise, \enquote{If $\defp{a} \oc \atmL{q} \reduces_{\orsig'} \octx'$ \textelp{}} deals only with ideas from the choreography and ordered rewriting.
Its conclusion, however, entangles ideas from the mathematical model of the \ac{NFA} (\enquote{then $q \nfareduces[a] q'_a$ for some state $q'_a$ \textelp{}}) with ideas from the choreography (\enquote{\textelp{} such that $\octx' = \atmL{q}'_a$.}).
In a way, the soundness clause violates a kind of meta-level stratification.
Soundness should relate one model\fixnote{word choice?}, on the one hand, to another model, on the other hand, but that is not what happens here.

Fortunately, it is not difficult to rephrase the soundness clause in a way that adheres to the desired meta-level stratification.
Upon examining the definition of $\defp{a}$, a rewriting $\defp{a} \oc \atmL{q} \reduces_{\orsig'} \octx'$ exists if and, most importantly, only if $\octx' = \atmL{q}'$ for some state $q'$.
The statement of soundness is thus equivalent to:
\begin{itemize}
\item If $\defp{a} \oc \atmL{q} \reduces_{\orsig'} \atmL{q}'$, then $q \nfareduces[a] q'_a$ for some state $q'_a$ such that $\atmL{q}' = \atmL{q}'_a$.
\end{itemize}
But because there is a unique atom for each state, equality of state atoms coincides with equality of the states themselves.
Therefore, we can simplify the statement further and combine it with completeness:
\begin{corollary}[Adequacy of the object-oriented \acs*{NFA} choreography]\label{cor:formula-as-process:nfa-oochor-adequacy-simple}
  Let $\aut{A} = (Q, \nfapow, F)$ be \iac{NFA} over the input alphabet $\ialph$, with choreography $(\theta', \orsig')$ as described above.
  The following hold.
  \begin{itemize}[nosep]
  \item $q \nfareduces[a] q'$ if, and only if, $\defp{a} \oc \atmL{q} \reduces_{\orsig'} \atmL{q}'$.
  \item $q \in F$ if, and only if, $\defp{\eow} \oc \atmL{q} \reduces_{\orsig'} (\octxe)$.
  \item $q \nfareduces[w] q'$ if, and only if, $\rev{\defp{w}} \oc \atmL{q} \Reduces_{\orsig'} \atmL{q}'$.
  \end{itemize}
\end{corollary}

\subsection{Incorporating \acs*{NFA} bisimilarity}\label{sec:formula-as-process:nfa-bisim}

Recall from \cref{??} the nearly free adequacy result for the functional choreography of \acp{NFA}.
%
\cornfafnchoradequacy*
%
The soundness clause has the same blemish as the object-oriented choreography's soundness clause had: its conclusion violates a kind of meta-level stratification, mixing ideas from the mathematical model (\enquote{then $q \nfareduces[a] q'_a$ for some state $q'_a$ \textelp{}}) with ideas from the choreography (\enquote{\textelp{} such that $\octx' = \defp{q}'_a$.}).
It would be much nicer if we could rephrase soundness in a stratified way.

As for the object-oriented choreography, we can begin by noticing that a rewriting $\atmR{a} \oc \defp{q} \reduces_{\orsig} \octx'$ exists if, and only if, $\octx' = \defp{q}'$ for some state $q'$.
The statement of soundness is thus equivalent to:
\begin{itemize}
\item
  If $\atmR{a} \oc \defp{q} \reduces_{\orsig} \defp{q}'$, then $q \nfareduces[a] q'_a$ for some state $q'_a$ such that $\defp{q}' = \defp{q}'_a$.
\end{itemize}
This is still not quite satisfactory because the conclusion brings in choreographic ideas, namely $\defp{q}' = \defp{q}'_a$.
Is it possible to characterize this relationship between $q'$ and $q'_a$ natively in terms of the \ac{NFA}'s mathematical model?

% The second clause captures soundness, but is not phrased exactly as we might have hoped.
% Its premise is stated in terms of the choreography alone, but its conclusion mixes ideas from the \ac{NFA} model (namely $q \nfareduces[a] q'_a$) with ideas from the choreography (namely $\octx' = \defp{q}'_a$).
% This mixing of ideas is philosophically objectionable in the way it violates a kind of meta-level typing property -- 
% it would be much nicer if the conclusion used only ideas native to \acp{NFA}, for then soundness would cleanly relate the choreography, on the one hand, to the \ac{NFA} model, on the other hand.

% Upon examining the definition of $\defp{q}$, we notice that a rewriting $\atmR{a} \oc \defp{q} \reduces_{\orsig} \octx'$ exists if and, most importantly, only if $\octx' = \defp{q}'$ for some state $q'$.
% This allows us to revise the statement of soundness to the equivalent:
% \begin{itemize}
% \item
%   If $\atmR{a} \oc \defp{q} \reduces_{\orsig} \defp{q}'$, then $q \nfareduces[a] q'_a$ for some state $q'_a$ such that $\defp{q}' = \defp{q}'_a$.
% \end{itemize}
% However, this statement is still not quite satisfactory in that its conclusion, with $\defp{q}' = \defp{q}'_a$, still mixes in ideas from the choreography.
% Is it possible to characterize this relationship between $q'$ and $q'_a$ natively on the \ac{NFA}?

Unfortunately, this is not nearly as easy as it was for the object-oriented choreography.
Unlike there, equality of state encodings does not coincide with equality of the states themselves, \ie, $\defp{q}' = \defp{q}'_a$ does \emph{not} imply $q' = q'_a$.
The equirecursive treatment of coinductively defined propositions leads to a quite generous notion of equality on propositions, which in turn makes equality of state encodings a coarser equivalence than equality of the states themselves.
% Because the coinductively defined propositions are interpreted equirecursively, equality of encodings is too generous to imply equality of states.
%
\begin{marginfigure}
    \centering
    % \subfloat[][]{\label{fig:ordered-rewriting:dfa-counterexample:dfa}%
      \begin{equation*}
        \aut{A}'_2 = 
        \begin{tikzpicture}[baseline=(q_0.base)]
          \graph [automaton] {
            q_0
             -> ["a,b", loop above]
            q_0
             -> ["b"]
            q_1 [accepting]
             -> ["a,b"]
            q_2
             -> ["a,b", loop above]
            q_2;
            %
            s_1 [accepting, below = of q_1.south]
             -> ["a,b" sloped]
            q_2;
          };
        \end{tikzpicture}
      \end{equation*}

  \begin{equation*}
    \orsig =
    \begin{lgathered}[t]
      \bigl(\defp{q}_0 \defd (\atmR{a} \limp \up \dn \defp{q}_0) \with (\atmR{b} \limp (\up \dn \defp{q}_0 \with \up \dn \defp{q}_1)) \with (\atmR{\eow} \limp \up \atmR{\symrej})\bigr) \,, \\
      \bigl(\defp{q}_1 \defd (\atmR{a} \limp \up \dn \defp{q}_2) \with (\atmR{b} \limp \up \dn \defp{q}_2) \with (\atmR{\eow} \limp \up \one)\bigr) \,, \\
      \bigl(\defp{q}_2 \defd (\atmR{a} \limp \up \dn \defp{q}_2) \with (\atmR{b} \limp \up \dn \defp{q}_2) \with (\atmR{\eow} \limp \up \atmR{\symrej})\bigr) \,, \\
      \bigl(\defp{s}_1 \defd (\atmR{a} \limp \up \dn \defp{q}_2) \with (\atmR{b} \limp \up \dn \defp{q}_2) \with (\atmR{\eow} \limp \up \one)\bigr)
    \end{lgathered}
  \end{equation*}
    \caption{A slightly modified version of the \ac*{NFA} from \cref{fig:formula-as-process:nfa-example}; and a choreography}\label{fig:formula-as-process:nfa-counterexample}
  \end{marginfigure}%
% \begin{proof}[Counterexample]
  As a concrete counterexample, consider the \ac{NFA} and encoding shown in the adjacent \lcnamecref{fig:formula-as-process:nfa-counterexample}; it is the same \ac{NFA} as shown in \cref{fig:formula-as-process:nfa-example}, but with one added state, $s_1$, that is unreachable from the others.
    %
  % When encoded as an ordered rewriting specification, it corresponds to the following definitions:
  % \begin{equation*}
  %   \begin{lgathered}
  %     \dfa{q}_0 \defd (a \limp \dfa{q}_0) \with (b \limp \dfa{q}_1) \with (\emp \limp \top) \\
  %     \dfa{q}_1 \defd (a \limp \dfa{q}_0) \with (b \limp \dfa{q}_1) \with (\emp \limp \one) \\
  %     \dfa{s}_1 \defd (a \limp \dfa{q}_0) \with (b \limp \dfa{s}_1) \with (\emp \limp \one)
  %   \end{lgathered}
  % \end{equation*}
  In this counterexample, as a coinductive consequence of the equirecursive treatment of definitions, $\defp{q}_1 = \defp{s}_1$ but $q_1 \neq s_1$.
% \end{proof}

% As this counterexample shows, the failure of this claim stems from the fact that the choreography of states is not injective -- here, $q_1 \neq s_1$ even though $\defp{q}_1 = \defp{s}_1$.
% In other words, equality of state encodings is a coarser equivalence than equality of the states themselves.


One possible remedy for this lack of injectivity might be to revise the encoding to have a stronger nominal character.
By tagging each state's encoding with an atom that is unique to that state, we can make the encoding manifestly injective.
For instance, given the pairwise distinct atoms $\Set{\atmR{q} \given q \in F}$ and $\Set{\atmR{\bar{q}} \given q \in Q - F}$ to tag final and non-final states, respectively, we could define an alternative encoding, $\check{q}$:
%
\begin{equation*}
  \check{q} \defd
    (\atmR{\eow} \limp \up \atmR{\check{F}}(q))
    \with
    \bigwith_{a \in \ialph}\bigl(\atmR{a} \limp {\textstyle \bigwith_{q'_a \in \nfapow(q,a)} \up \dn \check{q}'_a}\bigr)
  %
  \enspace\text{where }
  %
  \atmR{\check{F}}(q) =
    \begin{cases*}
      \atmR{q} & if $q \in F$ \\
      \atmR{\bar{q}} & if $q \notin F$%
    \,.
    \end{cases*}
\end{equation*}
%
Under this alternative encoding, the states $q_1$ and $s_1$ of \cref{fig:ordered-rewriting:dfa-counterexample} are no longer a counterexample to injectivity:
Because $q_1$ and $s_1$ are distinct states, they correspond to distinct tags, and so $\check{q}_1 \neq \check{s}_1$.

% One possible remedy
% % for this apparent lack of adequacy
% might be to revise the encoding to have a stronger nominal character % .
% by tagging each state's encoding with an atom that is unique to that state.
% For instance, given the pairwise distinct atoms $\set{q \given q \in F}$ and $\set{\bar{q} \given q \in Q - F}$ to tag final and non-final states, respectively, we could define an alternative encoding, $\check{q}$, that is manifestly injective:
% %
% % \begin{marginfigure}
% \begin{gather*}
%   \check{q} \defd
%     \parens[size=big]{
%       \bigwith_{a \in \ialph}(a \limp \check{q}'_a)}
%     \with
%     \parens[size=big]{\emp \limp \check{F}(q)}
%   %
%   \shortintertext{where}
%   %
%   q \dfareduces[a] q'_a
%   \text{, for all input symbols $a \in \ialph$,\quad and\quad}
%   \check{F}(q) =
%     \begin{cases*}
%       q & if $q \in F$ \\
%       \bar{q} & if $q \notin F$%
%     \,.
%     \end{cases*}
% \end{gather*}
% % \end{marginfigure}%
% % , the encoding can be made to be injective.
% % With this change, the alternative encoding is now injective: $\check{q} = \check{s}$ implies $q = s$.

Although such a solution is certainly possible, it seems unsatisfyingly ad~hoc.
A closer examination of the preceding counterexample reveals that the states $q_1$ and $s_1$, while not equal, are in fact bisimilar~\parencref{??}.
In other words, although the choreographing of states is not, strictly speaking, injective, it is injective \emph{up to bisimilarity}: $\defp{q} = \defp{s}$ implies $q \asim s$.
% This suggests a more elegant solution to the apparent lack of adequacy: the adequacy should be judged up to \ac{NFA} bisimilarity.

% A closer examination of the preceding counterexample reveals that the states $q_1$ and $s_1$, while not equal, are in fact bisimilar~\parencref{??}.
% In other words, although the encoding is not, strictly speaking, injective, it is injective \emph{up to bisimilarity}: $\dfa{q} = \dfa{s}$ implies $q \asim s$.
% This suggests a more elegant solution to the apparent lack of adequacy: the encoding's adequacy should be judged up to \ac{DFA} bisimilarity.

% This \lcnamecref{cor:formula-as-process:nfa-fnchor-adequacy} directly relates the automaton to its choreography, with one exception that is arguably unsatisfactory: an ordered context $\octx'$ is dragged into the second statement.
% Thus, we might like to rephrase this result so that the context $\octx'$ and condition $\octx' = \defp{q}'_a$ are replaced with conditions native to the \ac{NFA} itself.

% The first step is to notice that the definition of $\defp{q}$ is such that there is a rewriting $\atmR{a} \oc \defp{q} \reduces_{\orsig} \octx'$ if, and only if, $\octx' = \defp{s}'$ for some state $s'$.
% \begin{itemize}
% \item
%   If $\atmR{a} \oc \defp{q} \reduces_{\orsig} \defp{s}'$, then $q \nfareduces[a] q'_a$ for some state $q'_a$ such that $\defp{s}' = \defp{q}'_a$.
% \end{itemize}

% Can the relationship $\defp{q}' = \defp{q}'_a$ be stated natively on $q'$ and $a'_a$?
% Notice that $\defp{q} = \defp{s}$ implies that $q$ and $s$ are bisimilar states.
%
\begin{theorem}
  Let $\aut{A} = (Q, \nfapow, F)$ be \iac{NFA} over the input alphabet $\ialph$.
  For all states $q$ and $s$, if $\defp{q} = \defp{s}$, then $q \asim s$.
\end{theorem}
\begin{proof}
  We will show that the relation $\mathord{\simu{R}} = \Set{(q,s) \given \defp{q} = \defp{s}}$ is a bisimulation and is therefore included in \ac{NFA} bisimilarity.
  \begin{description}[parsep=0pt, listparindent=\parindent]
  \item[Input bisimilarity]
    We must show that, for all input symbols $a \in \ialph$, all $\simu{R}$-related states have $\simu{R}$-related $a$-successors. 

    Let $q$ and $s$ be $\simu{R}$-related states, which, being $\simu{R}$-related, have equal encodings, \ie, $\defp{q} = \defp{s}$.
    Because definitions are treated equirecursively, their unrollings are also equal.
    For each state $q'_a$ that $a$-succeeds $q$, there must therefore exist a state $s'_a$ such that $\defp{q}'_a = \defp{s}'_a$.
    In other words, each $a$-successor of state $q$ is $\simu{R}$-related to an $a$-successor of state $s$.

  \item[Finality]
    We must show that all $\simu{R}$-related states have matching finalities, \ie, that $q \simu{R} s$ implies $q \in F$ if, and only if, $s \in F$.

    Let $q$ and $s$ be $\simu{R}$-related states, with $q$ a final state.
    Being $\simu{R}$-related, the states $q$ and $s$ have equal encodings, \ie, $\defp{q} = \defp{s}$.
    Because definitions are treated equirecursively, their unrollings are also equal.
    It follows that $\atmR{F}(q) = \atmR{F}(s)$, and so $s$ is also a final state.
  %
  \qedhere
  \end{description}
\end{proof}


Unfortunately, the converse is not true: bisimilar \ac{NFA} states do not, in general, have equal encodings.
% \begin{falseclaim}
%   Let $\aut{A} = (Q, \nfapow, F)$ be \iac{NFA} over an input alphabet $\ialph$.
%   For all states $q,s \in Q$, if $q \asim s$, then $\defp{q} = \defp{s}$.
% \end{falseclaim}
% %
% \begin{proof}[Counterexample]
  As a concrete counterexample, consider the \ac{NFA} and choreography depicted in the adjacent \lcnamecref{fig:formula-as-process:nfa-bisim-falseclaim}.%
  \begin{marginfigure}
    \begin{equation*}
      \begin{tikzpicture}[baseline=(q_0.base)]
        \graph [automaton] {
          q_0 [accepting]
           -> ["a", loop above]
          q_0
           -> ["a"]
          q_1 [accepting]
           -> ["a", loop above]
          q_1;
        };
      \end{tikzpicture}
    \end{equation*}
    \begin{equation*}
      \begin{lgathered}[t]
        \defp{q}_0 \defd (\atmR{a} \limp \up \dn \defp{q}_0 \with \up \dn \defp{q}_1) \with (\atmR{\eow} \limp \up \one) \\
        \defp{q}_1 \defd (\atmR{a} \limp \up \dn \defp{q}_1) \with (\atmR{\eow} \limp \up \one)
      \end{lgathered}
    \end{equation*}
    \caption{\Iacs*{NFA} that accepts all finite words over the alphabet $\ialph = \Set{a}$}\label{fig:formula-as-process:nfa-bisim-falseclaim}
  \end{marginfigure}
  It is straightforward to verify that $q_0$ and $q_1$ are bisimilar states.
  But their encodings are not equal.
  Unrolling definitions, we have
  \begin{gather*}
    \defp{q}_0 = (\atmR{a} \limp \up \dn \defp{q}_0 \with \up \dn \defp{q}_1) \with (\atmR{\eow} \limp \up \one)
    \neq
    (\atmR{a} \limp \up \dn \defp{q}_1) \with (\atmR{\eow} \limp \up \one) = \defp{q}_1
    \,.
  \end{gather*}
  These propositions are not equal because the former has a first clause with shape $(\atmR{a} \limp \up \dn \mathord{-} \with \up \dn \mathord{-})$, whereas the latter's first clause has shape $(\atmR{a} \limp \up \dn \mathord{-})$.
  In other words, the encodings of states $q_0$ and $q_1$ are not equal precisely because the two states have different numbers of $a$-successors.
  
  In some sense, the generous equality induced by the equirecursive treatment of definitions has outpaced the remaining aspects of propositional equality.
  Because equality of state encodings does not coincide with bisimilarity of \ac{NFA} states, we cannot easily complete our program of simplifying the statement of \ac{NFA} soundness.

However, all is not lost.
First, although for \acp{NFA} bisimilar states do not always have equal encodings, for \emph{deterministic} finite automata bisimilar states do indeed have equal encodings.
\begin{theorem}
  Let $\aut{A} = (Q, \dfanext, F)$ be a \emph{\ac{DFA}} over an input alphabet $\ialph$.
  For all states $q$ and $s$, if $q \asim s$, then $\defp{q} = \defp{s}$.
\end{theorem}
%
\begin{proof}
  Because $\aut{A}$ is deterministic, the states $q$ and $s$ have unique $a$-successors for each input symbol $a \in \ialph$.
  Because $q$ and $s$ are bisimilar, so are their $a$-successors.
  By the coinductive hypothesis, the unique $a$-successors of $q$ and $s$ have equal encodings: $\defp{q}'_a = \defp{s}'_a$
\end{proof}
\noindent
Thus, for \acp{DFA} only, we have $\atmR{a} \oc \defp{q} \reduces_{\orsig} \defp{q}'$ if, and only if, $q \nfareduces[a]\asim q'$, which is properly stratified.

Second, in the following \lcnamecref{ch:??}, we will develop a richer notion of propositional equivalence, \emph{ordered rewriting bisimilarity}.
In applying it to the functional choreography of \acp{NFA}~\parencref{sec:??}, we will see that \ac{NFA} states that are \ac{NFA}-bisimilar have state encodings that, while not necessarily equal, are always rewriting-bisimilar; the converse will also hold.
This will allow us to rephrase soundness (and completeness) of the \ac{NFA} choreography to a form that is properly stratified: $\atmR{a} \oc \defp{q} \reduces_{\orsig}\osim \defp{q}'$ if, and only if, $q \nfareduces[a]\asim q'$.\fixnote{Check}




% % The \lcnamecref{cor:formula-as-process:nfa-fnchor-adequacy} is not phrased exactly how we might have hoped.
% % The first clause, completeness of the choreography with respect to the \ac{NFA}, cleanly relates each \ac{NFA} transition to a rewriting
% % It would be much nicer if the second clause, soundness of the choreography with respect to the \ac{NFA}, could be stated in terms of the \ac{NFA} and its choreography alone.

% % Greedily, we might have hoped for slightly more.
% % % This \lcnamecref{cor:formula-as-process:nfa-fnchor-adequacy} is [...], but perhaps unsatisfactory in one particular detail.
% % The second clause, soundness of the choreography with respect to the \ac{NFA}, drags in an ordered context $\octx'$.
% % It would be much nicer if the choreography's soundness could be stated in terms of the \ac{NFA} and its choreography alone.

% % The first step toward such a rephrasing is to notice that $\atmR{a} \oc \defp{q} \reduces_{\orsig} \octx'$ \emph{only if} $\octx' = \defp{q}'$ for some state $q'$.
% % Thus, the above statement of soundness is equivalent to:
% % \begin{itemize}
% % \item
% %   If $\atmR{a} \oc \defp{q} \reduces_{\orsig} \defp{q}'$, then $q \nfareduces[a] q'_a$ for some state $q'_a$ such that $\defp{q}' = \defp{q}'_a$.
% % \end{itemize}
% % Better


% % This \lcnamecref{cor:formula-as-process:nfa-fnchor-adequacy} is [...], but perhaps unsatisfactory in one particular detail.
% % The second clause, soundness of the choreography with respect to the \ac{NFA}, drags in an ordered context $\octx'$.
% % It would be much nicer if the choreography's soundness were a direct converse of its completeness, as in:
% % \begin{itemize}
% % \item If $\atmR{a} \oc \defp{q} \reduces_{\orsig} \defp{q}'_a$, then $q \nfareduces[a] q'_a$.
% % \end{itemize}
% % Unfortunately, this claim is, in fact, false.
% % %

% We might naively hope that the equality of state encodings would coincide with equality of the states themselves, \ie, that $\defp{q}' = \defp{q}'_a$ if, and only if, $q' = q'_a$.
% That way, soundness would be simply \enquote{If $\atmR{a} \oc \defp{q} \reduces_{\orsig} \defp{q}'$, then $q \nfareduces[a] q'$,} which would satisfy the kind of meta-level typing that we desire.

% Unfortunately, the two equalities do not coincide because the encoding of \ac{NFA} states is simply not injective.
% The equirecursive treatment of coinductively defined propositions leads to a quite generous notion of equality on propositions, which in turn makes equality of state encodings a coarser equivalence than equality of the states themselves.
% % Because the coinductively defined propositions are interpreted equirecursively, equality of encodings is too generous to imply equality of states.
% %
% \begin{marginfigure}
%     \centering
%     % \subfloat[][]{\label{fig:ordered-rewriting:dfa-counterexample:dfa}%
%       \begin{equation*}
%         \aut{A}'_2 = 
%         \begin{tikzpicture}[baseline=(q_0.base)]
%           \graph [automaton] {
%             q_0
%              -> ["a,b", loop above]
%             q_0
%              -> ["b"]
%             q_1 [accepting]
%              -> ["a,b"]
%             q_2
%              -> ["a,b", loop above]
%             q_2;
%             %
%             s_1 [accepting, below = of q_1.south]
%              -> ["a,b" sloped]
%             q_2;
%           };
%         \end{tikzpicture}
%       \end{equation*}

%   \begin{equation*}
%     \orsig =
%     \begin{lgathered}[t]
%       \bigl(\defp{q}_0 \defd (\atmR{a} \limp \up \dn \defp{q}_0) \with (\atmR{b} \limp (\up \dn \defp{q}_0 \with \up \dn \defp{q}_1)) \with (\atmR{\eow} \limp \up \atmR{\symrej})\bigr) \,, \\
%       \bigl(\defp{q}_1 \defd (\atmR{a} \limp \up \dn \defp{q}_2) \with (\atmR{b} \limp \up \dn \defp{q}_2) \with (\atmR{\eow} \limp \up \one)\bigr) \,, \\
%       \bigl(\defp{q}_2 \defd (\atmR{a} \limp \up \dn \defp{q}_2) \with (\atmR{b} \limp \up \dn \defp{q}_2) \with (\atmR{\eow} \limp \up \atmR{\symrej})\bigr) \,, \\
%       \bigl(\defp{s}_1 \defd (\atmR{a} \limp \up \dn \defp{q}_2) \with (\atmR{b} \limp \up \dn \defp{q}_2) \with (\atmR{\eow} \limp \up \one)\bigr)
%     \end{lgathered}
%   \end{equation*}
%     \caption{A slightly modified version of the \ac*{NFA} from \cref{fig:formula-as-process:nfa-example}; and a choreography}\label{fig:formula-as-process:nfa-counterexample}
%   \end{marginfigure}%
% % \begin{proof}[Counterexample]
%   As a concrete counterexample to injectivity, consider the \ac{NFA} and encoding shown in the adjacent \lcnamecref{fig:formula-as-process:nfa-counterexample}; it is the same \ac{NFA} as shown in \cref{fig:formula-as-process:nfa-example}, but with one added state, $s_1$, that is unreachable from the other states.
%     %
%   % When encoded as an ordered rewriting specification, it corresponds to the following definitions:
%   % \begin{equation*}
%   %   \begin{lgathered}
%   %     \dfa{q}_0 \defd (a \limp \dfa{q}_0) \with (b \limp \dfa{q}_1) \with (\emp \limp \top) \\
%   %     \dfa{q}_1 \defd (a \limp \dfa{q}_0) \with (b \limp \dfa{q}_1) \with (\emp \limp \one) \\
%   %     \dfa{s}_1 \defd (a \limp \dfa{q}_0) \with (b \limp \dfa{s}_1) \with (\emp \limp \one)
%   %   \end{lgathered}
%   % \end{equation*}
%   Here, as a coinductive consequence of the equirecursive treatment of definitions, $\defp{q}_1 = \defp{s}_1$ but $q_1 \neq s_1$.
% % \end{proof}

% % As this counterexample shows, the failure of this claim stems from the fact that the choreography of states is not injective -- here, $q_1 \neq s_1$ even though $\defp{q}_1 = \defp{s}_1$.
% % In other words, equality of state encodings is a coarser equivalence than equality of the states themselves.


% One possible remedy for this lack of injectivity might be to revise the encoding to have a stronger nominal character.
% By tagging each state's encoding with an atom that is unique to that state, we can make the encoding manifestly injective.
% For instance, given the pairwise distinct atoms $\Set{\atmR{q} \given q \in F}$ and $\Set{\atmR{\bar{q}} \given q \in Q - F}$ to tag final and non-final states, respectively, we could define an alternative encoding, $\check{q}$:
% %
% \begin{equation*}
%   \check{q} \defd
%     (\atmR{\eow} \limp \up \bigfuse \atmR{\check{F}}(q))
%     \with
%     \bigwith_{a \in \ialph}\bigl(\atmR{a} \limp {\textstyle \bigwith_{q'_a \in \nfapow(q,a)} \up \dn \check{q}'_a}\bigr)
%   %
%   \enspace\text{where }
%   %
%   \atmR{\check{F}}(q) =
%     \begin{cases*}
%       \atmR{q} & if $q \in F$ \\
%       \atmR{\bar{q}} & if $q \notin F$%
%     \,.
%     \end{cases*}
% \end{equation*}
% %
% Under this alternative encoding, the states $q_1$ and $s_1$ of \cref{fig:ordered-rewriting:dfa-counterexample} are no longer a counterexample to injectivity:
% Because $q_1$ and $s_1$ are distinct states, they correspond to distinct tags, and so $\check{q}_1 \neq \check{s}_1$.

% % One possible remedy
% % % for this apparent lack of adequacy
% % might be to revise the encoding to have a stronger nominal character % .
% % by tagging each state's encoding with an atom that is unique to that state.
% % For instance, given the pairwise distinct atoms $\set{q \given q \in F}$ and $\set{\bar{q} \given q \in Q - F}$ to tag final and non-final states, respectively, we could define an alternative encoding, $\check{q}$, that is manifestly injective:
% % %
% % % \begin{marginfigure}
% % \begin{gather*}
% %   \check{q} \defd
% %     \parens[size=big]{
% %       \bigwith_{a \in \ialph}(a \limp \check{q}'_a)}
% %     \with
% %     \parens[size=big]{\emp \limp \check{F}(q)}
% %   %
% %   \shortintertext{where}
% %   %
% %   q \dfareduces[a] q'_a
% %   \text{, for all input symbols $a \in \ialph$,\quad and\quad}
% %   \check{F}(q) =
% %     \begin{cases*}
% %       q & if $q \in F$ \\
% %       \bar{q} & if $q \notin F$%
% %     \,.
% %     \end{cases*}
% % \end{gather*}
% % % \end{marginfigure}%
% % % , the encoding can be made to be injective.
% % % With this change, the alternative encoding is now injective: $\check{q} = \check{s}$ implies $q = s$.

% Although such a solution is certainly possible, it seems unsatisfyingly ad~hoc.

% A closer examination of the preceding counterexample reveals that the states $q_1$ and $s_1$, while not equal, are in fact bisimilar~\parencref{??}.
% In other words, although the choreographing of states is not, strictly speaking, injective, it is injective \emph{up to bisimilarity}: $\defp{q} = \defp{s}$ implies $q \asim s$.
% This suggests a more elegant solution to the apparent lack of adequacy: the adequacy should be judged up to \ac{NFA} bisimilarity.

% % A closer examination of the preceding counterexample reveals that the states $q_1$ and $s_1$, while not equal, are in fact bisimilar~\parencref{??}.
% % In other words, although the encoding is not, strictly speaking, injective, it is injective \emph{up to bisimilarity}: $\dfa{q} = \dfa{s}$ implies $q \asim s$.
% % This suggests a more elegant solution to the apparent lack of adequacy: the encoding's adequacy should be judged up to \ac{DFA} bisimilarity.

% % This \lcnamecref{cor:formula-as-process:nfa-fnchor-adequacy} directly relates the automaton to its choreography, with one exception that is arguably unsatisfactory: an ordered context $\octx'$ is dragged into the second statement.
% % Thus, we might like to rephrase this result so that the context $\octx'$ and condition $\octx' = \defp{q}'_a$ are replaced with conditions native to the \ac{NFA} itself.

% % The first step is to notice that the definition of $\defp{q}$ is such that there is a rewriting $\atmR{a} \oc \defp{q} \reduces_{\orsig} \octx'$ if, and only if, $\octx' = \defp{s}'$ for some state $s'$.
% % \begin{itemize}
% % \item
% %   If $\atmR{a} \oc \defp{q} \reduces_{\orsig} \defp{s}'$, then $q \nfareduces[a] q'_a$ for some state $q'_a$ such that $\defp{s}' = \defp{q}'_a$.
% % \end{itemize}

% % Can the relationship $\defp{q}' = \defp{q}'_a$ be stated natively on $q'$ and $a'_a$?
% % Notice that $\defp{q} = \defp{s}$ implies that $q$ and $s$ are bisimilar states.
% %
% \begin{theorem}
%   Let $\aut{A} = (Q, \nfapow, F)$ be \iac{NFA} over the input alphabet $\ialph$.
%   For all states $q,s \in Q$, if $\defp{q} = \defp{s}$, then $q \asim s$.
% \end{theorem}
% \begin{proof}
%   We will show that the relation $\mathord{\simu{R}} = \Set{(q,s) \given \defp{q} = \defp{s}}$ is a bisimulation and is therefore included in \ac{NFA} bisimilarity.
%   \begin{description}[parsep=0pt, listparindent=\parindent]
%   \item[Input bisimilarity]
%     We must show that, for all input symbols $a \in \ialph$, all $\simu{R}$-related states have $\simu{R}$-related $a$-successors. 

%     Let $q$ and $s$ be $\simu{R}$-related states, which, being $\simu{R}$-related, have equal encodings, \ie, $\defp{q} = \defp{s}$.
%     Because definitions are treated equirecursively, their unrollings are also equal.
%     For each state $q'_a$ that $a$-succeeds $q$, there must therefore exist a state $s'_a$ such that $\defp{q}'_a = \defp{s}'_a$.
%     In other words, each $a$-successor of state $q$ is $\simu{R}$-related to an $a$-successor of state $s$.

%   \item[Finality]
%     We must show that all $\simu{R}$-related states have matching finalities, \ie, that $q \simu{R} s$ implies $q \in F$ if, and only if, $s \in F$.

%     Let $q$ and $s$ be $\simu{R}$-related states, with $q$ a final state.
%     Being $\simu{R}$-related, the states $q$ and $s$ have equal encodings, \ie, $\defp{q} = \defp{s}$.
%     Because definitions are treated equirecursively, their unrollings are also equal.
%     It follows that $\atmR{F}(q) = \atmR{F}(s)$, and so $s$ is also a final state.
%   %
%   \qedhere
%   \end{description}
% \end{proof}


% Unfortunately, the converse is not true: bisimilar \ac{NFA} states do not, in general, have equal encodings.
% % \begin{falseclaim}
% %   Let $\aut{A} = (Q, \nfapow, F)$ be \iac{NFA} over an input alphabet $\ialph$.
% %   For all states $q,s \in Q$, if $q \asim s$, then $\defp{q} = \defp{s}$.
% % \end{falseclaim}
% % %
% % \begin{proof}[Counterexample]
%   As a concrete counterexample, consider the \ac{NFA} and choreography depicted in the adjacent \lcnamecref{fig:formula-as-process:nfa-bisim-falseclaim}.%
%   \begin{marginfigure}
%     \begin{equation*}
%       \begin{tikzpicture}[baseline=(q_0.base)]
%         \graph [automaton] {
%           q_0 [accepting]
%            -> ["a", loop above]
%           q_0
%            -> ["a"]
%           q_1 [accepting]
%            -> ["a", loop above]
%           q_1;
%         };
%       \end{tikzpicture}
%     \end{equation*}
%     \begin{equation*}
%       \begin{lgathered}[t]
%         \defp{q}_0 \defd (\atmR{a} \limp \up \dn \defp{q}_0 \with \up \dn \defp{q}_1) \with (\atmR{\eow} \limp \up \one) \\
%         \defp{q}_1 \defd (\atmR{a} \limp \up \dn \defp{q}_1) \with (\atmR{\eow} \limp \up \one)
%       \end{lgathered}
%     \end{equation*}
%     \caption{\Iacs*{NFA} that accepts all finite words over the alphabet $\ialph = \Set{a}$}\label{fig:formula-as-process:nfa-bisim-falseclaim}
%   \end{marginfigure}
%   It is straightforward to verify that $q_0$ and $q_1$ are bisimilar states.
%   But their encodings are not equal.
%   Unrolling definitions, we have
%   \begin{gather*}
%     \defp{q}_0 = (\atmR{a} \limp \up \dn \defp{q}_0 \with \up \dn \defp{q}_1) \with (\atmR{\eow} \limp \up \one)
%     \neq
%     (\atmR{a} \limp \up \dn \defp{q}_1) \with (\atmR{\eow} \limp \up \one) = \defp{q}_1
%     \,.
%   \end{gather*}
%   These propositions are not equal because the former has a first clause with shape $(\atmR{a} \limp \up \dn \mathord{-} \with \up \dn \mathord{-})$, whereas the latter's first clause has shape $(\atmR{a} \limp \up \dn \mathord{-})$.
%   In other words, the encodings of states $q_0$ and $q_1$ are not equal precisely because the two states have different numbers of $a$-successors.
  
%   In some sense, the generous equality induced by our equirecursive treatment of definitions has outpaced the remaining aspects of propositional equality.
%   Because equality of state encodings does not coincide with bisimilarity of \ac{NFA} states, we cannot complete our program of simplifying the statement of soundness.
%   However, as we will see in \cref{ch:??}, bisimilarity of states does coincide with a notion of bisimilarity for state encodings.

% \begin{theorem}
%   Let $\aut{A} = (Q, ?, F)$ be a \emph{\ac{DFA}} over an input alphabet $\ialph$.
%   For all states $q$ and $s$, if $q \asim s$, then $\defp{q} = \defp{s}$.
% \end{theorem}
% %
% \begin{proof}
%   Being \iac{DFA}, the states $q$ and $s$ have unique $a$-successors for each input symbol $a \in \ialph$.
%   Because $q$ and $s$ are bisimilar, so are their $a$-successors.
%   By the coinductive hypothesis, the unique $a$-successors of $q$ and $s$ have equal encodings: $\defp{q}'_a$
% \end{proof}








%%% Local Variables:
%%% mode: latex
%%% TeX-master: "thesis"
%%% End:
