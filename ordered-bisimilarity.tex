\chapter{From ordered rewriting to concurrency}\label{ch:ordered-bisimilarity}

\begin{syntax*}
  Propositions &
    A & p \mid \atmL{a} \mid \atmR{a}
          \mid \atmR{a} \limp A \mid A \pmir \atmL{a}
          \mid A \fuse B \mid \one
          \mid A \with B \mid \top
  \\
  Ordered contexts & 
    \octx & \octxe \mid \octx_1 \oc \octx_2 \mid A
\end{syntax*}

\begin{itemize}
\item Assign direction to uninterpreted atoms so they act like messages
\item Defined atoms are like processes
\item Left and right implications are restricted to messages (compare with higher-order $\pi$ calculus)
\end{itemize}

\section{Input transitions}

\begin{inferences}
  \infer{\ireduces{\atmR{a} \oc #1}{\atmR{a} \limp A}{A}}{}
  \and
  \infer{\ireduces{#1 \oc \atmL{a}}{A \pmir \atmL{a}}{A}}{}
  \\
  \infer{\ireduces{\atmR{a} \oc #1}{\octx \oc B}{\octx' \oc B}}{
    \ireduces{\atmR{a} \oc #1}{\octx}{\octx'}}
  \and
  \infer{\ireduces{#1 \oc \atmL{a}}{B \oc \octx}{B \oc \octx'}}{
    \ireduces{#1 \oc \atmL{a}}{\octx}{\octx'}}
\end{inferences}
Ultimately, $\ireduces{\atmR{a} \oc #1}{\octx}{\octx'}$ holds exactly when $\octx = (\atmR{a} \limp A) \oc \octx'_R$ and $\octx' = A \oc \octx'_R$ for some $\octx'_R$.
Symmetrically, $\ireduces{#1 \oc \atmL{a}}{\octx}{\octx'}$ holds exactly when $\octx = \octx'_L \oc (A \pmir \atmL{a})$ and $\octx' = \octx'_L \oc A$ for some $\octx'_L$.

\begin{theorem}
  If $\ireduces{\atmR{a} \oc #1}{\octx}{\octx'}$, then $\atmR{a} \oc \octx \reduces \octx'$.
  Symmetrically, if $\ireduces{#1 \oc \atmL{a}}{\octx}{\octx'}$, then $\octx \oc \atmL{a} \reduces \octx'$.
\end{theorem}

\begin{theorem}
  If $\octx \reduces \octx'$, then either:
  \begin{itemize}[nosep]
  \item $\octx = \octx_L \oc \atmR{a} \oc \octx_0 \oc \octx_R$ and $\ireduces{\atmR{a} \oc #1}{\octx_0}{\octx'_0}$ and $\octx' = \octx_L \oc \octx'_0 \oc \octx_R$;
  \item $\octx = \octx_L \oc \octx_0 \oc \atmL{a} \oc \octx_R$ and $\ireduces{#1 \oc \atmL{a}}{\octx_0}{\octx'_0}$ and $\octx' = \octx_L \oc \octx'_0 \oc \octx_R$;
  \item $\octx = \octx_L \oc (A \fuse B) \oc \octx_R$ and $\octx' = \octx_L \oc A \oc B \oc \octx_R$;
  \item $\octx = \octx_L \oc \one \oc \octx_R$ and $\octx' = \octx_L \oc \octx_R$;
  \item $\octx = \octx_L \oc (A \with B) \oc \octx_R$ and $\octx' = \octx_L \oc A \oc \octx_R$; or
  \item $\octx = \octx_L \oc (A \with B) \oc \octx_R$ and $\octx' = \octx_L \oc B \oc \octx_R$.
  \end{itemize}
\end{theorem}

\section{}

\begin{definition}
  \vocab{Ordered bisimilarity} is the largest \emph{symmetric} binary relation among contexts that satisfies the following conditions.
  \begin{thmdescription}
  \item[Output bisimilarity]
    If $\octx \miso\Reduces \atm{\lctx}'_L \oc \lctx' \oc \atm{\lctx}'_R$, then $\octx \Reduces\lrframe{\atm{\lctx}'_L}{\osim}{\atm{\lctx}'_R}^{-1} \atm{\lctx}'_L \oc \lctx' \oc \atm{\lctx}'_R$.
  \item[Input bisimilarity]
    If $\atmR{a} \oc \octx \lframe{\atmR{a}}{\osim}^{-1}\Reduces \lctx'$, then $\atmR{a} \oc \octx \Reduces\miso \lctx'$.
    Symmetrically, if $\octx \oc \atmL{a} \rframe{\osim}{\atmL{a}}^{-1}\Reduces \lctx'$, then $\octx \oc \atmL{a} \Reduces\miso \lctx'$.
  \item[Reduction bisimilarity]
    If $\octx \miso\Reduces \lctx'$, then $\octx \Reduces\miso \lctx'$.
  \end{thmdescription}
\end{definition}

\begin{definition}
  \vocab{Ordered bisimilarity} is the largest \emph{symmetric} binary relation among contexts that satisfies the following conditions.
  \begin{thmdescription}
  \item[Output bisimilarity]
    If $\octx \miso\Reduces \atmL{\lctx}'_L \oc \lctx' \oc \atmR{\lctx}'_R$, then $\octx \Reduces\lrframe{\atmL{\lctx}'_L}{\osim}{\atmR{\lctx}'_R}^{-1} \atmL{\lctx}'_L \oc \lctx' \oc \atmR{\lctx}'_R$.
  \item[Input bisimilarity]
    If $\atmR{\lctx}_L \oc \octx \oc \atmL{\lctx}_R \lrframe{\atmR{\lctx}_L}{\osim}{\atmL{\lctx}_R}^{-1}\Reduces \lctx'$, then $\atmR{\lctx}_L \oc \octx \oc \atmL{\lctx}_R \Reduces\miso \lctx'$.
  \end{thmdescription}
\end{definition}

\subsection{Counterexample}


This definition is too fine, ruling out desirable equivalences.
For example, $e \oc b_0 \not\osim e$.
Suppose, for the sake of deriving a contradiction, that $e \oc b_0 \osim e$.
Because $e \oc b_0 \oc \atm{d} \Reduces \atm{z} \oc b'_0$, it follows from input bisimilarity that $e \oc \atm{d} \Reduces\miso \atm{z} \oc b'_0$.
So either $\atm{z} \oc b'_0 \osim e \oc \atm{d}$ or $\atm{z} \oc b'_0 \osim \atm{z}$.
The former is impossible because $\atm{z} \oc b'_0$ cannot produce $\atm{d}$ on the right\footnote{Nor, in fact, on the left.} and so violates output bisimilarity.

The latter is also impossible.
It has an output of $\atm{z}$ on the left of $\atm{z} \oc b'_0$, from which output bisimilarity yields $b'_0 \osim \octxe$.
From input bisimilarity, $b'_0 \oc \atm{a} \osim \atm{a}$ follows, for any $\atm{a}$.
And, that violates output bisimilarity because $b'_0 \oc \atm{a}$, which does not reduce, cannot match the left output that $\atm{a}$ makes.

The key feature of this counterexample is that atoms' lack of direction means that the output bisimilarity condition also applies to atoms intended to act as inputs ($\atm{d}$ and $\atm{a}$, for instance).

\section{A proof technique for ordered bisimilarity}

\begin{theorem}\label{thm:ord-bisim-technique}
  Let $\simu{R}$ be a \emph{symmetric} binary relation among contexts that satisfies the following conditions.
  \begin{thmdescription}
  \item[Immediate output bisimulation]
    If $\lctx = \atmL{\lctx}'_L \oc \lctx' \oc \atmR{\lctx}'_R \simu{R} \octx$, then $\octx \Reduces\lrframe{\atmL{\lctx}'_L}{\refl{\simu{R}}}{\atmR{\lctx}'_R}^{-1} \lctx$.
  \item[Immediate input bisimulation]
    If $\lctx \simu{R} \octx$ and $\ireduces{\atmR{\lctx}_L \oc #1 \oc \atmL{\lctx}_L}{\lctx}{\lctx'}$, then $\atmR{\lctx}_L \oc \octx \oc \atmL{\lctx}_R \Reduces\refl*{\simu{R}}^{-1} \lctx'$.
  \item[Reduction bisimulation]
    If $\octx \simu{R}^{-1}\reduces \lctx'$, then $\octx \Reduces\refl*{\simu{R}}^{-1} \lctx'$.
  \item[Emptiness bisimulation]
    If $\octxe \simu{R} \octx$, then:
    \begin{itemize}
    \item $\atmR{\lctx} \oc \octx \Reduces\rframe{\refl{\simu{R}}}{\atmR{\lctx}}^{-1} \atmR{\lctx}$ for all $\atmR{\lctx}$; and
    \item $\octx \oc \atmL{\lctx} \Reduces\lframe{\atmL{\lctx}}{\refl{\simu{R}}}^{-1} \atmL{\lctx}$ for all $\atmL{\lctx}$.
    \end{itemize}
  \end{thmdescription}
  Then $\refl{\simu{R}}$ is included in ordered bisimilarity.
\end{theorem}


\section{Examples of ordered bisimilarity}

\subsection{\Aclp*{NFA}}

\begin{theorem}
  If $q \asim s$, then $\nfa{q} \osim \nfa{s}$.
\end{theorem}
%
\begin{proof}
  Let $\simu{R}$ be the least binary relation%
  \alertnote{What about symmetry?}
  on ordered contexts given by
  \begin{equation*}
    \infer{\nfa{q} \simu{R} \nfa{s}}{
      q \asim s}
  \end{equation*}
  To establish the completness of our \ac{NFA} encoding with respect to bisimularity, it then suffices to show that ordered bisimularity contains the relation $\simu{R}$.
  Appealing to the preceding proof technique for ordered bisimilarity\parencref{thm:ord-bisim-technique}, we need only establish that $\simu{R}$ has immediate output bisimulation, immediate input bisimulation, reduction bisimulation, and emptiness bisimulation properties.

  Only the immediate input bisimulation and reduction bisimulation conditions apply to the relation $\simu{R}$.
  \begin{description}
  \item[Immediate input bisimulation]
    Assume that $\lctx \simu{R} \octx$ and $\ireduces{\atmR{\lctx}_L \oc #1 \oc \atmL{\lctx}_R}{\lctx}{\lctx'}$;
    we must show that $\atmR{\lctx}_L \oc \octx \oc \atmL{\lctx}_R \Reduces\refl*{\simu{R}}^{-1} \lctx'$.

    Inversion allows us to deduce $\lctx = \nfa{q}$ and $\octx = \nfa{s}$ for some states $q$ and $s$ such that $q \asim s$.
    Examining the encoding, we see that there are two possible input transitions from $\nfa{q}$.
    \begin{itemize}
    \item Consider the input transition $\ireduces{\atmR{a} \oc #1}{\nfa{q}}{\nfa{q}'_a}$, with $a \in \ialph$ and $q \nfareduces[a] q'_a$ -- that is, $\atmR{\lctx}_L = \atmR{a}$; $\atmL{\lctx}_R = \octxe$; and $\lctx' = \nfa{q}'_a$.
      We must show that $\atmR{a} \oc \nfa{s} \Reduces\refl*{\simu{R}}^{-1} \nfa{q}'_a$.

      Because $q$ and $s$ are bisimilar states, $s \nfareduces[a] s'_a \misa q'_a$ for some state $s'_a$.
      Recall from \cref{thm:nfa-encoding-reduces} that the encoding of \acp{NFA} is complete with respect to input transitions; so, $\atmR{a} \oc \nfa{s} \reduces \nfa{s}'_a$.
      As $q'_a$ and $s'_a$ are bisimilar states, we conclude that $\atmR{a} \oc \nfa{s} \reduces\refl*{\simu{R}}^{-1} \nfa{q}'_a$, as required.

    \item Consider the input transition $\ireduces{\atmR{\emp} \oc #1}{\nfa{q}}{\octxe}$ when $q$ is a final state -- that is, $\atmR{\lctx}_L = \atmR{\emp}$ and $\atmL{\lctx}_R = \lctx' = \octxe$.
      We must show that $\atmR{\emp} \oc \nfa{s} \Reduces\refl*{\simu{R}}^{-1} \octxe$.

      Because $q$ and $s$ are bisimilar states, $s$ must also be a final state.
      Recall from \cref{thm:nfa-encoding-reduces} that the encoding of \acp{NFA} is complete with respect to input transitions; so, $\atmR{\emp} \oc \nfa{s} \reduces \octxe$.
      We conclude that $\atmR{\emp} \oc \nfa{s} \reduces\refl*{\simu{R}}^{-1} \octxe$, as required.
    \end{itemize}
  %
  \item[Reduction bisimulation]
  \end{description}
\end{proof}

\begin{theorem}
  If $\nfa{q} \osim \nfa{s}$, then $q \asim s$.
\end{theorem}
%
\begin{proof}
  Let $\simu{R}$ be the binary relation on states such that $q \simu{R} s$ exactly when $\nfa{q} \osim \nfa{s}$.
  We will show that $\simu{R}$ is \iacs{NFA} bisimulation.

  Among other properties, we must show that $\simu{R}$ simulates inputs.
  Assume that $\nfa{s} \miso \nfa{q}$ and $q \nfareduces[a] q'$; we must show that $s \nfareduces[a] s'$ for some $s'$ such that $\nfa{s}' \miso \nfa{q}'$.
  Because $\atmR{a} \oc \nfa{q} \Reduces \nfa{q}'$, it follows by input bisimilarity that $\atmR{a} \oc \nfa{s} \Reduces\miso \nfa{q}'$.
  There are two cases, according to the structure of the reduction sequence from $\atmR{a} \oc \nfa{s}$.
  \begin{itemize}
  \item If the reduction sequence is trivial, then $\atmR{a} \oc \nfa{s} \miso \nfa{q}'$.
    Because the transition relation is left-total, $s \nfareduces[a] s'$ for some state $s'$.
    It follows that $\atmR{a} \oc \nfa{s} \Reduces \nfa{s}'$, and so, by input bisimilarity, $\nfa{q}' \Reduces\osim \nfa{s}'$.
    However, $\nfa{q}' \longarrownot\reduces$, allowing us to conclude that $\nfa{q}' \osim \nfa{s}'$.
  \item If the reduction sequence is nontrivial, then $\atmR{a} \oc \nfa{s} \reduces\Reduces\miso \nfa{q}'$.
    Then
    \begin{equation*}
      \with_{s^* \mid s \nfareduces[a] s^*} \nfa{s}^* \Reduces\miso \nfa{q}'
    \end{equation*}
    It follows that $\with_{s^* \in S} \nfa{s}^* \miso \nfa{q}$ where $S$ is a subset of the $a$-successors of state $s$.
    Because bisimilarity is reduction-closed, $\nfa{s}^* \miso \nfa{q}'$ for each $s^* \in S$.

    How do we know that the subset $S$ is nonempty?
    In other words, what happens if $\top \miso \nfa{q}'$?
  \end{itemize}

  Assume that $\nfa{s} \miso \nfa{q}$ and $q$ is a final state;
  we must show that $s$ is also a final state.
  Because $q$ is final, $\atmR{\emp} \oc \nfa{q} \Reduces \octxe$.
  By input bisimilarity, $\atmR{\emp} \oc \nfa{s} \Reduces\miso \octxe$.
  Choose a fresh atom $\atmR{x}$.
  It follows by emptiness bisimilarity that $\atmR{x} \oc \atmR{\emp} \oc \nfa{s} \Reduces\rframe{\osim}{\atmR{x}}^{-1} \atmR{x}$.
  However, $\atmR{x} \oc \atmR{\emp} \oc \nfa{s}$ exposes $\atmR{x}$ on the right only if $s$ is also a final state.
\end{proof}

%%% Local Variables:
%%% mode: latex
%%% TeX-master: "thesis"
%%% End:
