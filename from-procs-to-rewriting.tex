\chapter{From processes to rewriting}

\section{A shallow embedding of processes in ordered rewriting}

\alertnote{Is this a shallow embedding?
Is HOAS deep or shallow?}

\begin{equation*}
  \begin{aligned}
    \trproc{\spawn{P}{Q}} &= \trproc{P} \fuse \trproc{Q} \\
            \trproc{\fwd} &= \one
    \\
                         \trproc{\selectR{\kay}} &= \atmR{\kay} \\
    \trproc{\caseL[\ell \in L]{\ell => Q_{\ell}}} &= \bigwith_{\ell \in L}\bigl(\atmR{\ell} \limp \trproc{Q_{\ell}}\bigr)
    \\
    \trproc{\caseR[\ell \in L]{\ell => P_{\ell}}} &= \bigwith_{\ell \in L}\bigl(\trproc{P_{\ell}} \pmir \atmL{\ell}\bigr) \\
                         \trproc{\selectL{\kay}} &= \atmL{\kay}
  \end{aligned}
\end{equation*}

\begin{equation*}
  \begin{aligned}
    \trconf{\cnfe} &= \cnfe \\
    \trconf{\cnf_1 \cc \cnf_2} &= \trconf{\cnf_1} \oc \trconf{\cnf_2} \\
    \trconf{P} &= \trproc{P}
  \end{aligned}
\end{equation*}

\begin{theorem}
  If $\cnf \reduces \cnf'$, then $\trconf{\cnf} \Reduces \trconf{\cnf'}$.\alertnote{Weak reduction only because rewriting is unfocused...}
\end{theorem}

\begin{theorem}
  If $\trconf{\cnf} \Reduces \trconf{\cnf'}$, then $\cnf \Reduces \cnf'$.
\end{theorem}

These two theorems do not establish $\trconf{}$ as a (weak) reduction bisimulation\alertnote{Is this the right term?} because the second theorem assumes a reduction to an ordered context that is in the translation's image.
The second theorem is equivalent to 
\begin{theorem}
  If $\trconf{\cnf} = P \Reduces P' = \trconf{\cnf'}$, then $\cnf \Reduces \cnf'$.
\end{theorem}
For the translation to be a (weak) reduction bisimulation, we would need to prove the following, which is false for unfocused rewriting.
\begin{falseclaim}
  If $\trconf{\cnf} = P \Reduces P'$, then $\cnf \Reduces \cnf'$ and $\trconf{\cnf'} = P'$ for some $\cnf'$.
\end{falseclaim}
It is false because of rewritings like $\bigwith_{\ell \in L} (\selectR{\ell} \limp \trproc{Q_{\ell}}) \reduces \selectR{\kay} \limp \trproc{Q_{\kay}}$ for $\kay \in L$.

However, for focused rewriting, the translation (with appropriate shifts added) would be a (strong) reduction bisimulation:
\begin{theorem}
  If $\cnf \reduces \cnf'$, then $\trconf{\cnf} \reduces \trconf{\cnf'}$.
\end{theorem}
%
\begin{theorem}
  If $\trconf{\cnf} \reduces P'$, then $\cnf \reduces \cnf'$ and $\trconf{\cnf'} = P'$ for some $\cnf'$.
\end{theorem}


\section{A session type system for ordered rewriting}

\begin{inferences}
  \infer{\slof{A |- A_1 \fuse A_2 : C}}{
    \slof{A |- A_1 : B} & \slof{B |- A_2 : C}}
  \and
  \infer{\slof{A |- \one : A}}{}
  \\
  \infer{\slof{A_{\kay} |- \selectR{\kay} : \plus*[sub=_{\ell \in L}]{\ell:A_{\ell}}}}{
    \text{($\kay \in L$)}}
  \and
  \infer{\slof{\plus*[sub=_{\ell \in L}]{\ell:A_{\ell}} |- \bigwith_{\ell \in L} (\selectR{\ell} \limp A_{\ell}) : C}}{
    \multipremise{\ell \in L}{\slof{A_{\ell} |- A_{\ell} : C}}}
  \\
  \infer{\slof{A |- \bigwith_{\ell \in L} (A_{\ell} \pmir \selectL{\ell}) : \with*[sub=_{\ell \in L}]{\ell:B_{\ell}}}}{
    \multipremise{\ell \in L}{\slof{A |- A_{\ell} : B_{\ell}}}}
  \and
  \infer{\slof{\with*[sub=_{\ell \in L}]{\ell:B_{\ell}} |- \selectL{\kay} : B_{\kay}}}{
    \text{($\kay \in L$)}}
  \\
  \infer{\slcof{A |- \octx_1 \oc \octx_2 : C}}{
    \slcof{A |- \octx_1 : B} & \slcof{B |- \octx_2 : C}}
  \and
  \infer{\slcof{A |- \octxe : A}}{}
  \and
  \infer{\slcof{A |- A : B}}{
    \slof{A |- A : B}}
\end{inferences}

\footnote{Careful with the 0-ary forms because you could end up with $\slof{\zero |- \top : C}$ and \emph{also} $\slof{A |- \top : \top}$.}

\begin{theorem}
  If $\slof{A |- P : B}$, then $\slof{A |- \trproc{P} : B}$.
  Similarly, if $\slcof{A |- \cnf : B}$, then $\slcof{A |- \trconf{\cnf} : B}$.
\end{theorem}

\begin{theorem}
  If $\slof{A |- A : B}$, then there exists a process $P$ such that $\trproc{P} = A$ and $\slof{A |- P : B}$.
  Similarly, if $\slcof{A |- \octx : B}$, then there exists a configuration $\cnf$ such that $\trconf{\cnf} = \octx$ and $\slcof{A |- \cnf : B}$.
\end{theorem}

\section{Open bisimilarity}

\begin{falseclaim}
  If $\slcof{A |- \cnf \tsim \dnf : B}$, then $\trconf{\cnf} \osim \trconf{\dnf}$.
\end{falseclaim}

Consider $\slcof{\plus*[sub=_{\ell \in L}]{\ell:A_{\ell}} |- \cnf = \cnfe : \plus*[sub=_{\ell \in L}]{\ell:A_{\ell}}}$ and $\slcof{\plus*[sub=_{\ell \in L}]{\ell:A_{\ell}} |- \dnf = \caseL[\ell \in L]{\ell => \selectR{\ell}} : \plus*[sub=_{\ell \in L}]{\ell:A_{\ell}}}$.
We do not have $\octxe \osim \bigwith_{\ell \in L}(\selectR{\ell} \limp \selectR{\ell})$ because of atoms from outside $L$ -- for example, $\selectR{a} \oc \bigwith_{\ell \in L}(\selectR{\ell} \limp \selectR{\ell})$ can not emit $\selectR{a}$ when $a \notin L$.

\begin{conjecture}
  If $\slcof{A |- \cnf : B}$ and $\trconf{\cnf} \osim \octx$, then there exists a configuration $\dnf$ such that $\slcof{A |- \cnf \tsim \dnf : B}$ and $\trconf{\dnf} = \octx$.
\end{conjecture}
\begin{proof}[Proof idea]
  By structural induction on $\cnf$, using the following.
  \begin{quotation}
    If $\slof{A |- P : B}$ and $\trproc{P} \osim \octx$, then there exists a process $Q$ such that $\slof{A |- P \tsim Q : B}$ and $\trproc{Q} \secudeR \octx$.
  \end{quotation}

  Suppose $\slof{A_{\ell} |- P_{\ell} ; B}$ and $\bigwith_{\ell \in L}(\selectR{\ell} \limp \trproc{P_{\ell}}) \osim \octx$; we must exibit a configuation $Q$ such that $\slof{\plus*[sub=_{\ell \in L}]{\ell;A_{\ell}} |- \caseL[\ell \in L]{\ell => P_{\ell}} \tsim Q : B}$ and $\trproc{Q} \secudeR \octx$.
  By input bisimilarity, $\selectR{\ell} \oc \octx \Reduces\miso \trproc{P_{\ell}}$ for all $\ell \in L$.
  By the inductive hypothesis, there exist processes $Q_{\ell}$ such that $\slof{A_{\ell} |- P_{\ell} \tsim Q_{\ell} : B}$ and $\trproc{Q_{\ell}} \secudeR \selectR{\ell} \oc \octx$.
  Is $\slof{\plus*[sub=_{\ell \in L}]{\ell:A_{\ell}} |- \caseL[\ell \in L]{\ell => P_{\ell}} \tsim \caseL[\ell \in L]{\ell => Q_{\ell}} : B}$ true?
  I think so. 
  Is $\trproc{\caseL[\ell \in L]{\ell => Q_{\ell}}} = \bigwith_{\ell \in L}(\selectR{\ell} \limp \trproc{Q_{\ell}}) \secudeR \octx$ true?
\end{proof}


\begin{conjecture}
  If $\slcof{A |- \cnf : B}$ and $\slcof{A |- \dnf : B}$ and $\trconf{\cnf} \osim \trconf{\dnf}$, then $\slcof{A |- \cnf \tsim \dnf : B}$.
\end{conjecture}
\begin{proof}[Proof idea]
  By structural induction on $\cnf$, using the following.
  \begin{quotation}
    If $\slof{A |- P : B}$ and $\slof{A |- Q : B}$ and $\trproc{P} \osim \trproc{Q}$, then $\slof{A |- P \tsim Q : B}$.
  \end{quotation}

  Suppose that $P = \caseL[\ell \in L]{\ell => P_{\ell}}$ and $\slof{A_{\ell} |- P_{\ell} : B}$; we must show that $\slof{\plus*[sub=_{\ell \in L}]{\ell:A_{\ell}} |- \caseL[\ell \in L]{\ell => P_{\ell}} \tsim Q : B}$.
  By input bisimilarity, we have $\selectR{\ell} \oc \trproc{Q} \Reduces \octx_{\ell} \miso \trproc{P_{\ell}}$.
  I'm not sure how to continue from here.
\end{proof}

%%% Local Variables:
%%% mode: latex
%%% TeX-master: "thesis"
%%% End:
